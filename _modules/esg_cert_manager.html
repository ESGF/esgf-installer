

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>esg_cert_manager &mdash; esgf-installer alpha documentation</title>
  

  
  
  
  

  

  
  
    

  

  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> esgf-installer
          

          
          </a>

          
            
            
              <div class="version">
                3.0.0-alpha
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Installation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html#autoinstaller">Autoinstaller</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cert_howto.html">ESGF Certificate Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../usage.html">ESGF Command Line Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cli.html">ESGF CLI</a></li>
</ul>
<p class="caption"><span class="caption-text">API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api.html">Base Components</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api.html#data-node-components">Data Node Components</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api.html#index-node-components">Index Node Components</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api.html#idp-node-components">IDP Node Components</a></li>
</ul>
<p class="caption"><span class="caption-text">Issues</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../issues.html">ESGF Installer Issue Tracking Guidelines</a></li>
</ul>
<p class="caption"><span class="caption-text">Contributing</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../contribute_docs.html">Contributing to Documentation</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">esgf-installer</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Module code</a> &raquo;</li>
        
      <li>esg_cert_manager</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for esg_cert_manager</h1><div class="highlight"><pre>
<span></span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Certificate Management Functions</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">filecmp</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">tarfile</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">errno</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">yaml</span>
<span class="kn">import</span> <span class="nn">jks</span>
<span class="kn">import</span> <span class="nn">OpenSSL</span>
<span class="kn">import</span> <span class="nn">esg_bash2py</span>
<span class="kn">import</span> <span class="nn">esg_functions</span>
<span class="kn">import</span> <span class="nn">esg_property_manager</span>
<span class="kn">from</span> <span class="nn">esg_exceptions</span> <span class="k">import</span> <span class="n">SubprocessError</span>


<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;esgf_logger&quot;</span> <span class="o">+</span><span class="s2">&quot;.&quot;</span><span class="o">+</span> <span class="vm">__name__</span><span class="p">)</span>
<span class="n">current_directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>

<span class="n">NO_LIST</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">,</span> <span class="s2">&quot;no&quot;</span><span class="p">,</span> <span class="s2">&quot;N&quot;</span><span class="p">,</span> <span class="s2">&quot;No&quot;</span><span class="p">,</span> <span class="s2">&quot;NO&quot;</span><span class="p">]</span>
<span class="n">YES_LIST</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;yes&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;Yes&quot;</span><span class="p">,</span> <span class="s2">&quot;YES&quot;</span> <span class="p">]</span>


<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">,</span> <span class="s1">&#39;esg_config.yaml&#39;</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">config_file</span><span class="p">:</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">config_file</span><span class="p">)</span>


<span class="c1">#------------------------------------</span>
<span class="c1">#   Certificate functions</span>
<span class="c1">#------------------------------------</span>

<div class="viewcode-block" id="create_self_signed_cert"><a class="viewcode-back" href="../api.html#esg_cert_manager.create_self_signed_cert">[docs]</a><span class="k">def</span> <span class="nf">create_self_signed_cert</span><span class="p">(</span><span class="n">cert_dir</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    If datacard.crt and datacard.key don&#39;t exist in cert_dir, create a new</span>
<span class="sd">    self-signed cert and keypair and write them into that directory.</span>

<span class="sd">    Source: https://skippylovesmalorie.wordpress.com/2010/02/12/how-to-generate-a-self-signed-certificate-using-pyopenssl/</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">CERT_FILE</span> <span class="o">=</span> <span class="s2">&quot;hostcert.pem&quot;</span>
    <span class="n">KEY_FILE</span> <span class="o">=</span> <span class="s2">&quot;hostkey.pem&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cert_dir</span><span class="p">,</span> <span class="n">CERT_FILE</span><span class="p">))</span> \
            <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cert_dir</span><span class="p">,</span> <span class="n">KEY_FILE</span><span class="p">)):</span>

        <span class="c1"># create a key pair</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">PKey</span><span class="p">()</span>
        <span class="n">k</span><span class="o">.</span><span class="n">generate_key</span><span class="p">(</span><span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">TYPE_RSA</span><span class="p">,</span> <span class="mi">4096</span><span class="p">)</span>

        <span class="c1"># create a self-signed cert</span>
        <span class="n">cert</span> <span class="o">=</span> <span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">X509</span><span class="p">()</span>
        <span class="n">cert</span><span class="o">.</span><span class="n">get_subject</span><span class="p">()</span><span class="o">.</span><span class="n">C</span> <span class="o">=</span> <span class="s2">&quot;US&quot;</span>
        <span class="n">cert</span><span class="o">.</span><span class="n">get_subject</span><span class="p">()</span><span class="o">.</span><span class="n">ST</span> <span class="o">=</span> <span class="s2">&quot;California&quot;</span>
        <span class="n">cert</span><span class="o">.</span><span class="n">get_subject</span><span class="p">()</span><span class="o">.</span><span class="n">L</span> <span class="o">=</span> <span class="s2">&quot;Livermore&quot;</span>
        <span class="n">cert</span><span class="o">.</span><span class="n">get_subject</span><span class="p">()</span><span class="o">.</span><span class="n">O</span> <span class="o">=</span> <span class="s2">&quot;LLNL&quot;</span>
        <span class="n">cert</span><span class="o">.</span><span class="n">get_subject</span><span class="p">()</span><span class="o">.</span><span class="n">OU</span> <span class="o">=</span> <span class="s2">&quot;ESGF&quot;</span>
        <span class="n">cert</span><span class="o">.</span><span class="n">get_subject</span><span class="p">()</span><span class="o">.</span><span class="n">CN</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">()</span>
        <span class="n">cert</span><span class="o">.</span><span class="n">set_serial_number</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
        <span class="n">cert</span><span class="o">.</span><span class="n">gmtime_adj_notBefore</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">cert</span><span class="o">.</span><span class="n">gmtime_adj_notAfter</span><span class="p">(</span><span class="mi">10</span><span class="o">*</span><span class="mi">365</span><span class="o">*</span><span class="mi">24</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
        <span class="n">cert</span><span class="o">.</span><span class="n">set_issuer</span><span class="p">(</span><span class="n">cert</span><span class="o">.</span><span class="n">get_subject</span><span class="p">())</span>
        <span class="n">cert</span><span class="o">.</span><span class="n">set_pubkey</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="n">cert</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="s1">&#39;sha1&#39;</span><span class="p">)</span>

        <span class="n">esg_bash2py</span><span class="o">.</span><span class="n">mkdir_p</span><span class="p">(</span><span class="n">cert_dir</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cert_dir</span><span class="p">,</span> <span class="n">CERT_FILE</span><span class="p">),</span> <span class="s2">&quot;wt&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">cert_file_handle</span><span class="p">:</span>
            <span class="n">cert_file_handle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">dump_certificate</span><span class="p">(</span><span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">FILETYPE_PEM</span><span class="p">,</span> <span class="n">cert</span><span class="p">))</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cert_dir</span><span class="p">,</span> <span class="n">KEY_FILE</span><span class="p">),</span> <span class="s2">&quot;wt&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">key_file_handle</span><span class="p">:</span>
            <span class="n">key_file_handle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">dump_privatekey</span><span class="p">(</span><span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">FILETYPE_PEM</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span></div>

<div class="viewcode-block" id="create_certificate_chain_list"><a class="viewcode-back" href="../api.html#esg_cert_manager.create_certificate_chain_list">[docs]</a><span class="k">def</span> <span class="nf">create_certificate_chain_list</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;Create a list of the certificates that will be a part of the certificate</span>
<span class="sd">        chain file&#39;&#39;&#39;</span>
    <span class="n">default_cachain</span> <span class="o">=</span> <span class="s2">&quot;/etc/esgfcerts/cachain.pem&quot;</span>
    <span class="n">cert_files</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1">#Enter ca_chain file into list</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">esg_property_manager</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s2">&quot;certfile.entry&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">NO_LIST</span><span class="p">:</span>
            <span class="n">certfile_entry</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;Please enter your Certificate Authority&#39;s certificate chain file(s)&quot;</span>
            <span class="nb">print</span> <span class="s2">&quot;[enter each cert file/url press return, press return with blank entry when done]&quot;</span>
            <span class="n">certfile_entry</span> <span class="o">=</span> <span class="n">raw_input</span><span class="p">(</span><span class="s2">&quot;Enter certificate chain file name: &quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">certfile_entry</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">cert_files</span><span class="p">:</span>
                <span class="nb">print</span> <span class="s2">&quot;Adding default certificate chain file </span><span class="si">{default_cachain}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">default_cachain</span><span class="o">=</span><span class="n">default_cachain</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">default_cachain</span><span class="p">):</span>
                    <span class="n">cert_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">default_cachain</span><span class="p">)</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span> <span class="s2">&quot;</span><span class="si">{default_cachain}</span><span class="s2"> does not exist&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">default_cachain</span><span class="o">=</span><span class="n">default_cachain</span><span class="p">)</span>
                    <span class="nb">print</span> <span class="s2">&quot;Creating </span><span class="si">{default_cachain}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">default_cachain</span><span class="o">=</span><span class="n">default_cachain</span><span class="p">)</span>
                    <span class="n">esg_bash2py</span><span class="o">.</span><span class="n">mkdir_p</span><span class="p">(</span><span class="s2">&quot;/etc/esgfcerts&quot;</span><span class="p">)</span>
                    <span class="n">esg_bash2py</span><span class="o">.</span><span class="n">touch</span><span class="p">(</span><span class="n">default_cachain</span><span class="p">)</span>
                    <span class="n">cert_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">default_cachain</span><span class="p">)</span>
                    <span class="k">break</span>
                    <span class="c1"># esg_functions.exit_with_error(1)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">certfile_entry</span><span class="p">):</span>
                <span class="n">cert_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">certfile_entry</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span> <span class="s2">&quot;</span><span class="si">{certfile_entry}</span><span class="s2"> does not exist&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">certfile_entry</span><span class="o">=</span><span class="n">certfile_entry</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">cert_files</span></div>


<div class="viewcode-block" id="create_certificate_chain"><a class="viewcode-back" href="../api.html#esg_cert_manager.create_certificate_chain">[docs]</a><span class="k">def</span> <span class="nf">create_certificate_chain</span><span class="p">(</span><span class="n">cert_files</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Concatenate the certificates in the chain and copy them to /etc/certs&#39;&#39;&#39;</span>
    <span class="nb">print</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">*******************************&quot;</span>
    <span class="nb">print</span> <span class="s2">&quot;Creating Certificate Chain&quot;</span>
    <span class="nb">print</span> <span class="s2">&quot;******************************* </span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="c1">#Copy the tmpchain and rename to cachain</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;/etc/certs/tmpchain&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">tmpchain_file</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">cert</span> <span class="ow">in</span> <span class="n">cert_files</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">cert</span><span class="p">):</span>
                <span class="nb">print</span> <span class="s2">&quot;</span><span class="si">{cert}</span><span class="s2"> not found. Exiting.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cert</span><span class="o">=</span><span class="n">cert</span><span class="p">)</span>
                <span class="n">esg_functions</span><span class="o">.</span><span class="n">exit_with_error</span><span class="p">()</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">cert</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">cert_file_handle</span><span class="p">:</span>
                <span class="n">cert_file_contents</span> <span class="o">=</span> <span class="n">cert_file_handle</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">tmpchain_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">cert_file_contents</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="s2">&quot;/etc/certs/tmpchain&quot;</span><span class="p">,</span> <span class="s2">&quot;/etc/certs/cachain.pem&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="fetch_esgf_certificates"><a class="viewcode-back" href="../api.html#esg_cert_manager.fetch_esgf_certificates">[docs]</a><span class="k">def</span> <span class="nf">fetch_esgf_certificates</span><span class="p">(</span><span class="n">globus_certs_dir</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;globus_global_certs_dir&quot;</span><span class="p">]):</span>
    <span class="sd">&#39;&#39;&#39;Goes to ESG distribution server and pulls down all certificates for the federation.</span>
<span class="sd">    (suitable for crontabbing)&#39;&#39;&#39;</span>

    <span class="nb">print</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">*******************************&quot;</span>
    <span class="nb">print</span> <span class="s2">&quot;Fetching freshest ESG Federation Certificates...&quot;</span>
    <span class="nb">print</span> <span class="s2">&quot;******************************* </span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="c1">#if globus_global_certs_dir already exists, backup and delete, then recreate empty directory</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;globus_global_certs_dir&quot;</span><span class="p">]):</span>
        <span class="n">esg_functions</span><span class="o">.</span><span class="n">backup</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;globus_global_certs_dir&quot;</span><span class="p">],</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;globus_global_certs_dir&quot;</span><span class="p">],</span> <span class="s2">&quot;.bak.tz&quot;</span><span class="p">))</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;globus_global_certs_dir&quot;</span><span class="p">])</span>
    <span class="n">esg_bash2py</span><span class="o">.</span><span class="n">mkdir_p</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;globus_global_certs_dir&quot;</span><span class="p">])</span>

    <span class="c1">#Download trusted certs tarball</span>
    <span class="n">esg_trusted_certs_file</span> <span class="o">=</span> <span class="s2">&quot;esg_trusted_certificates.tar&quot;</span>
    <span class="n">esg_trusted_certs_file_url</span> <span class="o">=</span> <span class="s2">&quot;https://aims1.llnl.gov/esgf/dist/certs/</span><span class="si">{esg_trusted_certs_file}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">esg_trusted_certs_file</span><span class="o">=</span><span class="n">esg_trusted_certs_file</span><span class="p">)</span>
    <span class="n">esg_functions</span><span class="o">.</span><span class="n">download_update</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">globus_certs_dir</span><span class="p">,</span><span class="n">esg_trusted_certs_file</span><span class="p">),</span> <span class="n">esg_trusted_certs_file_url</span><span class="p">)</span>

    <span class="c1">#untar the esg_trusted_certs_file</span>
    <span class="n">esg_functions</span><span class="o">.</span><span class="n">extract_tarball</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">globus_certs_dir</span><span class="p">,</span><span class="n">esg_trusted_certs_file</span><span class="p">),</span> <span class="n">globus_certs_dir</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">globus_certs_dir</span><span class="p">,</span><span class="n">esg_trusted_certs_file</span><span class="p">))</span>

    <span class="c1">#certificate_issuer_cert &quot;/var/lib/globus-connect-server/myproxy-ca/cacert.pem&quot;</span>
    <span class="n">simpleCA_cert</span> <span class="o">=</span> <span class="s2">&quot;/var/lib/globus-connect-server/myproxy-ca/cacert.pem&quot;</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">simpleCA_cert</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cert_obj</span> <span class="o">=</span> <span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">load_certificate</span><span class="p">(</span><span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">FILETYPE_PEM</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">simpleCA_cert</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="k">except</span> <span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">Error</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Certificate is not correct.&quot;</span><span class="p">)</span>

        <span class="n">simpleCA_cert_hash</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">cert_obj</span><span class="o">.</span><span class="n">subject_name_hash</span><span class="p">())</span>
        <span class="nb">print</span> <span class="s2">&quot;checking for MY cert: </span><span class="si">{globus_global_certs_dir}</span><span class="s2">/</span><span class="si">{simpleCA_cert_hash}</span><span class="s2">.0&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">globus_global_certs_dir</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;globus_global_certs_dir&quot;</span><span class="p">],</span> <span class="n">simpleCA_cert_hash</span><span class="o">=</span><span class="n">simpleCA_cert_hash</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{globus_global_certs_dir}</span><span class="s2">/</span><span class="si">{simpleCA_cert_hash}</span><span class="s2">.0&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">globus_global_certs_dir</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;globus_global_certs_dir&quot;</span><span class="p">],</span> <span class="n">simpleCA_cert_hash</span><span class="o">=</span><span class="n">simpleCA_cert_hash</span><span class="p">)):</span>
            <span class="nb">print</span> <span class="s2">&quot;Local CA cert file detected....&quot;</span>
            <span class="nb">print</span> <span class="s2">&quot;Integrating in local simpleCA_cert... &quot;</span>
            <span class="nb">print</span> <span class="s2">&quot;Local SimpleCA Root Cert: </span><span class="si">{simpleCA_cert}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">simpleCA_cert</span><span class="o">=</span><span class="n">simpleCA_cert</span><span class="p">)</span>
            <span class="nb">print</span> <span class="s2">&quot;Extracting Signing policy&quot;</span>

            <span class="c1">#Copy simple CA cert to globus cert directory</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">simpleCA_cert</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{globus_global_certs_dir}</span><span class="s2">/</span><span class="si">{simpleCA_cert_hash}</span><span class="s2">.0&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">globus_global_certs_dir</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;globus_global_certs_dir&quot;</span><span class="p">],</span> <span class="n">simpleCA_cert_hash</span><span class="o">=</span><span class="n">simpleCA_cert_hash</span><span class="p">))</span>

            <span class="c1">#extract simple CA cert tarball and copy to globus cert directory</span>
            <span class="n">simpleCA_cert_parent_dir</span> <span class="o">=</span> <span class="n">esg_functions</span><span class="o">.</span><span class="n">get_parent_directory</span><span class="p">(</span><span class="n">simpleCA_cert</span><span class="p">)</span>
            <span class="n">simpleCA_setup_tar_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">simpleCA_cert_parent_dir</span><span class="p">,</span> <span class="s2">&quot;globus_simple_ca_</span><span class="si">{simpleCA_cert_hash}</span><span class="s2">_setup-0.tar.gz&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">simpleCA_cert_hash</span><span class="o">=</span><span class="n">simpleCA_cert_hash</span><span class="p">))</span>
            <span class="n">esg_functions</span><span class="o">.</span><span class="n">extract_tarball</span><span class="p">(</span><span class="n">simpleCA_setup_tar_file</span><span class="p">)</span>

            <span class="k">with</span> <span class="n">esg_bash2py</span><span class="o">.</span><span class="n">pushd</span><span class="p">(</span><span class="s2">&quot;globus_simple_ca_</span><span class="si">{simpleCA_cert_hash}</span><span class="s2">_setup-0&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">simpleCA_cert_hash</span><span class="o">=</span><span class="n">simpleCA_cert_hash</span><span class="p">)):</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{simpleCA_cert_hash}</span><span class="s2">.signing_policy&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">simpleCA_cert_hash</span><span class="o">=</span><span class="n">simpleCA_cert_hash</span><span class="p">),</span> <span class="s2">&quot;</span><span class="si">{globus_global_certs_dir}</span><span class="s2">/</span><span class="si">{simpleCA_cert_hash}</span><span class="s2">.signing_policy&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">globus_global_certs_dir</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;globus_global_certs_dir&quot;</span><span class="p">],</span> <span class="n">simpleCA_cert_hash</span><span class="o">=</span><span class="n">simpleCA_cert_hash</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="s2">&quot;/usr/local/tomcat/webapps/ROOT&quot;</span><span class="p">):</span>
                <span class="n">esg_functions</span><span class="o">.</span><span class="n">stream_subprocess_output</span><span class="p">(</span><span class="s2">&quot;openssl x509 -text -hash -in </span><span class="si">{simpleCA_cert}</span><span class="s2"> &gt; </span><span class="si">{tomcat_install_dir}</span><span class="s2">/webapps/ROOT/cacert.pem&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">simpleCA_cert</span><span class="o">=</span><span class="n">simpleCA_cert</span><span class="p">,</span> <span class="n">tomcat_install_dir</span><span class="o">=</span><span class="s2">&quot;/usr/loca/tomcat&quot;</span><span class="p">))</span>
                <span class="nb">print</span> <span class="s2">&quot; My CA Cert now posted @ http://</span><span class="si">{fqdn}</span><span class="s2">/cacert.pem &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fqdn</span><span class="o">=</span><span class="n">socket</span><span class="o">.</span><span class="n">getfqdn</span><span class="p">())</span>
                <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="s2">&quot;/usr/local/tomcat/webapps/ROOT/cacert.pem&quot;</span><span class="p">,</span> <span class="mi">0644</span><span class="p">)</span>

        <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;globus_global_certs_dir&quot;</span><span class="p">],</span> <span class="mi">0755</span><span class="p">)</span>
        <span class="n">esg_functions</span><span class="o">.</span><span class="n">change_permissions_recursive</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;globus_global_certs_dir&quot;</span><span class="p">],</span> <span class="mi">0644</span><span class="p">)</span></div>

<div class="viewcode-block" id="install_extkeytool"><a class="viewcode-back" href="../api.html#esg_cert_manager.install_extkeytool">[docs]</a><span class="k">def</span> <span class="nf">install_extkeytool</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;Install the Extkeytool from the distribution mirror&#39;&#39;&#39;</span>
    <span class="nb">print</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">*******************************&quot;</span>
    <span class="nb">print</span> <span class="s2">&quot;Installing Extkeytool&quot;</span>
    <span class="nb">print</span> <span class="s2">&quot;******************************* </span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">extkeytool_tarfile</span> <span class="o">=</span> <span class="n">esg_bash2py</span><span class="o">.</span><span class="n">trim_string_from_head</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;extkeytool_download_url&quot;</span><span class="p">])</span>
    <span class="n">esg_functions</span><span class="o">.</span><span class="n">download_update</span><span class="p">(</span><span class="n">extkeytool_tarfile</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;extkeytool_download_url&quot;</span><span class="p">])</span>
    <span class="n">esg_functions</span><span class="o">.</span><span class="n">extract_tarball</span><span class="p">(</span><span class="n">extkeytool_tarfile</span><span class="p">,</span> <span class="s2">&quot;/esg/tools/idptools&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="convert_per_to_dem"><a class="viewcode-back" href="../api.html#esg_cert_manager.convert_per_to_dem">[docs]</a><span class="k">def</span> <span class="nf">convert_per_to_dem</span><span class="p">(</span><span class="n">private_key</span><span class="p">,</span> <span class="n">key_output_dir</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Convert your private key into from PEM to DER format that java likes&#39;&#39;&#39;</span>
    <span class="nb">print</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">*******************************&quot;</span>
    <span class="nb">print</span> <span class="s2">&quot;converting private key from PEM to DER... &quot;</span>
    <span class="nb">print</span> <span class="s2">&quot;******************************* </span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">derkey</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">key_output_dir</span><span class="p">,</span><span class="s2">&quot;key.der&quot;</span><span class="p">)</span>
    <span class="n">convert_to_der</span> <span class="o">=</span> <span class="n">esg_functions</span><span class="o">.</span><span class="n">call_subprocess</span><span class="p">(</span><span class="s2">&quot;openssl pkcs8 -topk8 -nocrypt -inform PEM -in </span><span class="si">{private_key}</span><span class="s2"> -outform DER -out </span><span class="si">{derkey}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">private_key</span><span class="o">=</span><span class="n">private_key</span><span class="p">,</span> <span class="n">derkey</span><span class="o">=</span><span class="n">derkey</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">convert_to_der</span><span class="p">[</span><span class="s2">&quot;returncode&quot;</span><span class="p">]</span> <span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s2">&quot;Problem with preparing initial keystore...Exiting.&quot;</span>
        <span class="n">esg_functions</span><span class="o">.</span><span class="n">exit_with_error</span><span class="p">(</span><span class="n">convert_to_der</span><span class="p">[</span><span class="s2">&quot;stderr&quot;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">derkey</span></div>

<div class="viewcode-block" id="check_cachain_validity"><a class="viewcode-back" href="../api.html#esg_cert_manager.check_cachain_validity">[docs]</a><span class="k">def</span> <span class="nf">check_cachain_validity</span><span class="p">(</span><span class="n">ca_chain_bundle</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Verify that the CA chain is valid&#39;&#39;&#39;</span>
    <span class="nb">print</span> <span class="s2">&quot;checking that chain is valid... &quot;</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">ca_chain_bundle</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">valid_chain</span> <span class="o">=</span> <span class="n">esg_functions</span><span class="o">.</span><span class="n">call_subprocess</span><span class="p">(</span><span class="s2">&quot;openssl verify -CAfile </span><span class="si">{ca_chain_bundle}</span><span class="s2"> </span><span class="si">{ca_chain_bundle}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ca_chain_bundle</span><span class="o">=</span><span class="n">ca_chain_bundle</span><span class="p">))</span>
            <span class="k">if</span> <span class="s2">&quot;error&quot;</span> <span class="ow">in</span> <span class="n">valid_chain</span><span class="p">[</span><span class="s1">&#39;stdout&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="s2">&quot;error&quot;</span> <span class="ow">in</span> <span class="n">valid_chain</span><span class="p">[</span><span class="s1">&#39;stderr&#39;</span><span class="p">]:</span>
                <span class="nb">print</span> <span class="s2">&quot;The chain is not valid.  (hint: did you include the root cert for the chain?)&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span> <span class="s2">&quot;</span><span class="si">{ca_chain_bundle}</span><span class="s2"> is valid.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ca_chain_bundle</span><span class="o">=</span><span class="n">ca_chain_bundle</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">SubprocessError</span><span class="p">,</span> <span class="n">error</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;Error verifying cachain:&quot;</span><span class="p">,</span> <span class="n">error</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s2">&quot;Hmmm... no chain provided [</span><span class="si">{ca_chain_bundle}</span><span class="s2">], skipping this check...&quot;</span></div>


<div class="viewcode-block" id="bundle_certificates"><a class="viewcode-back" href="../api.html#esg_cert_manager.bundle_certificates">[docs]</a><span class="k">def</span> <span class="nf">bundle_certificates</span><span class="p">(</span><span class="n">public_cert</span><span class="p">,</span> <span class="n">ca_chain</span><span class="p">,</span> <span class="n">idptools_install_dir</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Create certificate bundle from public cert and cachain&#39;&#39;&#39;</span>
    <span class="nb">print</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">*******************************&quot;</span>
    <span class="nb">print</span> <span class="s2">&quot;Bundling Certificates&quot;</span>
    <span class="nb">print</span> <span class="s2">&quot;******************************* </span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="n">cert_bundle</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">idptools_install_dir</span><span class="p">,</span> <span class="s2">&quot;cert.bundle&quot;</span><span class="p">)</span>
    <span class="n">ca_chain_bundle</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">idptools_install_dir</span><span class="p">,</span> <span class="s2">&quot;ca_chain.bundle&quot;</span><span class="p">)</span>

    <span class="nb">print</span> <span class="s2">&quot;public_cert:&quot;</span><span class="p">,</span> <span class="n">public_cert</span>
    <span class="nb">print</span> <span class="s2">&quot;ca_chain:&quot;</span><span class="p">,</span> <span class="n">ca_chain</span>

    <span class="c1">#Write public_cert to bundle first</span>
    <span class="nb">print</span> <span class="s2">&quot;Signed Cert -----&gt; &quot;</span><span class="p">,</span> <span class="n">public_cert</span>
    <span class="k">if</span> <span class="s2">&quot;http&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">public_cert</span><span class="p">:</span>
        <span class="c1">#Write contents of cert to cert_bundle_file</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">public_cert</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">cert_data</span><span class="p">:</span>
            <span class="n">cert_contents</span> <span class="o">=</span> <span class="n">cert_data</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">cert_bundle</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">cert_bundle_file</span><span class="p">:</span>
            <span class="n">cert_bundle_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">cert_contents</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1">#Make request for public_cert, then write public_cert contents to cert_bundle_file</span>
        <span class="n">cert_contents</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">public_cert</span><span class="p">)</span><span class="o">.</span><span class="n">content</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">cert_bundle</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">cert_bundle_file</span><span class="p">:</span>
            <span class="n">cert_bundle_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">cert_contents</span><span class="p">)</span>

    <span class="n">num_of_certs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ca_chain</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">num_of_certs</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">cert</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ca_chain</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="n">num_of_certs</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="nb">print</span> <span class="s2">&quot;Root Cert -------&gt; &quot;</span><span class="p">,</span> <span class="n">cert</span>
                <span class="k">if</span> <span class="s2">&quot;http&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cert</span><span class="p">:</span>
                    <span class="c1">#Write contents of cert to cert_bundle_file and ca_chain_bundle</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">cert</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">cert_data</span><span class="p">:</span>
                        <span class="n">cert_contents</span> <span class="o">=</span> <span class="n">cert_data</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">cert_bundle</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">cert_bundle_file</span><span class="p">:</span>
                        <span class="n">cert_bundle_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">cert_contents</span><span class="p">)</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">ca_chain_bundle</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ca_chain_bundle_file</span><span class="p">:</span>
                        <span class="n">ca_chain_bundle_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">cert_contents</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cert_contents</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cert</span><span class="p">)</span><span class="o">.</span><span class="n">content</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">cert_bundle</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">cert_bundle_file</span><span class="p">:</span>
                        <span class="n">cert_bundle_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">cert_contents</span><span class="p">)</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">ca_chain_bundle</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ca_chain_bundle_file</span><span class="p">:</span>
                        <span class="n">ca_chain_bundle_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">cert_contents</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span> <span class="s2">&quot;Intermediate cert #</span><span class="si">{index}</span><span class="s2"> ----&gt; </span><span class="si">{cert}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span> <span class="n">cert</span><span class="o">=</span><span class="n">cert</span><span class="p">)</span>
                <span class="k">if</span> <span class="s2">&quot;http&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cert</span><span class="p">:</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">cert</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">cert_data</span><span class="p">:</span>
                        <span class="n">cert_contents</span> <span class="o">=</span> <span class="n">cert_data</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">cert_bundle</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">cert_bundle_file</span><span class="p">:</span>
                        <span class="n">cert_bundle_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">cert_contents</span><span class="p">)</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">ca_chain_bundle</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ca_chain_bundle_file</span><span class="p">:</span>
                        <span class="n">ca_chain_bundle_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">cert_contents</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cert_contents</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cert</span><span class="p">)</span><span class="o">.</span><span class="n">content</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">cert_bundle</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">cert_bundle_file</span><span class="p">:</span>
                        <span class="n">cert_bundle_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">cert_contents</span><span class="p">)</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">ca_chain_bundle</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ca_chain_bundle_file</span><span class="p">:</span>
                        <span class="n">ca_chain_bundle_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">cert_contents</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">cert_bundle</span><span class="p">,</span> <span class="n">ca_chain_bundle</span></div>


<div class="viewcode-block" id="copy_cert_to_tomcat_conf"><a class="viewcode-back" href="../api.html#esg_cert_manager.copy_cert_to_tomcat_conf">[docs]</a><span class="k">def</span> <span class="nf">copy_cert_to_tomcat_conf</span><span class="p">(</span><span class="n">public_cert</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Copy the signed cert to the ESGF Tomcat config directory (i.e. /esg/config/tomcat)&#39;&#39;&#39;</span>
    <span class="c1">#Check for newer version of public_cert; if found backup old cert</span>
    <span class="n">esgf_cert_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;tomcat_conf_dir&quot;</span><span class="p">],</span> <span class="s2">&quot;</span><span class="si">{esgf_host}</span><span class="s2">-esg-node.pem&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">esgf_host</span><span class="o">=</span><span class="n">esg_functions</span><span class="o">.</span><span class="n">get_esgf_host</span><span class="p">()))</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getctime</span><span class="p">(</span><span class="n">public_cert</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getctime</span><span class="p">(</span><span class="n">esgf_cert_name</span><span class="p">):</span>
            <span class="n">backed_up_cert_name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{esgf_cert_name}</span><span class="s2">_</span><span class="si">{date}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">esgf_cert_name</span><span class="o">=</span><span class="n">esgf_cert_name</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()))</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">esgf_cert_name</span><span class="p">,</span> <span class="n">backed_up_cert_name</span><span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">public_cert</span><span class="p">,</span> <span class="n">esgf_cert_name</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Error while copying public cert&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">OSError</span><span class="p">,</span> <span class="n">error</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">error</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">ENOENT</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Existing cert </span><span class="si">%s</span><span class="s2"> not found.  Copying public cert to Tomcat config directory: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">esgf_cert_name</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;tomcat_conf_dir&quot;</span><span class="p">])</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">public_cert</span><span class="p">,</span> <span class="n">esgf_cert_name</span><span class="p">)</span></div>


<span class="c1">#------------------------------------</span>
<span class="c1">#   Keystore functions</span>
<span class="c1">#------------------------------------</span>

<div class="viewcode-block" id="generate_tomcat_keystore"><a class="viewcode-back" href="../api.html#esg_cert_manager.generate_tomcat_keystore">[docs]</a><span class="k">def</span> <span class="nf">generate_tomcat_keystore</span><span class="p">(</span><span class="n">keystore_name</span><span class="p">,</span> <span class="n">keystore_alias</span><span class="p">,</span> <span class="n">private_key</span><span class="p">,</span> <span class="n">public_cert</span><span class="p">,</span> <span class="n">intermediate_certs</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;The following helper function creates a new keystore for your tomcat installation&#39;&#39;&#39;</span>

    <span class="n">provider</span> <span class="o">=</span> <span class="s2">&quot;org.bouncycastle.jce.provider.BouncyCastleProvider&quot;</span>
    <span class="n">idptools_install_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;esg_tools_dir&quot;</span><span class="p">],</span> <span class="s2">&quot;idptools&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">intermediate_certs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s2">&quot;No intermediate_certs files given&quot;</span>
        <span class="n">esg_functions</span><span class="o">.</span><span class="n">exit_with_error</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">private_key</span><span class="p">):</span>
        <span class="nb">print</span> <span class="s2">&quot;Private key file </span><span class="si">{private_key}</span><span class="s2"> does not exist&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">private_key</span><span class="o">=</span><span class="n">private_key</span><span class="p">)</span>

    <span class="n">keystore_password</span> <span class="o">=</span> <span class="n">esg_functions</span><span class="o">.</span><span class="n">get_java_keystore_password</span><span class="p">()</span>

    <span class="c1">#-------------</span>
    <span class="c1">#Display values</span>
    <span class="c1">#-------------</span>
    <span class="nb">print</span> <span class="s2">&quot;Keystore name : </span><span class="si">{keystore_name}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">keystore_name</span><span class="o">=</span><span class="n">keystore_name</span><span class="p">)</span>
    <span class="nb">print</span> <span class="s2">&quot;Keystore alias: </span><span class="si">{keystore_alias}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">keystore_alias</span><span class="o">=</span><span class="n">keystore_alias</span><span class="p">)</span>
    <span class="nb">print</span> <span class="s2">&quot;Keystore password: </span><span class="si">{keystore_password}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">keystore_password</span><span class="o">=</span><span class="n">keystore_password</span><span class="p">)</span>
    <span class="nb">print</span> <span class="s2">&quot;Private key   : </span><span class="si">{private_key}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">private_key</span><span class="o">=</span><span class="n">private_key</span><span class="p">)</span>
    <span class="nb">print</span> <span class="s2">&quot;Public cert  : </span><span class="si">{public_cert}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">public_cert</span><span class="o">=</span><span class="n">public_cert</span><span class="p">)</span>
    <span class="nb">print</span> <span class="s2">&quot;Certificates...&quot;</span>

    <span class="n">esg_bash2py</span><span class="o">.</span><span class="n">mkdir_p</span><span class="p">(</span><span class="n">idptools_install_dir</span><span class="p">)</span>

    <span class="n">cert_bundle</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">idptools_install_dir</span><span class="p">,</span> <span class="s2">&quot;cert.bundle&quot;</span><span class="p">)</span>
    <span class="n">ca_chain_bundle</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">idptools_install_dir</span><span class="p">,</span> <span class="s2">&quot;ca_chain.bundle&quot;</span><span class="p">)</span>

    <span class="n">cert_bundle</span><span class="p">,</span> <span class="n">ca_chain_bundle</span> <span class="o">=</span> <span class="n">bundle_certificates</span><span class="p">(</span><span class="n">public_cert</span><span class="p">,</span> <span class="n">intermediate_certs</span><span class="p">,</span> <span class="n">idptools_install_dir</span><span class="p">)</span>

    <span class="nb">print</span> <span class="s2">&quot;checking that key pair is congruent... &quot;</span>
    <span class="k">if</span> <span class="n">check_associate_cert_with_private_key</span><span class="p">(</span><span class="n">public_cert</span><span class="p">,</span> <span class="n">private_key</span><span class="p">):</span>
        <span class="nb">print</span> <span class="s2">&quot;The keypair was congruent&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s2">&quot;The keypair was not congruent&quot;</span>
        <span class="n">esg_functions</span><span class="o">.</span><span class="n">exit_with_error</span><span class="p">()</span>


    <span class="nb">print</span> <span class="s2">&quot;creating keystore... &quot;</span>
    <span class="c1">#create a keystore with a self-signed cert</span>
    <span class="n">distinguished_name</span> <span class="o">=</span> <span class="s2">&quot;CN=</span><span class="si">{esgf_host}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">esgf_host</span><span class="o">=</span><span class="n">esg_functions</span><span class="o">.</span><span class="n">get_esgf_host</span><span class="p">())</span>

    <span class="c1">#if previous keystore is found; backup</span>
    <span class="n">backup_previous_keystore</span><span class="p">(</span><span class="n">keystore_name</span><span class="p">)</span>

    <span class="c1">#-------------</span>
    <span class="c1">#Make empty keystore...</span>
    <span class="c1">#-------------</span>
    <span class="n">create_empty_java_keystore</span><span class="p">(</span><span class="n">keystore_name</span><span class="p">,</span> <span class="n">keystore_alias</span><span class="p">,</span> <span class="n">keystore_password</span><span class="p">,</span> <span class="n">distinguished_name</span><span class="p">)</span>

    <span class="c1">#-------------</span>
    <span class="c1">#Convert your private key into from PEM to DER format that java likes</span>
    <span class="c1">#-------------</span>
    <span class="n">derkey</span> <span class="o">=</span> <span class="n">convert_per_to_dem</span><span class="p">(</span><span class="n">private_key</span><span class="p">,</span> <span class="n">idptools_install_dir</span><span class="p">)</span>

    <span class="c1">#-------------</span>
    <span class="c1">#Now we gather up all the other keys in the key chain...</span>
    <span class="c1">#-------------</span>
    <span class="n">check_cachain_validity</span><span class="p">(</span><span class="n">ca_chain_bundle</span><span class="p">)</span>

    <span class="nb">print</span> <span class="s2">&quot;Constructing new keystore content... &quot;</span>
    <span class="n">import_cert_into_keystore</span><span class="p">(</span><span class="n">keystore_name</span><span class="p">,</span> <span class="n">keystore_alias</span><span class="p">,</span> <span class="n">keystore_password</span><span class="p">,</span> <span class="n">derkey</span><span class="p">,</span> <span class="n">cert_bundle</span><span class="p">,</span> <span class="n">provider</span><span class="p">)</span>

    <span class="c1">#Check keystore output</span>
    <span class="n">java_keytool_executable</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{java_install_dir}</span><span class="s2">/bin/keytool&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">java_install_dir</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;java_install_dir&quot;</span><span class="p">])</span>
    <span class="c1">#TODO: Look at using pyjks to list Owner, Issuer, MD5, SHA1, and Serial Number</span>
    <span class="n">check_keystore_command</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{java_keytool_executable}</span><span class="s2"> -v -list -keystore </span><span class="si">{keystore_name}</span><span class="s2"> -storepass </span><span class="si">{store_password}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">java_keytool_executable</span><span class="o">=</span><span class="n">java_keytool_executable</span><span class="p">,</span> <span class="n">keystore_name</span><span class="o">=</span><span class="n">keystore_name</span><span class="p">,</span> <span class="n">store_password</span><span class="o">=</span><span class="n">keystore_password</span><span class="p">)</span>
    <span class="nb">print</span> <span class="s2">&quot;check_keystore_command:&quot;</span><span class="p">,</span> <span class="n">check_keystore_command</span>
    <span class="n">keystore_output</span> <span class="o">=</span> <span class="n">esg_functions</span><span class="o">.</span><span class="n">call_subprocess</span><span class="p">(</span><span class="n">check_keystore_command</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">keystore_output</span><span class="p">[</span><span class="s2">&quot;returncode&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s2">&quot;Mmmm, freshly baked keystore!&quot;</span>
        <span class="nb">print</span> <span class="s2">&quot;If Everything looks good... then replace your current tomcat keystore with </span><span class="si">{keystore_name}</span><span class="s2">, if necessary.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">keystore_name</span><span class="o">=</span><span class="n">keystore_name</span><span class="p">)</span>
        <span class="nb">print</span> <span class="s2">&quot;Don&#39;t forget to change your tomcat&#39;s server.xml entry accordingly :-)&quot;</span>
        <span class="nb">print</span> <span class="s2">&quot;Remember: Keep your private key </span><span class="si">{private_key}</span><span class="s2"> and signed cert </span><span class="si">{public_cert}</span><span class="s2"> in a safe place!!!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">private_key</span><span class="o">=</span><span class="n">private_key</span><span class="p">,</span> <span class="n">public_cert</span><span class="o">=</span><span class="n">public_cert</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s2">&quot;Failed to check keystore&quot;</span>
        <span class="n">esg_functions</span><span class="o">.</span><span class="n">exit_with_error</span><span class="p">(</span><span class="n">keystore_output</span><span class="p">[</span><span class="s2">&quot;stderr&quot;</span><span class="p">])</span></div>

<div class="viewcode-block" id="check_associate_cert_with_private_key"><a class="viewcode-back" href="../api.html#esg_cert_manager.check_associate_cert_with_private_key">[docs]</a><span class="k">def</span> <span class="nf">check_associate_cert_with_private_key</span><span class="p">(</span><span class="n">cert</span><span class="p">,</span> <span class="n">private_key</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :type cert: str</span>
<span class="sd">    :type private_key: str</span>
<span class="sd">    :rtype: bool</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">private_key</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">private_key_file</span><span class="p">:</span>
        <span class="n">private_key_contents</span> <span class="o">=</span> <span class="n">private_key_file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">private_key_obj</span> <span class="o">=</span> <span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">load_privatekey</span><span class="p">(</span><span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">FILETYPE_PEM</span><span class="p">,</span> <span class="n">private_key_contents</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">Error</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Private key is not correct.&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">cert_obj</span> <span class="o">=</span> <span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">load_certificate</span><span class="p">(</span><span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">FILETYPE_PEM</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">cert</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    <span class="k">except</span> <span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">Error</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Certificate is not correct.&quot;</span><span class="p">)</span>

    <span class="n">context</span> <span class="o">=</span> <span class="n">OpenSSL</span><span class="o">.</span><span class="n">SSL</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span><span class="n">OpenSSL</span><span class="o">.</span><span class="n">SSL</span><span class="o">.</span><span class="n">TLSv1_METHOD</span><span class="p">)</span>
    <span class="n">context</span><span class="o">.</span><span class="n">use_privatekey</span><span class="p">(</span><span class="n">private_key_obj</span><span class="p">)</span>
    <span class="n">context</span><span class="o">.</span><span class="n">use_certificate</span><span class="p">(</span><span class="n">cert_obj</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">context</span><span class="o">.</span><span class="n">check_privatekey</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="n">OpenSSL</span><span class="o">.</span><span class="n">SSL</span><span class="o">.</span><span class="n">Error</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="check_keystore"><a class="viewcode-back" href="../api.html#esg_cert_manager.check_keystore">[docs]</a><span class="k">def</span> <span class="nf">check_keystore</span><span class="p">(</span><span class="n">keystore_name</span><span class="p">,</span> <span class="n">keystore_password</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Check the contents of a given keystore or truststore&#39;&#39;&#39;</span>

    <span class="n">keystore</span> <span class="o">=</span> <span class="n">jks</span><span class="o">.</span><span class="n">KeyStore</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">keystore_name</span><span class="p">,</span> <span class="n">keystore_password</span><span class="p">)</span>
    <span class="nb">print</span> <span class="s2">&quot;keystore:&quot;</span><span class="p">,</span> <span class="n">keystore</span>
    <span class="k">return</span> <span class="n">keystore</span></div>


<div class="viewcode-block" id="create_empty_java_keystore"><a class="viewcode-back" href="../api.html#esg_cert_manager.create_empty_java_keystore">[docs]</a><span class="k">def</span> <span class="nf">create_empty_java_keystore</span><span class="p">(</span><span class="n">keystore_name</span><span class="p">,</span> <span class="n">keystore_alias</span><span class="p">,</span> <span class="n">keystore_password</span><span class="p">,</span> <span class="n">distinguished_name</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Create a new empty Java Keystore using the JDK&#39;s keytool&#39;&#39;&#39;</span>
    <span class="n">java_keytool_executable</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{java_install_dir}</span><span class="s2">/bin/keytool&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">java_install_dir</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;java_install_dir&quot;</span><span class="p">])</span>
    <span class="n">generate_keystore_string</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{java_keytool_executable}</span><span class="s2"> -genkey -keyalg RSA -alias </span><span class="si">{keystore_alias}</span><span class="s2"> -keystore </span><span class="si">{keystore_name}</span><span class="s2"> -storepass </span><span class="si">{keystore_password}</span><span class="s2"> -keypass </span><span class="si">{keystore_password}</span><span class="s2"> -validity 360 -dname </span><span class="si">{distinguished_name}</span><span class="s2"> -noprompt&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">java_keytool_executable</span><span class="o">=</span><span class="n">java_keytool_executable</span><span class="p">,</span> <span class="n">keystore_alias</span><span class="o">=</span><span class="n">keystore_alias</span><span class="p">,</span> <span class="n">keystore_name</span><span class="o">=</span><span class="n">keystore_name</span><span class="p">,</span> <span class="n">keystore_password</span><span class="o">=</span><span class="n">keystore_password</span><span class="p">,</span> <span class="n">distinguished_name</span><span class="o">=</span><span class="n">distinguished_name</span><span class="p">)</span>
    <span class="n">keystore_output</span> <span class="o">=</span> <span class="n">esg_functions</span><span class="o">.</span><span class="n">call_subprocess</span><span class="p">(</span><span class="n">generate_keystore_string</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">keystore_output</span><span class="p">[</span><span class="s2">&quot;returncode&quot;</span><span class="p">]</span> <span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s2">&quot;Problem with generating initial keystore...Exiting.&quot;</span>
        <span class="n">esg_functions</span><span class="o">.</span><span class="n">exit_with_error</span><span class="p">(</span><span class="n">keystore_output</span><span class="p">[</span><span class="s2">&quot;stderr&quot;</span><span class="p">])</span></div>


<div class="viewcode-block" id="backup_previous_keystore"><a class="viewcode-back" href="../api.html#esg_cert_manager.backup_previous_keystore">[docs]</a><span class="k">def</span> <span class="nf">backup_previous_keystore</span><span class="p">(</span><span class="n">keystore_name</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;If a previous keystore exists, back it up&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">keystore_name</span><span class="p">):</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">keystore_name</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">keystore_name</span><span class="o">+</span><span class="s2">&quot;.bak&quot;</span><span class="p">))</span></div>

<div class="viewcode-block" id="import_cert_into_keystore"><a class="viewcode-back" href="../api.html#esg_cert_manager.import_cert_into_keystore">[docs]</a><span class="k">def</span> <span class="nf">import_cert_into_keystore</span><span class="p">(</span><span class="n">keystore_name</span><span class="p">,</span> <span class="n">keystore_alias</span><span class="p">,</span> <span class="n">keystore_password</span><span class="p">,</span> <span class="n">derkey</span><span class="p">,</span> <span class="n">cert_bundle</span><span class="p">,</span> <span class="n">provider</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Imports a signed Certificate into the keystore&#39;&#39;&#39;</span>

    <span class="n">idptools_install_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;esg_tools_dir&quot;</span><span class="p">],</span> <span class="s2">&quot;idptools&quot;</span><span class="p">)</span>
    <span class="n">extkeytool_executable</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">idptools_install_dir</span><span class="p">,</span> <span class="s2">&quot;bin&quot;</span><span class="p">,</span> <span class="s2">&quot;extkeytool&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">extkeytool_executable</span><span class="p">):</span>
        <span class="n">install_extkeytool</span><span class="p">()</span>

    <span class="n">command</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{extkeytool}</span><span class="s2"> -importkey -keystore </span><span class="si">{keystore_name}</span><span class="s2"> -alias </span><span class="si">{keystore_alias}</span><span class="s2"> -storepass </span><span class="si">{keystore_password}</span><span class="s2"> -keypass </span><span class="si">{keystore_password}</span><span class="s2"> -keyfile </span><span class="si">{derkey}</span><span class="s2"> -certfile </span><span class="si">{cert_bundle}</span><span class="s2"> -provider </span><span class="si">{provider}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">extkeytool</span><span class="o">=</span><span class="n">extkeytool_executable</span><span class="p">,</span> <span class="n">keystore_name</span><span class="o">=</span><span class="n">keystore_name</span><span class="p">,</span> <span class="n">keystore_alias</span><span class="o">=</span><span class="n">keystore_alias</span><span class="p">,</span> <span class="n">keystore_password</span><span class="o">=</span><span class="n">keystore_password</span><span class="p">,</span> <span class="n">derkey</span><span class="o">=</span><span class="n">derkey</span><span class="p">,</span> <span class="n">cert_bundle</span><span class="o">=</span><span class="n">cert_bundle</span><span class="p">,</span> <span class="n">provider</span><span class="o">=</span><span class="n">provider</span><span class="p">)</span>
    <span class="n">construct_keystore_output</span> <span class="o">=</span> <span class="n">esg_functions</span><span class="o">.</span><span class="n">call_subprocess</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">construct_keystore_output</span><span class="p">[</span><span class="s2">&quot;returncode&quot;</span><span class="p">]</span> <span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s2">&quot;Could not import cert </span><span class="si">%s</span><span class="s2"> into keystore </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cert_bundle</span><span class="p">,</span> <span class="n">keystore_name</span><span class="p">)</span></div>

<div class="viewcode-block" id="install_tomcat_keypair"><a class="viewcode-back" href="../api.html#esg_cert_manager.install_tomcat_keypair">[docs]</a><span class="k">def</span> <span class="nf">install_tomcat_keypair</span><span class="p">(</span><span class="n">private_key</span><span class="o">=</span><span class="s2">&quot;/etc/esgfcerts/hostkey.pem&quot;</span><span class="p">,</span> <span class="n">public_cert</span><span class="o">=</span><span class="s2">&quot;/etc/esgfcerts/hostcert.pem&quot;</span><span class="p">,</span> <span class="n">keystore_name</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;keystore_file&quot;</span><span class="p">],</span> <span class="n">keystore_alias</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;keystore_alias&quot;</span><span class="p">]):</span>
    <span class="sd">&#39;&#39;&#39;If you want to install a commercial CA issued certificate:</span>
<span class="sd">    esg-node --install-keypair &lt;certificate file&gt; &lt;key file&gt;</span>
<span class="sd">    When prompted for the cachain file, specify the chain file provided by your CA&#39;&#39;&#39;</span>


    <span class="c1">#Exit if public_cert(signed CSR isn&#39;t found)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">public_cert</span><span class="p">):</span>
        <span class="nb">print</span> <span class="s2">&quot;</span><span class="si">{public_cert}</span><span class="s2"> not found. Exiting.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">public_cert</span><span class="o">=</span><span class="n">public_cert</span><span class="p">)</span>
        <span class="n">esg_functions</span><span class="o">.</span><span class="n">exit_with_error</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">private_key</span><span class="p">):</span>
        <span class="nb">print</span> <span class="s2">&quot;</span><span class="si">{private_key}</span><span class="s2"> not found. Exiting.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">private_key</span><span class="o">=</span><span class="n">private_key</span><span class="p">)</span>
        <span class="n">esg_functions</span><span class="o">.</span><span class="n">exit_with_error</span><span class="p">()</span>

    <span class="nb">print</span> <span class="s2">&quot;private key = &quot;</span><span class="p">,</span> <span class="n">private_key</span>
    <span class="nb">print</span> <span class="s2">&quot;public cert = &quot;</span><span class="p">,</span> <span class="n">public_cert</span>
    <span class="nb">print</span> <span class="s2">&quot;keystore name  = &quot;</span><span class="p">,</span> <span class="n">keystore_name</span>
    <span class="nb">print</span> <span class="s2">&quot;keystore alias = &quot;</span><span class="p">,</span> <span class="n">keystore_alias</span>


    <span class="c1">#Copy and rename private_key and cert</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">private_key</span><span class="p">,</span> <span class="s2">&quot;/etc/certs/hostkey.pem&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">shutil</span><span class="o">.</span><span class="n">Error</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">samefile</span><span class="p">(</span><span class="n">private_key</span><span class="p">,</span> <span class="s2">&quot;/etc/certs/hostkey.pem&quot;</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> and /etc/certs/hostkey.pem are the same file&quot;</span><span class="p">,</span> <span class="n">private_key</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Error copying private key.&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">public_cert</span><span class="p">,</span> <span class="s2">&quot;/etc/certs/hostcert.pem&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">shutil</span><span class="o">.</span><span class="n">Error</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">samefile</span><span class="p">(</span><span class="n">public_cert</span><span class="p">,</span> <span class="s2">&quot;/etc/certs/hostcert.pem&quot;</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> and /etc/certs/hostcert.pem are the same file&quot;</span><span class="p">,</span> <span class="n">public_cert</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Error copying host cert.&quot;</span><span class="p">)</span>

    <span class="n">cert_files</span> <span class="o">=</span> <span class="n">create_certificate_chain_list</span><span class="p">()</span>
    <span class="n">create_certificate_chain</span><span class="p">(</span><span class="n">cert_files</span><span class="p">)</span>

    <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="s2">&quot;/etc/certs/hostkey.pem&quot;</span><span class="p">,</span> <span class="mi">0400</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="s2">&quot;/etc/certs/hostcert.pem&quot;</span><span class="p">,</span> <span class="mi">0644</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="s2">&quot;/etc/certs/cachain.pem&quot;</span><span class="p">,</span> <span class="mi">0644</span><span class="p">)</span>


    <span class="n">generate_tomcat_keystore</span><span class="p">(</span><span class="n">keystore_name</span><span class="p">,</span> <span class="n">keystore_alias</span><span class="p">,</span> <span class="n">private_key</span><span class="p">,</span> <span class="n">public_cert</span><span class="p">,</span> <span class="n">cert_files</span><span class="p">)</span>

    <span class="n">copy_cert_to_tomcat_conf</span><span class="p">(</span><span class="n">public_cert</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;truststore_file&quot;</span><span class="p">]):</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;truststore_file&quot;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;truststore_file&quot;</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;.bak&quot;</span><span class="p">)</span>

    <span class="c1">#(In order for ORP or any other local service to trust eachother put your own cert into the truststore)</span>
    <span class="n">rebuild_truststore</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;truststore_file&quot;</span><span class="p">])</span>
    <span class="n">add_my_cert_to_truststore</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;truststore_file&quot;</span><span class="p">],</span> <span class="n">keystore_name</span><span class="p">,</span> <span class="n">keystore_alias</span><span class="p">)</span></div>
    <span class="c1">#     #register ${esgf_idp_peer}</span>
    <span class="c1">#</span>
    <span class="c1">#     echo &quot;Please restart this node for keys to take effect: \&quot;$0 restart\&quot;&quot;</span>
    <span class="c1">#     echo</span>
    <span class="c1"># }</span>

<span class="c1">#------------------------------------</span>
<span class="c1">#   Truststore functions</span>
<span class="c1">#------------------------------------</span>

<div class="viewcode-block" id="create_new_truststore"><a class="viewcode-back" href="../api.html#esg_cert_manager.create_new_truststore">[docs]</a><span class="k">def</span> <span class="nf">create_new_truststore</span><span class="p">(</span><span class="n">truststore_file</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Create a new Java Truststore file by copying the JRE&#39;s cacerts file&#39;&#39;&#39;</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{java_install_dir}</span><span class="s2">/jre/lib/security/cacerts&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">java_install_dir</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;java_install_dir&quot;</span><span class="p">]),</span> <span class="n">truststore_file</span><span class="p">)</span></div>

<div class="viewcode-block" id="rebuild_truststore"><a class="viewcode-back" href="../api.html#esg_cert_manager.rebuild_truststore">[docs]</a><span class="k">def</span> <span class="nf">rebuild_truststore</span><span class="p">(</span><span class="n">truststore_file</span><span class="p">,</span> <span class="n">certs_dir</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;globus_global_certs_dir&quot;</span><span class="p">]):</span>
    <span class="sd">&#39;&#39;&#39;Converts ESG certificates (that can be fetch by above function) into a truststore&#39;&#39;&#39;</span>

    <span class="nb">print</span> <span class="s2">&quot;(Re)building truststore from esg certificates... [</span><span class="si">{truststore_file}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">truststore_file</span><span class="o">=</span><span class="n">truststore_file</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">certs_dir</span><span class="p">):</span>
        <span class="nb">print</span> <span class="s2">&quot;Sorry, No esg certificates found... in </span><span class="si">{certs_dir}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">certs_dir</span><span class="o">=</span><span class="n">certs_dir</span><span class="p">)</span>
        <span class="n">fetch_esgf_certificates</span><span class="p">(</span><span class="n">certs_dir</span><span class="p">)</span>

    <span class="c1">#If you don&#39;t already have a truststore to build on....</span>
    <span class="c1">#Start building from a solid foundation i.e. Java&#39;s set of ca certs...</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">truststore_file</span><span class="p">):</span>
        <span class="n">create_new_truststore</span><span class="p">(</span><span class="n">truststore_file</span><span class="p">)</span>

    <span class="n">tmp_dir</span> <span class="o">=</span> <span class="s2">&quot;/tmp/esg_scratch&quot;</span>
    <span class="n">esg_bash2py</span><span class="o">.</span><span class="n">mkdir_p</span><span class="p">(</span><span class="n">tmp_dir</span><span class="p">)</span>

    <span class="n">cert_files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{certs_dir}</span><span class="s1">/*.0&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">certs_dir</span><span class="o">=</span><span class="n">certs_dir</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">cert</span> <span class="ow">in</span> <span class="n">cert_files</span><span class="p">:</span>
        <span class="n">_insert_cert_into_truststore</span><span class="p">(</span><span class="n">cert</span><span class="p">,</span> <span class="n">truststore_file</span><span class="p">,</span> <span class="n">tmp_dir</span><span class="p">)</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">tmp_dir</span><span class="p">)</span>

    <span class="n">sync_with_java_truststore</span><span class="p">(</span><span class="n">truststore_file</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chown</span><span class="p">(</span><span class="n">truststore_file</span><span class="p">,</span> <span class="n">esg_functions</span><span class="o">.</span><span class="n">get_user_id</span><span class="p">(</span><span class="s2">&quot;tomcat&quot;</span><span class="p">),</span> <span class="n">esg_functions</span><span class="o">.</span><span class="n">get_group_id</span><span class="p">(</span><span class="s2">&quot;tomcat&quot;</span><span class="p">))</span></div>


<span class="k">def</span> <span class="nf">add_my_cert_to_truststore</span><span class="p">(</span><span class="n">truststore_file</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;truststore_file&quot;</span><span class="p">],</span> <span class="n">keystore_file</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;keystore_file&quot;</span><span class="p">],</span> <span class="n">keystore_alias</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;keystore_alias&quot;</span><span class="p">]):</span>
    <span class="c1">#----------------------------------------------------------------</span>
    <span class="c1">#Re-integrate my public key (I mean, my &quot;certificate&quot;) from my keystore into the truststore (the place housing all public keys I allow to talk to me)</span>
    <span class="c1">#----------------------------------------------------------------</span>

    <span class="nb">print</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">*******************************&quot;</span>
    <span class="nb">print</span> <span class="s2">&quot;Adding public key to truststore file </span><span class="si">{truststore_file}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">truststore_file</span><span class="o">=</span><span class="n">truststore_file</span><span class="p">)</span>
    <span class="nb">print</span> <span class="s2">&quot;******************************* </span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">truststore_file</span><span class="p">):</span>
        <span class="nb">print</span> <span class="s2">&quot;Re-Integrating keystore&#39;s certificate into truststore.... &quot;</span>
        <span class="nb">print</span> <span class="s2">&quot;Extracting keystore&#39;s certificate... &quot;</span>
        <span class="n">keystore_password</span> <span class="o">=</span> <span class="n">esg_functions</span><span class="o">.</span><span class="n">get_java_keystore_password</span><span class="p">()</span>
        <span class="n">extract_cert_output</span><span class="o">=</span> <span class="n">esg_functions</span><span class="o">.</span><span class="n">call_subprocess</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{java_install_dir}</span><span class="s2">/bin/keytool -export -alias </span><span class="si">{keystore_alias}</span><span class="s2"> -file </span><span class="si">{keystore_file}</span><span class="s2">.cer -keystore </span><span class="si">{keystore_file}</span><span class="s2"> -storepass </span><span class="si">{keystore_password}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">java_install_dir</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;java_install_dir&quot;</span><span class="p">],</span> <span class="n">keystore_alias</span><span class="o">=</span><span class="n">keystore_alias</span><span class="p">,</span> <span class="n">keystore_file</span><span class="o">=</span><span class="n">keystore_file</span><span class="p">,</span> <span class="n">keystore_password</span><span class="o">=</span><span class="n">keystore_password</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">extract_cert_output</span><span class="p">[</span><span class="s2">&quot;returncode&quot;</span><span class="p">]</span> <span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;Could not extract certificate from keystore&quot;</span>
            <span class="n">esg_functions</span><span class="o">.</span><span class="n">exit_with_error</span><span class="p">(</span><span class="n">extract_cert_output</span><span class="p">[</span><span class="s2">&quot;stderr&quot;</span><span class="p">])</span>

        <span class="nb">print</span> <span class="s2">&quot;Importing keystore&#39;s certificate into truststore... &quot;</span>
        <span class="n">import_to_truststore_output</span> <span class="o">=</span> <span class="n">esg_functions</span><span class="o">.</span><span class="n">call_subprocess</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{java_install_dir}</span><span class="s2">/bin/keytool -import -v -trustcacerts -alias </span><span class="si">{keystore_alias}</span><span class="s2"> -keypass </span><span class="si">{keystore_password}</span><span class="s2"> -file </span><span class="si">{keystore_file}</span><span class="s2">.cer -keystore </span><span class="si">{truststore_file}</span><span class="s2"> -storepass </span><span class="si">{truststore_password}</span><span class="s2"> -noprompt&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">java_install_dir</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;java_install_dir&quot;</span><span class="p">],</span> <span class="n">keystore_alias</span><span class="o">=</span><span class="n">keystore_alias</span><span class="p">,</span> <span class="n">keystore_file</span><span class="o">=</span><span class="n">keystore_file</span><span class="p">,</span> <span class="n">keystore_password</span><span class="o">=</span><span class="n">keystore_password</span><span class="p">,</span> <span class="n">truststore_file</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;truststore_file&quot;</span><span class="p">],</span> <span class="n">truststore_password</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;truststore_password&quot;</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">import_to_truststore_output</span><span class="p">[</span><span class="s2">&quot;returncode&quot;</span><span class="p">]</span> <span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;Could not import the certificate into the truststore&quot;</span>
            <span class="n">esg_functions</span><span class="o">.</span><span class="n">exit_with_error</span><span class="p">(</span><span class="n">import_to_truststore_output</span><span class="p">[</span><span class="s2">&quot;stderr&quot;</span><span class="p">])</span>

        <span class="n">sync_with_java_truststore</span><span class="p">(</span><span class="n">truststore_file</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">keystore_file</span><span class="o">+</span><span class="s2">&quot;.cer&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Could not delete extracted cert file&quot;</span><span class="p">)</span>

    <span class="n">os</span><span class="o">.</span><span class="n">chown</span><span class="p">(</span><span class="n">truststore_file</span><span class="p">,</span> <span class="n">esg_functions</span><span class="o">.</span><span class="n">get_user_id</span><span class="p">(</span><span class="s2">&quot;tomcat&quot;</span><span class="p">),</span> <span class="n">esg_functions</span><span class="o">.</span><span class="n">get_group_id</span><span class="p">(</span><span class="s2">&quot;tomcat&quot;</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">sync_with_java_truststore</span><span class="p">(</span><span class="n">truststore_file</span><span class="p">):</span>
    <span class="n">jssecacerts_path</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{java_install_dir}</span><span class="s2">/jre/lib/security/jssecacerts&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">java_install_dir</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;java_install_dir&quot;</span><span class="p">])</span>
    <span class="n">cacerts_path</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{java_install_dir}</span><span class="s2">/jre/lib/security/cacerts&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">java_install_dir</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;java_install_dir&quot;</span><span class="p">])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">jssecacerts_path</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">cacerts_path</span><span class="p">):</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">cacerts_path</span><span class="p">,</span> <span class="n">jssecacerts_path</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">truststore_file</span><span class="p">):</span>
        <span class="nb">print</span> <span class="s2">&quot;</span><span class="si">{truststore_file}</span><span class="s2"> does not exist. Exiting.&quot;</span>
        <span class="n">esg_functions</span><span class="o">.</span><span class="n">exit_with_error</span><span class="p">()</span>

    <span class="nb">print</span> <span class="s2">&quot;Syncing </span><span class="si">{truststore_file}</span><span class="s2"> with </span><span class="si">{java_truststore}</span><span class="s2"> ... &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">truststore_file</span><span class="o">=</span><span class="n">truststore_file</span><span class="p">,</span> <span class="n">java_truststore</span><span class="o">=</span><span class="n">jssecacerts_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">filecmp</span><span class="o">.</span><span class="n">cmp</span><span class="p">(</span><span class="n">truststore_file</span><span class="p">,</span> <span class="n">jssecacerts_path</span><span class="p">):</span>
        <span class="nb">print</span> <span class="s2">&quot;Files already in sync&quot;</span>
        <span class="k">return</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">jssecacerts_path</span><span class="p">,</span> <span class="n">jssecacerts_path</span><span class="o">+</span><span class="s2">&quot;.bak&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Could not back up java truststore file.&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">truststore_file</span><span class="p">,</span> <span class="n">jssecacerts_path</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Could not sync truststore files.&quot;</span><span class="p">)</span>

    <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">jssecacerts_path</span><span class="p">,</span> <span class="mi">0644</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chown</span><span class="p">(</span><span class="n">jssecacerts_path</span><span class="p">,</span> <span class="n">esg_functions</span><span class="o">.</span><span class="n">get_user_id</span><span class="p">(</span><span class="s2">&quot;root&quot;</span><span class="p">),</span> <span class="n">esg_functions</span><span class="o">.</span><span class="n">get_group_id</span><span class="p">(</span><span class="s2">&quot;root&quot;</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_insert_cert_into_truststore</span><span class="p">(</span><span class="n">cert_file</span><span class="p">,</span> <span class="n">truststore_file</span><span class="p">,</span> <span class="n">tmp_dir</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Takes full path to a pem certificate file and incorporates it into the given truststore&#39;&#39;&#39;</span>

    <span class="nb">print</span> <span class="s2">&quot;</span><span class="si">{cert_file}</span><span class="s2"> -&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cert_file</span><span class="o">=</span><span class="n">cert_file</span><span class="p">)</span>
    <span class="n">cert_hash</span> <span class="o">=</span> <span class="n">cert_file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">der_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_dir</span><span class="p">,</span> <span class="n">cert_hash</span><span class="o">+</span><span class="s2">&quot;.der&quot;</span><span class="p">)</span>
    <span class="c1">#--------------</span>
    <span class="c1"># Convert from PEM format to DER format - for ingest into keystore</span>
    <span class="n">cert_pem</span> <span class="o">=</span> <span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">load_certificate</span><span class="p">(</span><span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">FILETYPE_PEM</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">cert_file</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">der_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">der_file_handle</span><span class="p">:</span>
        <span class="n">der_file_handle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">dump_certificate</span><span class="p">(</span><span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">FILETYPE_ASN1</span><span class="p">,</span><span class="n">cert_pem</span><span class="p">))</span>

    <span class="c1">#--------------</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">truststore_file</span><span class="p">):</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">esg_functions</span><span class="o">.</span><span class="n">call_subprocess</span><span class="p">(</span><span class="s2">&quot;/usr/local/java/bin/keytool -delete -alias </span><span class="si">{cert_hash}</span><span class="s2"> -keystore </span><span class="si">{truststore_file}</span><span class="s2"> -storepass </span><span class="si">{truststore_password}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cert_hash</span><span class="o">=</span><span class="n">cert_hash</span><span class="p">,</span> <span class="n">truststore_file</span><span class="o">=</span><span class="n">truststore_file</span><span class="p">,</span> <span class="n">truststore_password</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;truststore_password&quot;</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">output</span><span class="p">[</span><span class="s2">&quot;returncode&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;Deleted cert hash&quot;</span>

        <span class="n">output</span> <span class="o">=</span> <span class="n">esg_functions</span><span class="o">.</span><span class="n">call_subprocess</span><span class="p">(</span><span class="s2">&quot;/usr/local/java/bin/keytool -import -alias </span><span class="si">{cert_hash}</span><span class="s2"> -file </span><span class="si">{der_file}</span><span class="s2"> -keystore </span><span class="si">{truststore_file}</span><span class="s2"> -storepass </span><span class="si">{truststore_password}</span><span class="s2"> -noprompt&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cert_hash</span><span class="o">=</span><span class="n">cert_hash</span><span class="p">,</span> <span class="n">der_file</span><span class="o">=</span><span class="n">der_file</span><span class="p">,</span> <span class="n">truststore_file</span><span class="o">=</span><span class="n">truststore_file</span><span class="p">,</span> <span class="n">truststore_password</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;truststore_password&quot;</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">output</span><span class="p">[</span><span class="s2">&quot;returncode&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;added </span><span class="si">{der_file}</span><span class="s2"> to </span><span class="si">{truststore_file}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">der_file</span><span class="o">=</span><span class="n">der_file</span><span class="p">,</span> <span class="n">truststore_file</span><span class="o">=</span><span class="n">truststore_file</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">der_file</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">delete_existing_temp_CA</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="s2">&quot;CA&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">OSError</span><span class="p">,</span> <span class="n">error</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">error</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">ENOENT</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="n">file_extensions</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;*.pem&quot;</span><span class="p">,</span> <span class="s2">&quot;*.gz&quot;</span><span class="p">,</span> <span class="s2">&quot;*.ans&quot;</span><span class="p">,</span> <span class="s2">&quot;*.tmpl&quot;</span><span class="p">]</span>
    <span class="n">files_to_delete</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">file_extensions</span><span class="p">:</span>
        <span class="n">files_to_delete</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">ext</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">file_name</span> <span class="ow">in</span> <span class="n">files_to_delete</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">,</span> <span class="n">error</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">error</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">ENOENT</span><span class="p">:</span>
                <span class="k">pass</span>


<div class="viewcode-block" id="createKeyPair"><a class="viewcode-back" href="../api.html#esg_cert_manager.createKeyPair">[docs]</a><span class="k">def</span> <span class="nf">createKeyPair</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">bits</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;source: https://github.com/pyca/pyopenssl/blob/master/examples/certgen.py&#39;&#39;&#39;</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a public/private key pair.</span>
<span class="sd">    Arguments: type - Key type, must be one of TYPE_RSA and TYPE_DSA</span>
<span class="sd">               bits - Number of bits to use in the key</span>
<span class="sd">    Returns:   The public/private key pair in a PKey object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pkey</span> <span class="o">=</span> <span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">PKey</span><span class="p">()</span>
    <span class="n">pkey</span><span class="o">.</span><span class="n">generate_key</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">bits</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pkey</span></div>


<div class="viewcode-block" id="createCertRequest"><a class="viewcode-back" href="../api.html#esg_cert_manager.createCertRequest">[docs]</a><span class="k">def</span> <span class="nf">createCertRequest</span><span class="p">(</span><span class="n">pkey</span><span class="p">,</span> <span class="n">digest</span><span class="o">=</span><span class="s2">&quot;sha256&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">name</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;source: https://github.com/pyca/pyopenssl/blob/master/examples/certgen.py&#39;&#39;&#39;</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a certificate request.</span>
<span class="sd">    Arguments: pkey   - The key to associate with the request</span>
<span class="sd">               digest - Digestion method to use for signing, default is sha256</span>
<span class="sd">               **name - The name of the subject of the request, possible</span>
<span class="sd">                        arguments are:</span>
<span class="sd">                          C     - Country name</span>
<span class="sd">                          ST    - State or province name</span>
<span class="sd">                          L     - Locality name</span>
<span class="sd">                          O     - Organization name</span>
<span class="sd">                          OU    - Organizational unit name</span>
<span class="sd">                          CN    - Common name</span>
<span class="sd">                          emailAddress - E-mail address</span>
<span class="sd">    Returns:   The certificate request in an X509Req object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">req</span> <span class="o">=</span> <span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">X509Req</span><span class="p">()</span>
    <span class="n">subj</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_subject</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">name</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">subj</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="n">req</span><span class="o">.</span><span class="n">set_pubkey</span><span class="p">(</span><span class="n">pkey</span><span class="p">)</span>
    <span class="n">req</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">pkey</span><span class="p">,</span> <span class="n">digest</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">req</span></div>


<div class="viewcode-block" id="createCertificate"><a class="viewcode-back" href="../api.html#esg_cert_manager.createCertificate">[docs]</a><span class="k">def</span> <span class="nf">createCertificate</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">issuerCertKey</span><span class="p">,</span> <span class="n">serial</span><span class="p">,</span> <span class="n">validityPeriod</span><span class="p">,</span>
                      <span class="n">digest</span><span class="o">=</span><span class="s2">&quot;sha256&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate a certificate given a certificate request.</span>
<span class="sd">    Arguments: req        - Certificate request to use</span>
<span class="sd">               issuerCert - The certificate of the issuer</span>
<span class="sd">               issuerKey  - The private key of the issuer</span>
<span class="sd">               serial     - Serial number for the certificate</span>
<span class="sd">               notBefore  - Timestamp (relative to now) when the certificate</span>
<span class="sd">                            starts being valid</span>
<span class="sd">               notAfter   - Timestamp (relative to now) when the certificate</span>
<span class="sd">                            stops being valid</span>
<span class="sd">               digest     - Digest method to use for signing, default is sha256</span>
<span class="sd">    Returns:   The signed certificate in an X509 object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">issuerCert</span><span class="p">,</span> <span class="n">issuerKey</span> <span class="o">=</span> <span class="n">issuerCertKey</span>
    <span class="n">notBefore</span><span class="p">,</span> <span class="n">notAfter</span> <span class="o">=</span> <span class="n">validityPeriod</span>
    <span class="n">cert</span> <span class="o">=</span> <span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">X509</span><span class="p">()</span>
    <span class="n">cert</span><span class="o">.</span><span class="n">set_serial_number</span><span class="p">(</span><span class="n">serial</span><span class="p">)</span>
    <span class="n">cert</span><span class="o">.</span><span class="n">gmtime_adj_notBefore</span><span class="p">(</span><span class="n">notBefore</span><span class="p">)</span>
    <span class="n">cert</span><span class="o">.</span><span class="n">gmtime_adj_notAfter</span><span class="p">(</span><span class="n">notAfter</span><span class="p">)</span>
    <span class="n">cert</span><span class="o">.</span><span class="n">set_issuer</span><span class="p">(</span><span class="n">issuerCert</span><span class="o">.</span><span class="n">get_subject</span><span class="p">())</span>
    <span class="n">cert</span><span class="o">.</span><span class="n">set_subject</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">get_subject</span><span class="p">())</span>
    <span class="n">cert</span><span class="o">.</span><span class="n">set_pubkey</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">get_pubkey</span><span class="p">())</span>
    <span class="n">cert</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">issuerKey</span><span class="p">,</span> <span class="n">digest</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cert</span></div>


<div class="viewcode-block" id="new_ca"><a class="viewcode-back" href="../api.html#esg_cert_manager.new_ca">[docs]</a><span class="k">def</span> <span class="nf">new_ca</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;Mimics perl CA.pl -newca&#39;&#39;&#39;</span>
    <span class="n">esg_bash2py</span><span class="o">.</span><span class="n">mkdir_p</span><span class="p">(</span><span class="s2">&quot;CA&quot;</span><span class="p">)</span>
    <span class="n">esg_bash2py</span><span class="o">.</span><span class="n">mkdir_p</span><span class="p">(</span><span class="s2">&quot;CA/certs&quot;</span><span class="p">)</span>
    <span class="n">esg_bash2py</span><span class="o">.</span><span class="n">mkdir_p</span><span class="p">(</span><span class="s2">&quot;CA/crl&quot;</span><span class="p">)</span>
    <span class="n">esg_bash2py</span><span class="o">.</span><span class="n">mkdir_p</span><span class="p">(</span><span class="s2">&quot;CA/newcerts&quot;</span><span class="p">)</span>
    <span class="n">esg_bash2py</span><span class="o">.</span><span class="n">mkdir_p</span><span class="p">(</span><span class="s2">&quot;CA/private&quot;</span><span class="p">)</span>
    <span class="n">esg_bash2py</span><span class="o">.</span><span class="n">touch</span><span class="p">(</span><span class="s2">&quot;CA/index.txt&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;CA/crlnumber&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">crlnumber_file</span><span class="p">:</span>
        <span class="n">crlnumber_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;01</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">cakey</span> <span class="o">=</span> <span class="n">createKeyPair</span><span class="p">(</span><span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">TYPE_RSA</span><span class="p">,</span> <span class="mi">4096</span><span class="p">)</span>
    <span class="n">ca_answer</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{fqdn}</span><span class="s2">-CA&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fqdn</span><span class="o">=</span><span class="n">esg_functions</span><span class="o">.</span><span class="n">get_esgf_host</span><span class="p">())</span>
    <span class="n">careq</span> <span class="o">=</span> <span class="n">createCertRequest</span><span class="p">(</span><span class="n">cakey</span><span class="p">,</span> <span class="n">CN</span><span class="o">=</span><span class="n">ca_answer</span><span class="p">,</span> <span class="n">O</span><span class="o">=</span><span class="s2">&quot;ESGF&quot;</span><span class="p">,</span> <span class="n">OU</span><span class="o">=</span><span class="s2">&quot;ESGF.ORG&quot;</span><span class="p">)</span>
    <span class="c1"># CA certificate is valid for five years.</span>
    <span class="n">cacert</span> <span class="o">=</span> <span class="n">createCertificate</span><span class="p">(</span><span class="n">careq</span><span class="p">,</span> <span class="p">(</span><span class="n">careq</span><span class="p">,</span> <span class="n">cakey</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">24</span><span class="o">*</span><span class="mi">365</span><span class="o">*</span><span class="mi">5</span><span class="p">))</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Creating Certificate Authority private key in &quot;CA/private/cakey.pem&quot;&#39;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;CA/private/cakey.pem&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">capkey</span><span class="p">:</span>
        <span class="n">capkey</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
            <span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">dump_privatekey</span><span class="p">(</span><span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">FILETYPE_PEM</span><span class="p">,</span> <span class="n">cakey</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Creating Certificate Authority certificate in &quot;CA/cacert.pem&quot;&#39;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;CA/cacert.pem&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ca</span><span class="p">:</span>
        <span class="n">ca</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
            <span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">dump_certificate</span><span class="p">(</span><span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">FILETYPE_PEM</span><span class="p">,</span> <span class="n">cacert</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
    <span class="p">)</span></div>

<div class="viewcode-block" id="newreq_nodes"><a class="viewcode-back" href="../api.html#esg_cert_manager.newreq_nodes">[docs]</a><span class="k">def</span> <span class="nf">newreq_nodes</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;Mimics perl CA.pl -newreq-nodes&#39;&#39;&#39;</span>

    <span class="n">new_req_key</span> <span class="o">=</span> <span class="n">createKeyPair</span><span class="p">(</span><span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">TYPE_RSA</span><span class="p">,</span> <span class="mi">4096</span><span class="p">)</span>
    <span class="n">new_careq</span> <span class="o">=</span> <span class="n">createCertRequest</span><span class="p">(</span><span class="n">new_req_key</span><span class="p">,</span> <span class="n">CN</span><span class="o">=</span><span class="n">esg_functions</span><span class="o">.</span><span class="n">get_esgf_host</span><span class="p">(),</span> <span class="n">O</span><span class="o">=</span><span class="s2">&quot;ESGF&quot;</span><span class="p">,</span> <span class="n">OU</span><span class="o">=</span><span class="s2">&quot;ESGF.ORG&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Creating Certificate Authority private key in &quot;newkey.pem&quot;&#39;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;newkey.pem&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">new_key_file</span><span class="p">:</span>
        <span class="n">new_key_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
            <span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">dump_privatekey</span><span class="p">(</span><span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">FILETYPE_PEM</span><span class="p">,</span> <span class="n">new_req_key</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Creating Certificate Authority private key in &quot;newreq.pem&quot;&#39;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;newreq.pem&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">new_req_file</span><span class="p">:</span>
        <span class="n">new_req_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
            <span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">dump_certificate_request</span><span class="p">(</span><span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">FILETYPE_PEM</span><span class="p">,</span> <span class="n">new_careq</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="nb">print</span> <span class="s2">&quot;Request is in newreq.pem, private key is in newkey.pem</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>

    <span class="k">return</span> <span class="n">new_careq</span><span class="p">,</span> <span class="n">new_req_key</span></div>

<div class="viewcode-block" id="sign_request"><a class="viewcode-back" href="../api.html#esg_cert_manager.sign_request">[docs]</a><span class="k">def</span> <span class="nf">sign_request</span><span class="p">(</span><span class="n">ca_req</span><span class="p">,</span> <span class="n">req_key</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Mimics perl CA.pl -sign&#39;&#39;&#39;</span>
    <span class="n">newcert</span> <span class="o">=</span> <span class="n">createCertificate</span><span class="p">(</span><span class="n">ca_req</span><span class="p">,</span> <span class="p">(</span><span class="n">ca_req</span><span class="p">,</span> <span class="n">req_key</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">24</span><span class="o">*</span><span class="mi">365</span><span class="o">*</span><span class="mi">5</span><span class="p">))</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;newcert.pem&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ca</span><span class="p">:</span>
        <span class="n">ca</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
            <span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">dump_certificate</span><span class="p">(</span><span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">FILETYPE_PEM</span><span class="p">,</span> <span class="n">newcert</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="nb">print</span> <span class="s2">&quot;Signed certificate is in newcert.pem</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span></div>

<span class="k">def</span> <span class="nf">setup_temp_ca</span><span class="p">(</span><span class="n">temp_ca_dir</span><span class="o">=</span><span class="s2">&quot;/etc/tempcerts&quot;</span><span class="p">):</span>
    <span class="nb">print</span> <span class="s2">&quot;*******************************&quot;</span>
    <span class="nb">print</span> <span class="s2">&quot;Setting up Temp CA&quot;</span>
    <span class="nb">print</span> <span class="s2">&quot;******************************* </span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="n">esg_bash2py</span><span class="o">.</span><span class="n">mkdir_p</span><span class="p">(</span><span class="n">temp_ca_dir</span><span class="p">)</span>

    <span class="c1">#Copy CA perl script and openssl conf file that it uses.  The CA perl script</span>
    <span class="c1">#is used to create a temporary root CA</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">current_directory</span><span class="p">,</span> <span class="s2">&quot;CA.pl&quot;</span><span class="p">),</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/CA.pl&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">temp_ca_dir</span><span class="p">))</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">current_directory</span><span class="p">,</span> <span class="s2">&quot;openssl.cnf&quot;</span><span class="p">),</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/openssl.cnf&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">temp_ca_dir</span><span class="p">))</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">current_directory</span><span class="p">,</span> <span class="s2">&quot;myproxy-server.config&quot;</span><span class="p">),</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/myproxy-server.config&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">temp_ca_dir</span><span class="p">))</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/CA.pl&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">temp_ca_dir</span><span class="p">),</span> <span class="mi">0755</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/openssl.cnf&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">temp_ca_dir</span><span class="p">),</span> <span class="mi">0755</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">esg_bash2py</span><span class="o">.</span><span class="n">pushd</span><span class="p">(</span><span class="n">temp_ca_dir</span><span class="p">):</span>
        <span class="n">delete_existing_temp_CA</span><span class="p">()</span>
        <span class="n">new_ca</span><span class="p">()</span>

        <span class="c1"># openssl rsa -in CA/private/cakey.pem -out clearkey.pem -passin pass:placeholderpass &amp;&amp; mv clearkey.pem CA/private/cakey.pem</span>
        <span class="n">private_cakey</span> <span class="o">=</span> <span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">load_privatekey</span><span class="p">(</span><span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">FILETYPE_PEM</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;CA/private/cakey.pem&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;clearkey.pem&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">clearkey</span><span class="p">:</span>
            <span class="n">clearkey</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">dump_privatekey</span><span class="p">(</span><span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">FILETYPE_PEM</span><span class="p">,</span> <span class="n">private_cakey</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="s2">&quot;clearkey.pem&quot;</span><span class="p">,</span> <span class="s2">&quot;CA/private/cakey.pem&quot;</span><span class="p">)</span>

        <span class="c1"># perl CA.pl -newreq-nodes &lt;reqhost.ans</span>
        <span class="n">new_careq</span><span class="p">,</span> <span class="n">new_req_key</span> <span class="o">=</span> <span class="n">newreq_nodes</span><span class="p">()</span>
        <span class="c1"># perl CA.pl -sign &lt;setuphost.ans</span>
        <span class="n">sign_request</span><span class="p">(</span><span class="n">new_careq</span><span class="p">,</span> <span class="n">new_req_key</span><span class="p">)</span>

        <span class="c1"># openssl x509 -in CA/cacert.pem -inform pem -outform pem &gt;cacert.pem</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cert_obj</span> <span class="o">=</span> <span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">load_certificate</span><span class="p">(</span><span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">FILETYPE_PEM</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;CA/cacert.pem&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="k">except</span> <span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">Error</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Certificate is not correct.&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;cacert.pem&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ca</span><span class="p">:</span>
            <span class="n">ca</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">dump_certificate</span><span class="p">(</span><span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">FILETYPE_PEM</span><span class="p">,</span> <span class="n">cert_obj</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># cp CA/private/cakey.pem cakey.pem</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="s2">&quot;CA/private/cakey.pem&quot;</span><span class="p">,</span> <span class="s2">&quot;cakey.pem&quot;</span><span class="p">)</span>

        <span class="c1"># openssl x509 -in newcert.pem -inform pem -outform pem &gt;hostcert.pem</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cert_obj</span> <span class="o">=</span> <span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">load_certificate</span><span class="p">(</span><span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">FILETYPE_PEM</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;newcert.pem&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="k">except</span> <span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">Error</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Certificate is not correct.&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;hostcert.pem&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ca</span><span class="p">:</span>
            <span class="n">ca</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">dump_certificate</span><span class="p">(</span><span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">FILETYPE_PEM</span><span class="p">,</span> <span class="n">cert_obj</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># mv newkey.pem hostkey.pem</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="s2">&quot;newkey.pem&quot;</span><span class="p">,</span> <span class="s2">&quot;hostkey.pem&quot;</span><span class="p">)</span>

        <span class="c1"># chmod 400 cakey.pem</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="s2">&quot;cakey.pem&quot;</span><span class="p">,</span> <span class="mi">0400</span><span class="p">)</span>

        <span class="c1"># chmod 400 hostkey.pem</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="s2">&quot;hostkey.pem&quot;</span><span class="p">,</span> <span class="mi">0400</span><span class="p">)</span>

        <span class="c1"># rm -f new*.pem</span>
        <span class="n">new_pem_files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;new*.pem&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">pem_file</span> <span class="ow">in</span> <span class="n">new_pem_files</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">pem_file</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">cert_obj</span> <span class="o">=</span> <span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">load_certificate</span><span class="p">(</span><span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">FILETYPE_PEM</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;cacert.pem&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="k">except</span> <span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">Error</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Certificate is not correct.&quot;</span><span class="p">)</span>

        <span class="n">local_hash</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">cert_obj</span><span class="o">.</span><span class="n">subject_name_hash</span><span class="p">())</span>
        <span class="n">globus_cert_dir</span> <span class="o">=</span> <span class="s2">&quot;globus_simple_ca_</span><span class="si">{}</span><span class="s2">_setup-0&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">local_hash</span><span class="p">)</span>
        <span class="n">esg_bash2py</span><span class="o">.</span><span class="n">mkdir_p</span><span class="p">(</span><span class="n">globus_cert_dir</span><span class="p">)</span>

        <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="s2">&quot;cacert.pem&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">globus_cert_dir</span><span class="p">,</span><span class="n">local_hash</span><span class="o">+</span><span class="s2">&quot;.0&quot;</span><span class="p">))</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">current_directory</span><span class="p">,</span> <span class="s2">&quot;signing-policy.template&quot;</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">globus_cert_dir</span><span class="p">,</span><span class="n">local_hash</span><span class="o">+</span><span class="s2">&quot;.signing_policy&quot;</span><span class="p">))</span>

        <span class="n">cert_subject_object</span> <span class="o">=</span> <span class="n">cert_obj</span><span class="o">.</span><span class="n">get_subject</span><span class="p">()</span>
        <span class="n">cert_subject</span> <span class="o">=</span> <span class="s2">&quot;/OU=</span><span class="si">{OU}</span><span class="s2">/CN=</span><span class="si">{CN}</span><span class="s2">/O=</span><span class="si">{O}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">OU</span><span class="o">=</span><span class="n">cert_subject_object</span><span class="o">.</span><span class="n">OU</span><span class="p">,</span> <span class="n">CN</span><span class="o">=</span><span class="n">cert_subject_object</span><span class="o">.</span><span class="n">CN</span><span class="p">,</span> <span class="n">O</span><span class="o">=</span><span class="n">cert_subject_object</span><span class="o">.</span><span class="n">O</span><span class="p">)</span>
        <span class="n">esg_functions</span><span class="o">.</span><span class="n">replace_string_in_file</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">globus_cert_dir</span><span class="p">,</span><span class="n">local_hash</span><span class="o">+</span><span class="s2">&quot;.signing_policy&quot;</span><span class="p">),</span> <span class="s1">&#39;/O=ESGF/OU=ESGF.ORG/CN=placeholder&#39;</span><span class="p">,</span> <span class="n">cert_subject</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">globus_cert_dir</span><span class="p">,</span><span class="n">local_hash</span><span class="o">+</span><span class="s2">&quot;.signing_policy&quot;</span><span class="p">),</span> <span class="s2">&quot;signing-policy&quot;</span><span class="p">)</span>

        <span class="c1"># tar -cvzf globus_simple_ca_${localhash}_setup-0.tar.gz $tgtdir;</span>
        <span class="k">with</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">globus_cert_dir</span><span class="o">+</span><span class="s2">&quot;.tar.gz&quot;</span><span class="p">,</span> <span class="s2">&quot;w:gz&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">tar</span><span class="p">:</span>
            <span class="n">tar</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">globus_cert_dir</span><span class="p">)</span>

        <span class="c1"># rm -rf $tgtdir;</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">globus_cert_dir</span><span class="p">)</span>

        <span class="c1"># mkdir -p /etc/certs</span>
        <span class="n">esg_bash2py</span><span class="o">.</span><span class="n">mkdir_p</span><span class="p">(</span><span class="s2">&quot;/etc/certs&quot;</span><span class="p">)</span>
    	<span class="c1"># cp openssl.cnf /etc/certs/</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="s2">&quot;openssl.cnf&quot;</span><span class="p">,</span> <span class="s2">&quot;/etc/certs/openssl.cnf&quot;</span><span class="p">)</span>
    	<span class="c1"># cp host*.pem /etc/certs/</span>
        <span class="n">host_pem_files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;new*.pem&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">pem_file</span> <span class="ow">in</span> <span class="n">host_pem_files</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">pem_file</span><span class="p">,</span> <span class="s2">&quot;/etc/certs/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pem_file</span><span class="p">))</span>
    	<span class="c1"># cp cacert.pem /etc/certs/cachain.pem</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="s2">&quot;cacert.pem&quot;</span><span class="p">,</span> <span class="s2">&quot;/etc/certs/cachain.pem&quot;</span><span class="p">)</span>
    	<span class="c1"># mkdir -p /etc/esgfcerts</span>
        <span class="n">esg_bash2py</span><span class="o">.</span><span class="n">mkdir_p</span><span class="p">(</span><span class="s2">&quot;/etc/esgfcerts&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">set_commercial_ca_paths</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">esg_property_manager</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s2">&quot;commercial.key.path&quot;</span><span class="p">):</span>
        <span class="n">commercial_key_path</span> <span class="o">=</span> <span class="n">esg_property_manager</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s2">&quot;commercial.key.path&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">commercial_key_path</span> <span class="o">=</span> <span class="n">raw_input</span><span class="p">(</span><span class="s2">&quot;Enter the file path of the commercial key: &quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">esg_property_manager</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s2">&quot;commercial.cert.path&quot;</span><span class="p">):</span>
        <span class="n">commercial_cert_path</span> <span class="o">=</span> <span class="n">esg_property_manager</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s2">&quot;commercial.cert.path&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">commercial_cert_path</span> <span class="o">=</span> <span class="n">raw_input</span><span class="p">(</span><span class="s2">&quot;Enter the file path of the commercial cert: &quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">esg_property_manager</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s2">&quot;cachain.path&quot;</span><span class="p">):</span>
        <span class="n">ca_chain_path</span> <span class="o">=</span> <span class="n">esg_property_manager</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s2">&quot;cachain.path&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ca_chain_path</span> <span class="o">=</span> <span class="n">raw_input</span><span class="p">(</span><span class="s2">&quot;Enter the file path of the ca chain: &quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">commercial_key_path</span><span class="p">,</span> <span class="n">commercial_cert_path</span><span class="p">,</span> <span class="n">ca_chain_path</span><span class="p">)</span>

<div class="viewcode-block" id="backup_existing_certs"><a class="viewcode-back" href="../api.html#esg_cert_manager.backup_existing_certs">[docs]</a><span class="k">def</span> <span class="nf">backup_existing_certs</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;Backup existing SSL certs on system&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s2">&quot;/etc/certs/hostcert.pem&quot;</span><span class="p">):</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="s2">&quot;/etc/certs/hostcert.pem&quot;</span><span class="p">,</span> <span class="s2">&quot;/etc/certs/hostcert.pem.</span><span class="si">{date}</span><span class="s2">.bak&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">date</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">())))</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s2">&quot;/etc/certs/hostkey.pem&quot;</span><span class="p">):</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="s2">&quot;/etc/certs/hostkey.pem&quot;</span><span class="p">,</span> <span class="s2">&quot;/etc/certs/hostkey.pem.</span><span class="si">{date}</span><span class="s2">.bak&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">date</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">())))</span></div>

<div class="viewcode-block" id="install_commerical_certs"><a class="viewcode-back" href="../api.html#esg_cert_manager.install_commerical_certs">[docs]</a><span class="k">def</span> <span class="nf">install_commerical_certs</span><span class="p">(</span><span class="n">commercial_key_path</span><span class="p">,</span> <span class="n">commercial_cert_path</span><span class="p">,</span> <span class="n">ca_chain_path</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Install the signed, commericial SSL credentials to /etc/certs&#39;&#39;&#39;</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">commercial_key_path</span><span class="p">,</span> <span class="s2">&quot;/etc/certs/hostkey.pem&quot;</span><span class="p">)</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">commercial_cert_path</span><span class="p">,</span> <span class="s2">&quot;/etc/certs/hostcert.pem&quot;</span><span class="p">)</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">ca_chain_path</span><span class="p">,</span> <span class="s2">&quot;/etc/certs/cachain.pem&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="check_for_commercial_ca"><a class="viewcode-back" href="../api.html#esg_cert_manager.check_for_commercial_ca">[docs]</a><span class="k">def</span> <span class="nf">check_for_commercial_ca</span><span class="p">(</span><span class="n">commercial_ca_directory</span><span class="o">=</span><span class="s2">&quot;/etc/esgfcerts&quot;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Checks if Commerical CA directory has been created; asks user if they would like proceed with</span>
<span class="sd">    Commercial CA installation if directory is found&#39;&#39;&#39;</span>

    <span class="nb">print</span> <span class="s2">&quot;*******************************&quot;</span>
    <span class="nb">print</span> <span class="s2">&quot;Checking for Commercial CA&quot;</span>
    <span class="nb">print</span> <span class="s2">&quot;******************************* </span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="k">if</span> <span class="n">esg_property_manager</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s2">&quot;install.signed.certs&quot;</span><span class="p">):</span>
        <span class="n">commercial_ca_setup</span> <span class="o">=</span> <span class="n">esg_property_manager</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s2">&quot;install.signed.certs&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">commercial_ca_setup</span> <span class="o">=</span> <span class="n">raw_input</span><span class="p">(</span><span class="s2">&quot;Do you have a commercial CA that you want to install [Y/n]: &quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;yes&quot;</span>

    <span class="k">if</span> <span class="n">commercial_ca_setup</span> <span class="ow">in</span> <span class="n">YES_LIST</span><span class="p">:</span>
        <span class="n">commercial_key_path</span><span class="p">,</span> <span class="n">commercial_cert_path</span><span class="p">,</span> <span class="n">ca_chain_path</span> <span class="o">=</span> <span class="n">set_commercial_ca_paths</span><span class="p">()</span>

        <span class="c1">#Backup existing certs</span>
        <span class="n">backup_existing_certs</span><span class="p">()</span>

        <span class="n">install_commerical_certs</span><span class="p">(</span><span class="n">commercial_key_path</span><span class="p">,</span> <span class="n">commercial_cert_path</span><span class="p">,</span> <span class="n">ca_chain_path</span><span class="p">)</span>

        <span class="nb">print</span> <span class="s2">&quot;Local installation of certs complete.&quot;</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span></div>
            <span class="c1"># file_list = [&quot;hostcert.pem&quot;, &quot;hostkey.pem&quot;]</span>
            <span class="c1"># with esg_bash2py.pushd(commercial_ca_directory):</span>
            <span class="c1">#     for file_name in file_list:</span>
            <span class="c1">#         if not os.path.isfile(file_name):</span>
            <span class="c1">#             print &quot;{file_name} not found in /etc/esgfcerts. Exiting.&quot;</span>
            <span class="c1">#             esg_functions.exit_with_error(1)</span>
            <span class="c1">#         else:</span>
            <span class="c1">#             try:</span>
            <span class="c1">#                 shutil.copyfile(file_name, &quot;/etc/grid-security/{file_name}&quot;.format(file_name=file_name))</span>
            <span class="c1">#             except OSError:</span>
            <span class="c1">#                 logger.exception(&quot;Could not copy %s&quot;, file_name)</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="nb">print</span> <span class="s2">&quot;*******************************&quot;</span>
    <span class="nb">print</span> <span class="s2">&quot;Setting up SSL Certificates&quot;</span>
    <span class="nb">print</span> <span class="s2">&quot;******************************* </span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="n">create_self_signed_cert</span><span class="p">(</span><span class="s2">&quot;/etc/certs&quot;</span><span class="p">)</span>
    <span class="n">setup_temp_ca</span><span class="p">()</span>
    <span class="n">install_tomcat_keypair</span><span class="p">(</span><span class="s2">&quot;/etc/certs/hostkey.pem&quot;</span><span class="p">,</span> <span class="s2">&quot;/etc/certs/hostcert.pem&quot;</span><span class="p">)</span>
    <span class="n">check_for_commercial_ca</span><span class="p">()</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, William Hill.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'alpha',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  <script type="text/javascript">
      jQuery(function () {
          
          SphinxRtdTheme.Navigation.enableSticky();
          
      });
  </script> 

</body>
</html>