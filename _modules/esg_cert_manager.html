

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>esg_cert_manager &mdash; esgf-installer beta documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> esgf-installer
          

          
          </a>

          
            
            
              <div class="version">
                3.0b1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Installation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cert_howto.html">ESGF Certificate Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../usage.html">ESGF Command Line Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../autoinstall_usage.html">Autoinstaller Configuration Options</a></li>
</ul>
<p class="caption"><span class="caption-text">API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api.html">Base Components</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api.html#data-node-components">Data Node Components</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api.html#index-node-components">Index Node Components</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api.html#idp-node-components">IDP Node Components</a></li>
</ul>
<p class="caption"><span class="caption-text">Issues</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../issues.html">ESGF Installer Issue Tracking Guidelines</a></li>
</ul>
<p class="caption"><span class="caption-text">Contributing</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../contribute_docs.html">Contributing to Documentation</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">esgf-installer</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Module code</a> &raquo;</li>
        
      <li>esg_cert_manager</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for esg_cert_manager</h1><div class="highlight"><pre>
<span></span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Certificate Management Functions</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">tarfile</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">ConfigParser</span>
<span class="kn">import</span> <span class="nn">yaml</span>
<span class="kn">import</span> <span class="nn">OpenSSL</span>
<span class="kn">import</span> <span class="nn">pybash</span>
<span class="kn">import</span> <span class="nn">esg_functions</span>
<span class="kn">import</span> <span class="nn">esg_property_manager</span>
<span class="kn">import</span> <span class="nn">esg_keystore_manager</span>
<span class="kn">from</span> <span class="nn">plumbum.commands</span> <span class="k">import</span> <span class="n">ProcessExecutionError</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;esgf_logger&quot;</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="vm">__name__</span><span class="p">)</span>
<span class="n">current_directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>

<span class="n">NO_LIST</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">,</span> <span class="s2">&quot;no&quot;</span><span class="p">,</span> <span class="s2">&quot;N&quot;</span><span class="p">,</span> <span class="s2">&quot;No&quot;</span><span class="p">,</span> <span class="s2">&quot;NO&quot;</span><span class="p">]</span>
<span class="n">YES_LIST</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;yes&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;Yes&quot;</span><span class="p">,</span> <span class="s2">&quot;YES&quot;</span><span class="p">]</span>


<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">,</span> <span class="s1">&#39;esg_config.yaml&#39;</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">config_file</span><span class="p">:</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">config_file</span><span class="p">)</span>

<span class="c1"># ----------------------------------------------</span>
<span class="c1">#   Certificate Creation functions (pyopenssl)</span>
<span class="c1"># ---------------------------------------------</span>


<div class="viewcode-block" id="create_key_pair"><a class="viewcode-back" href="../api.html#esg_cert_manager.create_key_pair">[docs]</a><span class="k">def</span> <span class="nf">create_key_pair</span><span class="p">(</span><span class="n">key_type</span><span class="p">,</span> <span class="n">bits</span><span class="o">=</span><span class="mi">4096</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;source: https://github.com/pyca/pyopenssl/blob/master/examples/certgen.py&#39;&#39;&#39;</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a public/private key pair.</span>
<span class="sd">    Arguments: key_type - Key type, must be one of TYPE_RSA and TYPE_DSA</span>
<span class="sd">               bits - Number of bits to use in the key</span>
<span class="sd">    Returns:   The public/private key pair in a PKey object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pkey</span> <span class="o">=</span> <span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">PKey</span><span class="p">()</span>
    <span class="n">pkey</span><span class="o">.</span><span class="n">generate_key</span><span class="p">(</span><span class="n">key_type</span><span class="p">,</span> <span class="n">bits</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pkey</span></div>


<div class="viewcode-block" id="create_cert_request"><a class="viewcode-back" href="../api.html#esg_cert_manager.create_cert_request">[docs]</a><span class="k">def</span> <span class="nf">create_cert_request</span><span class="p">(</span><span class="n">pkey</span><span class="p">,</span> <span class="n">digest</span><span class="o">=</span><span class="s2">&quot;sha256&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">name</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;source: https://github.com/pyca/pyopenssl/blob/master/examples/certgen.py&#39;&#39;&#39;</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a certificate request.</span>
<span class="sd">    Arguments: pkey   - The key to associate with the request</span>
<span class="sd">               digest - Digestion method to use for signing, default is sha256</span>
<span class="sd">               **name - The name of the subject of the request, possible</span>
<span class="sd">                        arguments are:</span>
<span class="sd">                          C     - Country name</span>
<span class="sd">                          ST    - State or province name</span>
<span class="sd">                          L     - Locality name</span>
<span class="sd">                          O     - Organization name</span>
<span class="sd">                          OU    - Organizational unit name</span>
<span class="sd">                          CN    - Common name</span>
<span class="sd">                          emailAddress - E-mail address</span>
<span class="sd">    Returns:   The certificate request in an X509Req object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">req</span> <span class="o">=</span> <span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">X509Req</span><span class="p">()</span>
    <span class="n">subj</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_subject</span><span class="p">()</span>

    <span class="nb">setattr</span><span class="p">(</span><span class="n">subj</span><span class="p">,</span> <span class="s2">&quot;O&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">[</span><span class="s2">&quot;O&quot;</span><span class="p">])</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="n">subj</span><span class="p">,</span> <span class="s2">&quot;OU&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">[</span><span class="s2">&quot;OU&quot;</span><span class="p">])</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="n">subj</span><span class="p">,</span> <span class="s2">&quot;CN&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">[</span><span class="s2">&quot;CN&quot;</span><span class="p">])</span>

    <span class="n">req</span><span class="o">.</span><span class="n">set_pubkey</span><span class="p">(</span><span class="n">pkey</span><span class="p">)</span>
    <span class="n">req</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">pkey</span><span class="p">,</span> <span class="n">digest</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">req</span></div>


<div class="viewcode-block" id="create_certificate"><a class="viewcode-back" href="../api.html#esg_cert_manager.create_certificate">[docs]</a><span class="k">def</span> <span class="nf">create_certificate</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">issuer_cert_key</span><span class="p">,</span> <span class="n">serial</span><span class="p">,</span> <span class="n">validity_period</span><span class="p">,</span>
                       <span class="n">digest</span><span class="o">=</span><span class="s2">&quot;sha256&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate a certificate given a certificate request.</span>
<span class="sd">    Arguments: req        - Certificate request to use</span>
<span class="sd">               issuer_cert - The certificate of the issuer</span>
<span class="sd">               issuer_key  - The private key of the issuer</span>
<span class="sd">               serial     - Serial number for the certificate</span>
<span class="sd">               not_before  - Timestamp (relative to now) when the certificate</span>
<span class="sd">                            starts being valid</span>
<span class="sd">               not_after   - Timestamp (relative to now) when the certificate</span>
<span class="sd">                            stops being valid</span>
<span class="sd">               digest     - Digest method to use for signing, default is sha256</span>
<span class="sd">    Returns:   The signed certificate in an X509 object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">issuer_cert</span><span class="p">,</span> <span class="n">issuer_key</span> <span class="o">=</span> <span class="n">issuer_cert_key</span>
    <span class="n">not_before</span><span class="p">,</span> <span class="n">not_after</span> <span class="o">=</span> <span class="n">validity_period</span>
    <span class="n">cert</span> <span class="o">=</span> <span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">X509</span><span class="p">()</span>
    <span class="n">cert</span><span class="o">.</span><span class="n">set_serial_number</span><span class="p">(</span><span class="n">serial</span><span class="p">)</span>
    <span class="n">cert</span><span class="o">.</span><span class="n">gmtime_adj_notBefore</span><span class="p">(</span><span class="n">not_before</span><span class="p">)</span>
    <span class="n">cert</span><span class="o">.</span><span class="n">gmtime_adj_notAfter</span><span class="p">(</span><span class="n">not_after</span><span class="p">)</span>
    <span class="n">cert</span><span class="o">.</span><span class="n">set_issuer</span><span class="p">(</span><span class="n">issuer_cert</span><span class="o">.</span><span class="n">get_subject</span><span class="p">())</span>
    <span class="n">cert</span><span class="o">.</span><span class="n">set_subject</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">get_subject</span><span class="p">())</span>
    <span class="n">cert</span><span class="o">.</span><span class="n">set_pubkey</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">get_pubkey</span><span class="p">())</span>
    <span class="n">cert</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">issuer_key</span><span class="p">,</span> <span class="n">digest</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cert</span></div>


<span class="c1"># ------------------------------------</span>
<span class="c1">#   Certificate functions</span>
<span class="c1"># ------------------------------------</span>

<div class="viewcode-block" id="set_commercial_ca_paths"><a class="viewcode-back" href="../api.html#esg_cert_manager.set_commercial_ca_paths">[docs]</a><span class="k">def</span> <span class="nf">set_commercial_ca_paths</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;Set locations of the commercial CA key and cert&#39;&#39;&#39;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">commercial_key_path</span> <span class="o">=</span> <span class="n">esg_property_manager</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s2">&quot;commercial.key.path&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">ConfigParser</span><span class="o">.</span><span class="n">NoOptionError</span><span class="p">:</span>
        <span class="n">commercial_key_path</span> <span class="o">=</span> <span class="n">raw_input</span><span class="p">(</span><span class="s2">&quot;Enter the file path of the commercial key: &quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">commercial_cert_path</span> <span class="o">=</span> <span class="n">esg_property_manager</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s2">&quot;commercial.cert.path&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">ConfigParser</span><span class="o">.</span><span class="n">NoOptionError</span><span class="p">:</span>
        <span class="n">commercial_cert_path</span> <span class="o">=</span> <span class="n">raw_input</span><span class="p">(</span><span class="s2">&quot;Enter the file path of the commercial cert: &quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">ca_chain_path</span> <span class="o">=</span> <span class="n">esg_property_manager</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s2">&quot;cachain.path&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">ConfigParser</span><span class="o">.</span><span class="n">NoOptionError</span><span class="p">:</span>
        <span class="n">ca_chain_path</span> <span class="o">=</span> <span class="n">raw_input</span><span class="p">(</span><span class="s2">&quot;Enter the file path of the ca chain: &quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">commercial_key_path</span><span class="p">,</span> <span class="n">commercial_cert_path</span><span class="p">,</span> <span class="n">ca_chain_path</span><span class="p">)</span></div>


<span class="c1"># ------------------------------------</span>
<span class="c1">#   Install Cert functions</span>
<span class="c1"># ------------------------------------</span>
<div class="viewcode-block" id="check_for_commercial_ca"><a class="viewcode-back" href="../api.html#esg_cert_manager.check_for_commercial_ca">[docs]</a><span class="k">def</span> <span class="nf">check_for_commercial_ca</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;Checks if Commerical CA directory has been created; asks user if they would like proceed with</span>
<span class="sd">    Commercial CA installation if directory is found&#39;&#39;&#39;</span>

    <span class="nb">print</span> <span class="s2">&quot;*******************************&quot;</span>
    <span class="nb">print</span> <span class="s2">&quot;Checking for Commercial CA&quot;</span>
    <span class="nb">print</span> <span class="s2">&quot;******************************* </span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">commercial_ca_setup</span> <span class="o">=</span> <span class="n">esg_property_manager</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s2">&quot;install.signed.certs&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">ConfigParser</span><span class="o">.</span><span class="n">NoOptionError</span><span class="p">:</span>
        <span class="n">commercial_ca_setup</span> <span class="o">=</span> <span class="n">raw_input</span><span class="p">(</span>
            <span class="s2">&quot;Do you have a commercial CA that you want to install [Y/n]: &quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;yes&quot;</span>

    <span class="k">if</span> <span class="n">commercial_ca_setup</span> <span class="ow">in</span> <span class="n">YES_LIST</span><span class="p">:</span>
        <span class="n">commercial_key_path</span><span class="p">,</span> <span class="n">commercial_cert_path</span><span class="p">,</span> <span class="n">ca_chain_path</span> <span class="o">=</span> <span class="n">set_commercial_ca_paths</span><span class="p">()</span>

        <span class="c1"># Backup existing certs</span>
        <span class="n">backup_existing_certs</span><span class="p">()</span>
        <span class="n">esg_keystore_manager</span><span class="o">.</span><span class="n">install_keypair</span><span class="p">(</span><span class="n">commercial_key_path</span><span class="p">,</span> <span class="n">commercial_cert_path</span><span class="p">)</span>

        <span class="nb">print</span> <span class="s2">&quot;Local installation of certs complete.&quot;</span></div>


<div class="viewcode-block" id="install_local_certs"><a class="viewcode-back" href="../api.html#esg_cert_manager.install_local_certs">[docs]</a><span class="k">def</span> <span class="nf">install_local_certs</span><span class="p">(</span><span class="n">node_type_list</span><span class="p">,</span> <span class="n">firstrun</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Installs local certs to /var/lib/globus-connect-server/myproxy-ca and /etc/grid-security&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">firstrun</span><span class="p">:</span>
        <span class="n">file_list</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;cakey.pem&quot;</span><span class="p">,</span> <span class="s2">&quot;cacert.pem&quot;</span><span class="p">,</span> <span class="s2">&quot;hostcert.pem&quot;</span><span class="p">,</span>
                     <span class="s2">&quot;hostkey.pem&quot;</span><span class="p">,</span> <span class="s2">&quot;myproxy-server.config&quot;</span><span class="p">)</span>
        <span class="n">certdir</span> <span class="o">=</span> <span class="s2">&quot;/etc/tempcerts&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;IDP&quot;</span> <span class="ow">in</span> <span class="n">node_type_list</span><span class="p">:</span>
            <span class="n">file_list</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;cakey.pem&quot;</span><span class="p">,</span> <span class="s2">&quot;cacert.pem&quot;</span><span class="p">,</span> <span class="s2">&quot;hostcert.pem&quot;</span><span class="p">,</span> <span class="s2">&quot;hostkey.pem&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">file_list</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;hostcert.pem&quot;</span><span class="p">,</span> <span class="s2">&quot;hostkey.pem&quot;</span><span class="p">)</span>

        <span class="n">certdir</span> <span class="o">=</span> <span class="s2">&quot;/etc/esgfcerts&quot;</span>

    <span class="k">with</span> <span class="n">pybash</span><span class="o">.</span><span class="n">pushd</span><span class="p">(</span><span class="n">certdir</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">file_name</span> <span class="ow">in</span> <span class="n">file_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_name</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span>
                    <span class="s2">&quot;File </span><span class="si">{}</span><span class="s2"> is not found in </span><span class="si">{}</span><span class="s2">; Please place it there and reexecute esg_node.py --install-local-certs&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">certdir</span><span class="p">))</span>

        <span class="k">if</span> <span class="s2">&quot;IDP&quot;</span> <span class="ow">in</span> <span class="n">node_type_list</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cert_obj</span> <span class="o">=</span> <span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">load_certificate</span><span class="p">(</span>
                    <span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">FILETYPE_PEM</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;cacert.pem&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
            <span class="k">except</span> <span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">Error</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Certificate is not correct.&quot;</span><span class="p">)</span>

            <span class="n">local_hash</span> <span class="o">=</span> <span class="n">esg_functions</span><span class="o">.</span><span class="n">convert_hash_to_hex</span><span class="p">(</span><span class="n">cert_obj</span><span class="o">.</span><span class="n">subject_name_hash</span><span class="p">())</span>
            <span class="n">globus_pack</span> <span class="o">=</span> <span class="s2">&quot;globus_simple_ca_</span><span class="si">{}</span><span class="s2">_setup-0.tar.gz&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">local_hash</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">globus_pack</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span>
                    <span class="s2">&quot;File </span><span class="si">{}</span><span class="s2"> is not found in </span><span class="si">{}</span><span class="s2">; Please place it there and reexecute esg_node.py --install-local-certs&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">globus_pack</span><span class="p">,</span> <span class="n">certdir</span><span class="p">))</span>

        <span class="k">if</span> <span class="s2">&quot;IDP&quot;</span> <span class="ow">in</span> <span class="n">node_type_list</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="s2">&quot;cacert.pem&quot;</span><span class="p">,</span> <span class="s2">&quot;/var/lib/globus-connect-server/myproxy-ca/cacert.pem&quot;</span><span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span>
                <span class="s2">&quot;cakey.pem&quot;</span><span class="p">,</span> <span class="s2">&quot;/var/lib/globus-connect-server/myproxy-ca/private/cakey.pem&quot;</span><span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span>
                <span class="n">globus_pack</span><span class="p">,</span> <span class="s2">&quot;/var/lib/globus-connect-server/myproxy-ca/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">globus_pack</span><span class="p">))</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">globus_pack</span><span class="p">,</span> <span class="s2">&quot;/etc/grid-security/certificates/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">globus_pack</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;hostkey.pem&quot;</span><span class="p">):</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="s2">&quot;hostkey.pem&quot;</span><span class="p">,</span> <span class="s2">&quot;/etc/grid-security/hostkey.pem&quot;</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="s2">&quot;/etc/grid-security/hostkey.pem&quot;</span><span class="p">,</span> <span class="mi">0600</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;hostcert.pem&quot;</span><span class="p">):</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="s2">&quot;hostcert.pem&quot;</span><span class="p">,</span> <span class="s2">&quot;/etc/grid-security/hostcert.pem&quot;</span><span class="p">)</span>

        <span class="nb">print</span> <span class="s2">&quot;Local installation of certs complete.&quot;</span></div>


<span class="c1"># ----------------------------------------------</span>
<span class="c1">#   CSR functions</span>
<span class="c1"># ---------------------------------------------</span>

<div class="viewcode-block" id="generate_ssl_key_and_csr"><a class="viewcode-back" href="../api.html#esg_cert_manager.generate_ssl_key_and_csr">[docs]</a><span class="k">def</span> <span class="nf">generate_ssl_key_and_csr</span><span class="p">(</span><span class="n">private_key</span><span class="o">=</span><span class="s2">&quot;/usr/local/tomcat/hostkey.pem&quot;</span><span class="p">,</span> <span class="n">public_cert_req</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Create a SSL keypair and CSR&#39;&#39;&#39;</span>
    <span class="nb">print</span> <span class="s2">&quot;Generating private host key... &quot;</span>
    <span class="n">key_pair</span> <span class="o">=</span> <span class="n">create_key_pair</span><span class="p">(</span><span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">TYPE_RSA</span><span class="p">,</span> <span class="mi">4096</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">private_key</span><span class="p">,</span> <span class="s2">&quot;wt&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">key_file_handle</span><span class="p">:</span>
        <span class="n">key_file_handle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">dump_privatekey</span><span class="p">(</span><span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">FILETYPE_PEM</span><span class="p">,</span> <span class="n">key_pair</span><span class="p">))</span>

    <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">private_key</span><span class="p">,</span> <span class="mi">0400</span><span class="p">)</span>

    <span class="nb">print</span> <span class="s2">&quot;Generating Certificate Signing Request (csr)... &quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">public_cert_req</span><span class="p">:</span>
        <span class="n">public_cert_req</span> <span class="o">=</span> <span class="s2">&quot;/usr/local/tomcat/</span><span class="si">{}</span><span class="s2">-esg-node.csr&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">esg_functions</span><span class="o">.</span><span class="n">get_esgf_host</span><span class="p">())</span>

    <span class="n">public_cert_dn</span> <span class="o">=</span> <span class="n">extract_keystore_dn</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">public_cert_dn</span><span class="p">:</span>
        <span class="n">careq</span> <span class="o">=</span> <span class="n">create_cert_request</span><span class="p">(</span><span class="n">private_key</span><span class="p">,</span> <span class="n">public_cert_dn</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">careq</span> <span class="o">=</span> <span class="n">create_cert_request</span><span class="p">(</span><span class="n">private_key</span><span class="p">,</span> <span class="n">O</span><span class="o">=</span><span class="s2">&quot;ESGF&quot;</span><span class="p">,</span> <span class="n">OU</span><span class="o">=</span><span class="s2">&quot;ESGF.ORG&quot;</span><span class="p">,</span>
                                    <span class="n">CN</span><span class="o">=</span><span class="n">esg_functions</span><span class="o">.</span><span class="n">get_esgf_host</span><span class="p">())</span>

    <span class="nb">print</span> <span class="s2">&quot;Generating 30 day temporary self-signed certificate... &quot;</span>

    <span class="n">newcert</span> <span class="o">=</span> <span class="n">create_certificate</span><span class="p">(</span><span class="n">careq</span><span class="p">,</span> <span class="p">(</span><span class="n">careq</span><span class="p">,</span> <span class="n">private_key</span><span class="p">),</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">30</span><span class="p">)),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">30</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">24</span><span class="o">*</span><span class="mi">365</span><span class="o">*</span><span class="mi">5</span><span class="p">))</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;/usr/local/tomcat/</span><span class="si">{}</span><span class="s1">-esg-node.pem&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">esg_functions</span><span class="o">.</span><span class="n">get_esgf_host</span><span class="p">()),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ca_file</span><span class="p">:</span>
        <span class="n">ca_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
            <span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">dump_certificate</span><span class="p">(</span><span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">FILETYPE_PEM</span><span class="p">,</span> <span class="n">newcert</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="nb">print</span> <span class="s2">&quot;--------------------------------------------------------&quot;</span>
        <span class="nb">print</span> <span class="s2">&quot;In Directory: /usr/local/tomcat&quot;</span>
        <span class="nb">print</span> <span class="s2">&quot;Generated private key: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">private_key</span><span class="p">)</span>
        <span class="nb">print</span> <span class="s2">&quot;Generated certificate: /usr/local/tomcat/</span><span class="si">{}</span><span class="s2">-esg-node.pem&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">esg_functions</span><span class="o">.</span><span class="n">get_esgf_host</span><span class="p">())</span>
        <span class="nb">print</span> <span class="s2">&quot;Please obtain and install appropriate certificates at the earliest. Execute esg_node.py --cert-howto for details.&quot;</span>
        <span class="c1">#print &quot;Then run %&gt; esg-node --install-ssl-keypair &lt;signed cert&gt; &lt;private key&gt; (use --help for details)&quot;</span>
        <span class="nb">print</span> <span class="s2">&quot;--------------------------------------------------------&quot;</span></div>


<div class="viewcode-block" id="generate_esgf_csrs"><a class="viewcode-back" href="../api.html#esg_cert_manager.generate_esgf_csrs">[docs]</a><span class="k">def</span> <span class="nf">generate_esgf_csrs</span><span class="p">(</span><span class="n">node_type_list</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Generates a CSR to be signed by a ESGF CA&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="s2">&quot;IDP&quot;</span> <span class="ow">in</span> <span class="n">node_type_list</span><span class="p">:</span>
        <span class="n">key_pair</span> <span class="o">=</span> <span class="n">create_key_pair</span><span class="p">(</span><span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">TYPE_RSA</span><span class="p">,</span> <span class="mi">4096</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;/etc/esgfcerts/cakey.pem&quot;</span><span class="p">,</span> <span class="s2">&quot;wt&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">key_file_handle</span><span class="p">:</span>
            <span class="n">key_file_handle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">dump_privatekey</span><span class="p">(</span>
                <span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">FILETYPE_PEM</span><span class="p">,</span> <span class="n">key_pair</span><span class="p">))</span>

        <span class="n">key_string</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;/etc/esgfcerts/cakey.pem&quot;</span><span class="p">,</span> <span class="s1">&#39;rt&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">key_object</span> <span class="o">=</span> <span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">load_privatekey</span><span class="p">(</span><span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">FILETYPE_PEM</span><span class="p">,</span> <span class="n">key_string</span><span class="p">)</span>

        <span class="n">careq</span> <span class="o">=</span> <span class="n">create_cert_request</span><span class="p">(</span><span class="n">key_object</span><span class="p">,</span> <span class="n">O</span><span class="o">=</span><span class="s2">&quot;ESGF&quot;</span><span class="p">,</span> <span class="n">OU</span><span class="o">=</span><span class="s2">&quot;ESGF.ORG&quot;</span><span class="p">,</span>
                                    <span class="n">CN</span><span class="o">=</span><span class="n">esg_functions</span><span class="o">.</span><span class="n">get_esgf_host</span><span class="p">()</span><span class="o">+</span><span class="s2">&quot;-CA&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;/etc/esgfcerts/cacert_req.csr&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">csr</span><span class="p">:</span>
            <span class="n">csr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">dump_certificate_request</span><span class="p">(</span>
                    <span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">FILETYPE_PEM</span><span class="p">,</span> <span class="n">careq</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="nb">print</span> <span class="s2">&quot;Successfully generated request for a simpleCA CA certificate: /etc/esgfcerts/cacert_req.csr&quot;</span>

    <span class="nb">print</span> <span class="s2">&quot;You are strongly advised to obtain and install commercial CA issued certificates for the web container.&quot;</span>

    <span class="n">key_pair</span> <span class="o">=</span> <span class="n">create_key_pair</span><span class="p">(</span><span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">TYPE_RSA</span><span class="p">,</span> <span class="mi">4096</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;/etc/esgfcerts/hostkey.pem&quot;</span><span class="p">,</span> <span class="s2">&quot;wt&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">key_file_handle</span><span class="p">:</span>
        <span class="n">key_file_handle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">dump_privatekey</span><span class="p">(</span><span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">FILETYPE_PEM</span><span class="p">,</span> <span class="n">key_pair</span><span class="p">))</span>

    <span class="n">key_string</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;/etc/esgfcerts/hostkey.pem&quot;</span><span class="p">,</span> <span class="s1">&#39;rt&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">key_object</span> <span class="o">=</span> <span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">load_privatekey</span><span class="p">(</span><span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">FILETYPE_PEM</span><span class="p">,</span> <span class="n">key_string</span><span class="p">)</span>

    <span class="n">careq</span> <span class="o">=</span> <span class="n">create_cert_request</span><span class="p">(</span><span class="n">key_object</span><span class="p">,</span> <span class="n">O</span><span class="o">=</span><span class="s2">&quot;ESGF&quot;</span><span class="p">,</span> <span class="n">OU</span><span class="o">=</span><span class="s2">&quot;ESGF.ORG&quot;</span><span class="p">,</span> <span class="n">CN</span><span class="o">=</span><span class="n">esg_functions</span><span class="o">.</span><span class="n">get_esgf_host</span><span class="p">())</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;/etc/esgfcerts/hostcert_req.csr&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">csr</span><span class="p">:</span>
        <span class="n">csr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
            <span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">dump_certificate_request</span><span class="p">(</span>
                <span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">FILETYPE_PEM</span><span class="p">,</span> <span class="n">careq</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="nb">print</span> <span class="s2">&quot;Successfully generated request for a simpleCA CA certificate: /etc/esgfcerts/hostcert_req.csr&quot;</span>

    <span class="nb">print</span> <span class="s2">&quot;Please mail the csr files for signing to Lukasz Lacinski &lt;lukasz@uchicago.edu&gt;, Prashanth Dwarakanath &lt;pchengi@nsc.liu.se&gt;, or Sebastien Denvil &lt;sebastien.denvil@ipsl.jussieu.fr&gt;&quot;</span>
    <span class="nb">print</span> <span class="s2">&quot;When you receive the signed certificate pack, untar all files into /etc/esgfcerts and execute esg_node.py --install-local-certs&quot;</span>
    <span class="nb">print</span> <span class="s2">&quot;If you also want to install the local certs for the tomcat web-container, execute esg_node.py --install-keypair /etc/esgfcerts/hostcert.pem /etc/esgfcerts/hostkey.pem&quot;</span>
    <span class="nb">print</span> <span class="s2">&quot;When prompted for the cachain file, specify /etc/esgfcerts/cachain.pem&quot;</span></div>


<div class="viewcode-block" id="generate_esgf_csrs_ext"><a class="viewcode-back" href="../api.html#esg_cert_manager.generate_esgf_csrs_ext">[docs]</a><span class="k">def</span> <span class="nf">generate_esgf_csrs_ext</span><span class="p">(</span><span class="n">node_type</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Generates a CSR to be signed by a ESGF CA&#39;&#39;&#39;</span>
    <span class="nb">print</span> <span class="s2">&quot;Are you requesting certs for an index-node or a datanode? (index/data)?&quot;</span>
    <span class="k">if</span> <span class="n">node_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;index&quot;</span> <span class="ow">or</span> <span class="n">node_type</span> <span class="o">!=</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s2">&quot;Please specify index or data as node type&quot;</span>
        <span class="k">return</span>

    <span class="n">req_node_hostname</span> <span class="o">=</span> <span class="n">raw_input</span><span class="p">(</span><span class="s2">&quot;Enter FQDN of node you are requesting certificates for&quot;</span><span class="p">)</span>

    <span class="n">pybash</span><span class="o">.</span><span class="n">mkdir_p</span><span class="p">(</span><span class="s2">&quot;/etc/extcsrs&quot;</span><span class="p">)</span>

    <span class="n">cert_files</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;hostkey.pem&#39;</span><span class="p">,</span> <span class="s1">&#39;hostcert_req.csr&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">node_type</span> <span class="o">==</span> <span class="s2">&quot;index&quot;</span><span class="p">:</span>
        <span class="n">cert_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;cacert_req.csr&#39;</span><span class="p">)</span>
        <span class="n">cert_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;cakey.pem&#39;</span><span class="p">)</span>

        <span class="n">key_pair</span> <span class="o">=</span> <span class="n">create_key_pair</span><span class="p">(</span><span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">TYPE_RSA</span><span class="p">,</span> <span class="mi">4096</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;/etc/extcsrs/cakey.pem&quot;</span><span class="p">,</span> <span class="s2">&quot;wt&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">key_file_handle</span><span class="p">:</span>
            <span class="n">key_file_handle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">dump_privatekey</span><span class="p">(</span>
                <span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">FILETYPE_PEM</span><span class="p">,</span> <span class="n">key_pair</span><span class="p">))</span>

        <span class="n">key_string</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;/etc/extcsrs/cakey.pem&quot;</span><span class="p">,</span> <span class="s1">&#39;rt&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">key_object</span> <span class="o">=</span> <span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">load_privatekey</span><span class="p">(</span><span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">FILETYPE_PEM</span><span class="p">,</span> <span class="n">key_string</span><span class="p">)</span>

        <span class="n">careq</span> <span class="o">=</span> <span class="n">create_cert_request</span><span class="p">(</span><span class="n">key_object</span><span class="p">,</span> <span class="n">O</span><span class="o">=</span><span class="s2">&quot;ESGF&quot;</span><span class="p">,</span> <span class="n">OU</span><span class="o">=</span><span class="s2">&quot;ESGF.ORG&quot;</span><span class="p">,</span>
                                    <span class="n">CN</span><span class="o">=</span><span class="n">esg_functions</span><span class="o">.</span><span class="n">get_esgf_host</span><span class="p">()</span><span class="o">+</span><span class="s2">&quot;-CA&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;/etc/extcsrs/cacert_req.csr&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">csr</span><span class="p">:</span>
            <span class="n">csr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">dump_certificate_request</span><span class="p">(</span>
                    <span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">FILETYPE_PEM</span><span class="p">,</span> <span class="n">careq</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="nb">print</span> <span class="s2">&quot;Successfully generated request for a simpleCA CA certificate: /etc/extcsrs/cacert_req.csr&quot;</span>

    <span class="nb">print</span> <span class="s2">&quot;You are strongly advised to obtain and install commercial CA issued certificates for the web container.&quot;</span>

    <span class="n">key_pair</span> <span class="o">=</span> <span class="n">create_key_pair</span><span class="p">(</span><span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">TYPE_RSA</span><span class="p">,</span> <span class="mi">4096</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;/etc/extcsrs/hostkey.pem&quot;</span><span class="p">,</span> <span class="s2">&quot;wt&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">key_file_handle</span><span class="p">:</span>
        <span class="n">key_file_handle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">dump_privatekey</span><span class="p">(</span><span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">FILETYPE_PEM</span><span class="p">,</span> <span class="n">key_pair</span><span class="p">))</span>

    <span class="n">key_string</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;/etc/extcsrs/hostkey.pem&quot;</span><span class="p">,</span> <span class="s1">&#39;rt&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">key_object</span> <span class="o">=</span> <span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">load_privatekey</span><span class="p">(</span><span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">FILETYPE_PEM</span><span class="p">,</span> <span class="n">key_string</span><span class="p">)</span>

    <span class="n">careq</span> <span class="o">=</span> <span class="n">create_cert_request</span><span class="p">(</span><span class="n">key_object</span><span class="p">,</span> <span class="n">O</span><span class="o">=</span><span class="s2">&quot;ESGF&quot;</span><span class="p">,</span> <span class="n">OU</span><span class="o">=</span><span class="s2">&quot;ESGF.ORG&quot;</span><span class="p">,</span> <span class="n">CN</span><span class="o">=</span><span class="n">req_node_hostname</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;/etc/extcsrs/hostcert_req.csr&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">csr</span><span class="p">:</span>
        <span class="n">csr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
            <span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">dump_certificate_request</span><span class="p">(</span>
                <span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">FILETYPE_PEM</span><span class="p">,</span> <span class="n">careq</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="nb">print</span> <span class="s2">&quot;Successfully generated request for a simpleCA CA certificate: /etc/extcsrs/hostcert_req.csr&quot;</span>

    <span class="k">with</span> <span class="n">pybash</span><span class="o">.</span><span class="n">pushd</span><span class="p">(</span><span class="s2">&quot;/etc/extcsrs&quot;</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">req_node_hostname</span><span class="p">,</span> <span class="s2">&quot;w:tgz&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">tar</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">file_name</span> <span class="ow">in</span> <span class="n">cert_files</span><span class="p">:</span>
                    <span class="n">tar</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
            <span class="nb">print</span> <span class="s2">&quot;A copy of the generated keys and CSRs has been saved as /etc/extcsrs/</span><span class="si">{}</span><span class="s2">.tgz&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">req_node_hostname</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;ERROR: Problem with creating backup archive: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">req_node_hostname</span><span class="p">)</span>

    <span class="nb">print</span> <span class="s2">&quot;Please mail the csr files for signing to Lukasz Lacinski &lt;lukasz@uchicago.edu&gt;, Prashanth Dwarakanath &lt;pchengi@nsc.liu.se&gt;, or Sebastien Denvil &lt;sebastien.denvil@ipsl.jussieu.fr&gt;&quot;</span>
    <span class="nb">print</span> <span class="s2">&quot;When you receive the signed certificate pack, untar all files into /etc/esgfcerts and execute esg_node.py --install-local-certs&quot;</span>
    <span class="nb">print</span> <span class="s2">&quot;If you also want to install the local certs for the tomcat web-container, execute esg_node.py --install-keypair /etc/esgfcerts/hostcert.pem /etc/esgfcerts/hostkey.pem&quot;</span>
    <span class="nb">print</span> <span class="s2">&quot;When prompted for the cachain file, specify /etc/esgfcerts/cachain.pem&quot;</span></div>

<span class="c1"># ------------------------------------</span>
<span class="c1">#   Utility functions</span>
<span class="c1"># ------------------------------------</span>


<div class="viewcode-block" id="check_cert_expiry"><a class="viewcode-back" href="../api.html#esg_cert_manager.check_cert_expiry">[docs]</a><span class="k">def</span> <span class="nf">check_cert_expiry</span><span class="p">(</span><span class="n">cert_name</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Check if a certificate is valid or has expired&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">cert_name</span><span class="p">):</span>
        <span class="nb">print</span> <span class="s2">&quot;Certficate file </span><span class="si">{}</span><span class="s2"> does not exists&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cert_name</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">cert_data</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">cert_name</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">x509</span> <span class="o">=</span> <span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">load_certificate</span><span class="p">(</span><span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">FILETYPE_PEM</span><span class="p">,</span> <span class="n">cert_data</span><span class="p">)</span>
    <span class="n">expire_date</span> <span class="o">=</span> <span class="n">x509</span><span class="o">.</span><span class="n">get_notAfter</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">x509</span><span class="o">.</span><span class="n">has_expired</span><span class="p">():</span>
        <span class="nb">print</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> is expired&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cert_name</span><span class="p">)</span>

    <span class="nb">print</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> will expire </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cert_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">expire_date</span><span class="p">))</span></div>


<div class="viewcode-block" id="extract_openssl_dn"><a class="viewcode-back" href="../api.html#esg_cert_manager.extract_openssl_dn">[docs]</a><span class="k">def</span> <span class="nf">extract_openssl_dn</span><span class="p">(</span><span class="n">public_cert</span><span class="o">=</span><span class="s2">&quot;/etc/grid-security/hostcert.pem&quot;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Regex&#39;s the output from openssl&#39;s x509 output in &quot;openssl&quot; format:</span>
<span class="sd">    Subject: O=Grid, OU=GlobusTest, OU=simpleCA-pcmdi3.llnl.gov, CN=pcmdi7.llnl.gov</span>
<span class="sd">    and transforms it to our &quot;standard&quot; format</span>
<span class="sd">    /O=Grid/OU=GlobusTest/OU=simpleCA-pcmdi3.llnl.gov/CN=pcmdi7.llnl.gov</span>
<span class="sd">    arg 1 -&gt; the location of the x509 pem file&#39;&#39;&#39;</span>

    <span class="n">x509</span> <span class="o">=</span> <span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">load_certificate</span><span class="p">(</span><span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">FILETYPE_PEM</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">public_cert</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    <span class="n">subject_components</span> <span class="o">=</span> <span class="n">x509</span><span class="o">.</span><span class="n">get_subject</span><span class="p">()</span><span class="o">.</span><span class="n">get_components</span><span class="p">()</span>
    <span class="n">subject_string</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="k">for</span> <span class="n">component</span> <span class="ow">in</span> <span class="n">subject_components</span><span class="p">:</span>
        <span class="n">subject_string</span> <span class="o">=</span> <span class="n">subject_string</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">component</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">+</span> <span class="n">component</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">subject_string</span></div>


<div class="viewcode-block" id="extract_keystore_dn"><a class="viewcode-back" href="../api.html#esg_cert_manager.extract_keystore_dn">[docs]</a><span class="k">def</span> <span class="nf">extract_keystore_dn</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;Returns the distinguished name from the Java keystore&#39;&#39;&#39;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">keystore_info</span> <span class="o">=</span> <span class="n">esg_functions</span><span class="o">.</span><span class="n">call_binary</span><span class="p">(</span><span class="s2">&quot;/usr/local/java/bin/keytool&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;-list&quot;</span><span class="p">,</span> <span class="s2">&quot;-v&quot;</span><span class="p">,</span> <span class="s2">&quot;-keystore&quot;</span><span class="p">,</span> <span class="s2">&quot;/esg/config/tomcat/keystore-tomcat&quot;</span><span class="p">])</span>
    <span class="k">except</span> <span class="n">ProcessExecutionError</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Could not extract distinguished name from keystore&quot;</span><span class="p">)</span>
        <span class="k">raise</span>
    <span class="n">keystore_owner</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;Owner:.*&quot;</span><span class="p">,</span> <span class="n">keystore_info</span><span class="p">)</span>
    <span class="n">distinguished_name</span> <span class="o">=</span> <span class="n">keystore_owner</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">distinguished_name</span></div>


<div class="viewcode-block" id="check_certificates"><a class="viewcode-back" href="../api.html#esg_cert_manager.check_certificates">[docs]</a><span class="k">def</span> <span class="nf">check_certificates</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;Check the validity of the ESGF and Globus certificates&#39;&#39;&#39;</span>
    <span class="nb">print</span> <span class="s2">&quot;check_certificates...&quot;</span>
    <span class="n">tomcat_cert_file</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">-esg-node.pem&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;tomcat_conf_dir&quot;</span><span class="p">],</span> <span class="n">esg_functions</span><span class="o">.</span><span class="n">get_esgf_host</span><span class="p">())</span>
    <span class="n">check_cert_expiry</span><span class="p">(</span><span class="n">tomcat_cert_file</span><span class="p">)</span>

    <span class="kn">from</span> <span class="nn">idp_node</span> <span class="k">import</span> <span class="n">globus</span>
    <span class="n">globus</span><span class="o">.</span><span class="n">globus_check_certificates</span><span class="p">()</span></div>


<div class="viewcode-block" id="backup_existing_certs"><a class="viewcode-back" href="../api.html#esg_cert_manager.backup_existing_certs">[docs]</a><span class="k">def</span> <span class="nf">backup_existing_certs</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;Backup existing SSL certs on system&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s2">&quot;/etc/certs/hostcert.pem&quot;</span><span class="p">):</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="s2">&quot;/etc/certs/hostcert.pem&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;/etc/certs/hostcert.pem.</span><span class="si">{date}</span><span class="s2">.bak&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">date</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">())))</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s2">&quot;/etc/certs/hostkey.pem&quot;</span><span class="p">):</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="s2">&quot;/etc/certs/hostkey.pem&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;/etc/certs/hostkey.pem.</span><span class="si">{date}</span><span class="s2">.bak&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">date</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">())))</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, William Hill

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
    

  

  <script type="text/javascript" src="../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>