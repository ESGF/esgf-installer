

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>esg_functions &mdash; esgf-installer beta documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> esgf-installer
          

          
          </a>

          
            
            
              <div class="version">
                3.0b1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Installation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cert_howto.html">ESGF Certificate Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../usage.html">ESGF Command Line Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../autoinstall_usage.html">Autoinstaller Configuration Options</a></li>
</ul>
<p class="caption"><span class="caption-text">API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api.html">Base Components</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api.html#data-node-components">Data Node Components</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api.html#index-node-components">Index Node Components</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api.html#idp-node-components">IDP Node Components</a></li>
</ul>
<p class="caption"><span class="caption-text">Issues</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../issues.html">ESGF Installer Issue Tracking Guidelines</a></li>
</ul>
<p class="caption"><span class="caption-text">Contributing</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../contribute_docs.html">Contributing to Documentation</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">esgf-installer</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Module code</a> &raquo;</li>
        
      <li>esg_functions</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for esg_functions</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/local/env python</span>
<span class="sd">&#39;&#39;&#39; esg-functions: ESGF Node Application Stack Functions</span>
<span class="sd">    description: Installer Functions for the ESGF Node application stack</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">tarfile</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">shlex</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">errno</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">pwd</span>
<span class="kn">import</span> <span class="nn">grp</span>
<span class="kn">import</span> <span class="nn">stat</span>
<span class="kn">import</span> <span class="nn">getpass</span>
<span class="kn">import</span> <span class="nn">ConfigParser</span>
<span class="kn">from</span> <span class="nn">distutils.spawn</span> <span class="k">import</span> <span class="n">find_executable</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">yaml</span>
<span class="kn">import</span> <span class="nn">netifaces</span>
<span class="kn">from</span> <span class="nn">clint.textui</span> <span class="k">import</span> <span class="n">progress</span>
<span class="kn">from</span> <span class="nn">lxml</span> <span class="k">import</span> <span class="n">etree</span>
<span class="kn">from</span> <span class="nn">esg_exceptions</span> <span class="k">import</span> <span class="n">UnverifiedScriptError</span><span class="p">,</span> <span class="n">SubprocessError</span><span class="p">,</span> <span class="n">NoNodeTypeError</span>
<span class="kn">import</span> <span class="nn">pybash</span>
<span class="kn">import</span> <span class="nn">esg_property_manager</span>
<span class="kn">from</span> <span class="nn">plumbum</span> <span class="k">import</span> <span class="n">local</span>
<span class="kn">from</span> <span class="nn">plumbum</span> <span class="k">import</span> <span class="n">TEE</span>
<span class="kn">from</span> <span class="nn">plumbum</span> <span class="k">import</span> <span class="n">BG</span>
<span class="kn">from</span> <span class="nn">plumbum.commands</span> <span class="k">import</span> <span class="n">ProcessExecutionError</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">,</span> <span class="s1">&#39;esg_config.yaml&#39;</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">config_file</span><span class="p">:</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">config_file</span><span class="p">)</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;esgf_logger&quot;</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="vm">__name__</span><span class="p">)</span>



<span class="c1">#----------------------------------------------------------</span>
<span class="c1"># Process Launching and Checking...</span>
<span class="c1">#----------------------------------------------------------</span>


<div class="viewcode-block" id="get_md5sum"><a class="viewcode-back" href="../api.html#esg_functions.get_md5sum">[docs]</a><span class="k">def</span> <span class="nf">get_md5sum</span><span class="p">(</span><span class="n">file_name</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        #Utility function, wraps md5sum so it may be used on either mac or</span>
<span class="sd">        #linux machines</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">hasher</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">()</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file_handle</span><span class="p">:</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="n">file_handle</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">hasher</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
        <span class="n">file_name_md5</span> <span class="o">=</span> <span class="n">hasher</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;local_file_md5 : </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file_name_md5</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">file_name_md5</span></div>


<div class="viewcode-block" id="get_md5sum_password"><a class="viewcode-back" href="../api.html#esg_functions.get_md5sum_password">[docs]</a><span class="k">def</span> <span class="nf">get_md5sum_password</span><span class="p">(</span><span class="n">password</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Hash a password to get it&#39;s md5 value &#39;&#39;&#39;</span>
    <span class="n">password_hasher</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">()</span>
    <span class="n">password_hasher</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">password_hasher</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span></div>
<span class="c1">#----------------------------------------------------------</span>
<span class="c1"># Path munging...</span>
<span class="c1">#----------------------------------------------------------</span>


<div class="viewcode-block" id="path_unique"><a class="viewcode-back" href="../api.html#esg_functions.path_unique">[docs]</a><span class="k">def</span> <span class="nf">path_unique</span><span class="p">(</span><span class="n">path_string</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;PATH&quot;</span><span class="p">],</span> <span class="n">path_separator</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Prints a unique path string</span>

<span class="sd">        The first (leftmost) instance of a path entry will be the one that</span>
<span class="sd">        is preserved.</span>

<span class="sd">        If $1 is specified, it will be taken as the string to deduplicate,</span>
<span class="sd">        otherwise $PATH is used.</span>

<span class="sd">        If $2 is specified, it will be taken as the path separator, which</span>
<span class="sd">        otherwise defaults to &#39;:&#39;</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">split_path</span> <span class="o">=</span> <span class="n">path_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">path_separator</span><span class="p">)</span>
    <span class="k">return</span> <span class="s2">&quot;:&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">split_path</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="n">split_path</span><span class="o">.</span><span class="n">index</span><span class="p">))</span></div>

<div class="viewcode-block" id="readlinkf"><a class="viewcode-back" href="../api.html#esg_functions.readlinkf">[docs]</a><span class="k">def</span> <span class="nf">readlinkf</span><span class="p">(</span><span class="n">file_name</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This is a portable implementation of GNU&#39;s &quot;readlink -f&quot; in</span>
<span class="sd">    bash/zsh, following symlinks recursively until they end in a</span>
<span class="sd">    file, and will print the full dereferenced path of the specified</span>
<span class="sd">    file even if the file isn&#39;t a symlink.</span>

<span class="sd">    Loop detection exists, but only as an abort after passing a</span>
<span class="sd">    maximum length.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span></div>

<span class="c1">#----------------------------------------------------------</span>
<span class="c1"># File reading and writing...</span>
<span class="c1">#----------------------------------------------------------</span>


<div class="viewcode-block" id="prefix_to_path"><a class="viewcode-back" href="../api.html#esg_functions.prefix_to_path">[docs]</a><span class="k">def</span> <span class="nf">prefix_to_path</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">prepend_value</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Prepends path components to a variable, deduplicates the list,</span>
<span class="sd">        then prints to stdout the export command required to prepend</span>
<span class="sd">        that list to that variable.</span>

<span class="sd">        Takes as arguments first a variable containing a colon-separated</span>
<span class="sd">        path to prepend to, then a space-separated collection of paths to</span>
<span class="sd">        prepend -- these path components MUST NOT contain spaces.</span>

<span class="sd">        If insufficient arguments are present, a warning message is</span>
<span class="sd">        printed to stderr and nothing is printed to stdout.</span>

<span class="sd">        Example:</span>
<span class="sd">          prefix_to_path LD_LIBRARY_PATH /foo/lib /bar/lib</span>

<span class="sd">          Would result in the entry:</span>
<span class="sd">            export LD_LIBRARY_PATH=/foo/lib:/bar/lib:$LD_LIBRARY_PATH</span>

<span class="sd">        NOTE: In the context of system setup this is usually</span>
<span class="sd">              WHAT YOU WANT; that your libs are found before any user libs are</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1">#TODO: Use sys.path.insert</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">path</span><span class="p">]</span> <span class="o">=</span> <span class="n">path_unique</span><span class="p">(</span><span class="n">prepend_value</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="n">path</span>
    <span class="k">return</span> <span class="n">path_unique</span><span class="p">(</span><span class="n">prepend_value</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="n">path</span></div>


<div class="viewcode-block" id="backup"><a class="viewcode-back" href="../api.html#esg_functions.backup">[docs]</a><span class="k">def</span> <span class="nf">backup</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">backup_dir</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;esg_backup_dir&quot;</span><span class="p">],</span> <span class="n">num_of_backups</span><span class="o">=</span><span class="mi">7</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Given a directory the contents of the directory is backed up as a tar.gz file in</span>
<span class="sd">        path - a filesystem path</span>
<span class="sd">        backup_dir - destination directory for putting backup archive (default esg_backup_dir:-/esg/backups)</span>
<span class="sd">        num_of_backups - the number of backup files you wish to have present in destination directory (default num_backups_to_keep:-7)</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">source_directory</span> <span class="o">=</span> <span class="n">readlinkf</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Backup - Creating a backup archive of </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">source_directory</span><span class="p">)</span>
    <span class="n">current_directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>

    <span class="n">source_backup_name</span> <span class="o">=</span> <span class="n">source_directory</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">backup_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">backup_dir</span><span class="p">,</span> <span class="n">source_backup_name</span><span class="o">+</span><span class="s2">&quot;.</span><span class="si">{}</span><span class="s2">.tgz&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">())))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">backup_filename</span><span class="p">,</span> <span class="s2">&quot;w:gz&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">tar</span><span class="p">:</span>
            <span class="n">tar</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">source_directory</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">TarError</span><span class="p">,</span> <span class="n">error</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Problem with creating backup archive: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">backup_filename</span><span class="p">)</span>
        <span class="k">raise</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Created backup: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">backup_filename</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">pybash</span><span class="o">.</span><span class="n">pushd</span><span class="p">(</span><span class="n">backup_dir</span><span class="p">):</span>
        <span class="n">files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">backup_dir</span><span class="p">,</span> <span class="n">source_backup_name</span><span class="o">+</span><span class="s2">&quot;*&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">num_of_backups</span><span class="p">:</span>
            <span class="n">oldest_backup</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getctime</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">oldest_backup</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_parent_directory"><a class="viewcode-back" href="../api.html#esg_functions.get_parent_directory">[docs]</a><span class="k">def</span> <span class="nf">get_parent_directory</span><span class="p">(</span><span class="n">directory_path</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Returns the parent directory of directory_path&#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory_path</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">))</span></div>


<div class="viewcode-block" id="is_in_git_repo"><a class="viewcode-back" href="../api.html#esg_functions.is_in_git_repo">[docs]</a><span class="k">def</span> <span class="nf">is_in_git_repo</span><span class="p">(</span><span class="n">file_name</span><span class="p">):</span>
    <span class="c1">#TODO: this may get deprecated as we are moving most things to live in repos</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">     This determines if a specified file is in a git repository.</span>
<span class="sd">     This function will resolve symlinks and check for a .git</span>
<span class="sd">     directory in the directory of the actual file as well as its</span>
<span class="sd">     parent to avoid attempting to call git unless absolutely needed,</span>
<span class="sd">     so as to be able to detect some common cases on a system without</span>
<span class="sd">     git actually installed and in the path.</span>

<span class="sd">     Accepts as an argument the file to be checked</span>

<span class="sd">     Returns True if the specified file is in a git repository</span>

<span class="sd">     Returns False otherwise</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">find_executable</span><span class="p">(</span><span class="s2">&quot;git&quot;</span><span class="p">):</span>
        <span class="nb">print</span> <span class="s2">&quot;Git is not installed&quot;</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Checking to see if </span><span class="si">%s</span><span class="s2"> is in a git repository...&quot;</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
    <span class="n">absolute_path</span> <span class="o">=</span> <span class="n">readlinkf</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
    <span class="n">one_directory_up</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">absolute_path</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">))</span>
    <span class="n">two_directories_up</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">one_directory_up</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">file_name</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> does not exist yet, allowing creation&quot;</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">one_directory_up</span> <span class="o">+</span> <span class="s2">&quot;/.git&quot;</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> is in a git repository&quot;</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">two_directories_up</span> <span class="o">+</span> <span class="s2">&quot;/.git&quot;</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> is in a git repository&quot;</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="check_for_update"><a class="viewcode-back" href="../api.html#esg_functions.check_for_update">[docs]</a><span class="k">def</span> <span class="nf">check_for_update</span><span class="p">(</span><span class="n">filename_1</span><span class="p">,</span> <span class="n">filename_2</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">         Does an md5 check between local and remote resource</span>
<span class="sd">         returns 0 (success) iff there is no match and thus indicating that</span>
<span class="sd">         an update is available.</span>
<span class="sd">         USAGE: checked_for_update [file] http://www.foo.com/file</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="n">filename_2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">remote_file</span> <span class="o">=</span> <span class="n">filename_1</span>
        <span class="n">local_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\w+-\w+$&quot;</span><span class="p">,</span> <span class="n">filename_1</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">())</span>
        <span class="n">local_file</span> <span class="o">=</span> <span class="n">local_file</span> <span class="o">+</span> <span class="s2">&quot;.py&quot;</span>
        <span class="n">local_file</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\-(?=[^-]*$)&#39;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="n">local_file</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">local_file</span> <span class="o">=</span> <span class="n">filename_1</span>
        <span class="n">remote_file</span> <span class="o">=</span> <span class="n">filename_2</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">local_file</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Could not find local file </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">local_file</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">local_file</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">X_OK</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">local_file</span><span class="p">,</span> <span class="mi">0755</span><span class="p">)</span>

    <span class="n">remote_file_md5</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">remote_file</span> <span class="o">+</span> <span class="s1">&#39;.md5&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">content</span>
    <span class="n">remote_file_md5</span> <span class="o">=</span> <span class="n">remote_file_md5</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">local_file_md5</span> <span class="o">=</span> <span class="n">get_md5sum</span><span class="p">(</span><span class="n">local_file</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">local_file_md5</span> <span class="o">!=</span> <span class="n">remote_file_md5</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s2">&quot; Update Available @ </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">remote_file</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="mi">1</span></div>

<span class="c1">#TODO: rename to download_from_mirror</span>
<div class="viewcode-block" id="download_update"><a class="viewcode-back" href="../api.html#esg_functions.download_update">[docs]</a><span class="k">def</span> <span class="nf">download_update</span><span class="p">(</span><span class="n">local_file</span><span class="p">,</span> <span class="n">remote_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">force_download</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">make_backup_file</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">use_local_files</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>

<span class="sd">    If an update is available then pull it down... then check the md5 sums again!</span>

<span class="sd">    Yes, this results in 3 network calls to pull down a file, but it</span>
<span class="sd">    saves total bandwidth and it also allows the updating from the</span>
<span class="sd">    network process to be cronttab-able while parsimonious with</span>
<span class="sd">    resources.  It is also very good practice to make sure that code</span>
<span class="sd">    being executed is the RIGHT code!</span>

<span class="sd">    The 3rd token is the &quot;force&quot; flag value 1|0.</span>
<span class="sd">    1 = do not check for update, directly go and fetch the file regardless</span>
<span class="sd">    0 = first check for update availability. (default)</span>

<span class="sd">    The 4th token is for indicated whether a backup file should be made flag value 1|0.</span>
<span class="sd">    1 = yes, create a .bak file if the file is already there before fetching new</span>
<span class="sd">    0 = no, do NOT make a .bak file even if the file is already there, overwrite it</span>

<span class="sd">    (When using the force flag you MUST specify the first two args!!)</span>

<span class="sd">    NOTE: Has multiple return values test for (( $? &gt; 1 )) when looking or errors</span>
<span class="sd">       A return value of 1 only means that the file is up-to-date and there</span>
<span class="sd">       Is no reason to fetch it.</span>

<span class="sd">    USAGE: checked_get [file] http://www.foo.com/file [&lt;1|0&gt;] [&lt;1|0&gt;]</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="n">remote_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">remote_file</span> <span class="o">=</span> <span class="n">local_file</span>
        <span class="c1"># Get the last subpath from the absolute path</span>
        <span class="c1"># TODO: use pybash.trim_from_head() here</span>
        <span class="n">local_file</span> <span class="o">=</span> <span class="n">local_file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">is_in_git_repo</span><span class="p">(</span><span class="n">local_file</span><span class="p">):</span>
        <span class="nb">print</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> is controlled by Git, not updating&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">local_file</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">local_file</span><span class="p">)</span> <span class="ow">and</span> <span class="n">use_local_files</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">            ***************************************************************************</span>
<span class="s1">            ALERT....</span>
<span class="s1">            NOT FETCHING ANY ESGF UPDATES FROM DISTRIBUTION SERVER!!!! USING LOCAL FILE</span>
<span class="s1">            file: </span><span class="si">%s</span><span class="s1"></span>
<span class="s1">            ***************************************************************************</span><span class="se">\n\n</span><span class="s1"></span>
<span class="s1">        &#39;&#39;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">readlinkf</span><span class="p">(</span><span class="n">local_file</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">force_download</span><span class="p">:</span>
        <span class="n">updates_available</span> <span class="o">=</span> <span class="n">check_for_update</span><span class="p">(</span><span class="n">local_file</span><span class="p">,</span> <span class="n">remote_file</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">updates_available</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No updates available.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">local_file</span><span class="p">)</span> <span class="ow">and</span> <span class="n">make_backup_file</span><span class="p">:</span>
        <span class="n">create_backup_file</span><span class="p">(</span><span class="n">local_file</span><span class="p">)</span>

    <span class="nb">print</span> <span class="s2">&quot;Fetching file from </span><span class="si">%s</span><span class="s2"> -to-&gt; </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">remote_file</span><span class="p">,</span> <span class="n">local_file</span><span class="p">)</span>
    <span class="n">fetch_remote_file</span><span class="p">(</span><span class="n">local_file</span><span class="p">,</span> <span class="n">remote_file</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">verify_checksum</span><span class="p">(</span><span class="n">local_file</span><span class="p">,</span> <span class="n">remote_file</span><span class="p">)</span></div>


<div class="viewcode-block" id="fetch_remote_file"><a class="viewcode-back" href="../api.html#esg_functions.fetch_remote_file">[docs]</a><span class="k">def</span> <span class="nf">fetch_remote_file</span><span class="p">(</span><span class="n">local_file</span><span class="p">,</span> <span class="n">remote_file</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Download a remote file from a distribution mirror and write its contents to the local_file &#39;&#39;&#39;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">remote_file_request</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">remote_file</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">remote_file_request</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">local_file</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">downloaded_file</span><span class="p">:</span>
            <span class="n">total_length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">remote_file_request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content-length&#39;</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">progress</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">remote_file_request</span><span class="o">.</span><span class="n">iter_content</span><span class="p">(</span><span class="n">chunk_size</span><span class="o">=</span><span class="mi">1024</span><span class="p">),</span> <span class="n">expected_size</span><span class="o">=</span><span class="p">(</span><span class="n">total_length</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">chunk</span><span class="p">:</span>
                    <span class="n">downloaded_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
                    <span class="n">downloaded_file</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">RequestException</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Could not download </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">remote_file</span><span class="p">)</span>
        <span class="k">raise</span></div>


<div class="viewcode-block" id="create_backup_file"><a class="viewcode-back" href="../api.html#esg_functions.create_backup_file">[docs]</a><span class="k">def</span> <span class="nf">create_backup_file</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">backup_extension</span><span class="o">=</span><span class="s2">&quot;.bak&quot;</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">())):</span>
    <span class="sd">&#39;&#39;&#39;Create a backup of a file using the given backup extension&#39;&#39;&#39;</span>
    <span class="n">backup_file_name</span> <span class="o">=</span> <span class="n">file_name</span> <span class="o">+</span> <span class="n">date</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span><span class="o">+</span> <span class="n">backup_extension</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">backup_file_name</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">backup_file_name</span><span class="p">,</span> <span class="mi">600</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Could not create backup file: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">backup_file_name</span><span class="p">)</span></div>


<div class="viewcode-block" id="verify_checksum"><a class="viewcode-back" href="../api.html#esg_functions.verify_checksum">[docs]</a><span class="k">def</span> <span class="nf">verify_checksum</span><span class="p">(</span><span class="n">local_file</span><span class="p">,</span> <span class="n">remote_file</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Verify md5 checksum of file downloaded from distribution mirror&#39;&#39;&#39;</span>
    <span class="n">remote_file_md5</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">remote_file</span> <span class="o">+</span> <span class="s1">&#39;.md5&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">content</span>
    <span class="n">remote_file_md5</span> <span class="o">=</span> <span class="n">remote_file_md5</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="n">local_file_md5</span> <span class="o">=</span> <span class="n">get_md5sum</span><span class="p">(</span><span class="n">local_file</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">local_file_md5</span> <span class="o">!=</span> <span class="n">remote_file_md5</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Could not verify this file! </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">local_file</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> checksum [VERIFIED]&quot;</span><span class="p">,</span> <span class="n">local_file</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span></div>


<span class="k">def</span> <span class="nf">_verify_against_mirror</span><span class="p">(</span><span class="n">esg_dist_url_root</span><span class="p">,</span> <span class="n">script_maj_version</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Verify that the local script matches the remote script on the distribution mirror &#39;&#39;&#39;</span>
    <span class="n">python_script_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span>
    <span class="n">python_script_md5_name</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">python_script_name</span><span class="p">)</span>
    <span class="n">python_script_md5_name</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\w*-\w*&quot;</span><span class="p">,</span> <span class="n">python_script_md5_name</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;python_script_name: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">python_script_md5_name</span><span class="p">)</span>

    <span class="n">remote_file_md5</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{esg_dist_url_root}</span><span class="s2">/esgf-installer/</span><span class="si">{script_maj_version}</span><span class="s2">/</span><span class="si">{python_script_md5_name}</span><span class="s2">.md5&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">esg_dist_url_root</span><span class="o">=</span><span class="n">esg_dist_url_root</span><span class="p">,</span> <span class="n">script_maj_version</span><span class="o">=</span><span class="n">script_maj_version</span><span class="p">,</span> <span class="n">python_script_md5_name</span><span class="o">=</span><span class="n">python_script_md5_name</span><span class="p">))</span><span class="o">.</span><span class="n">content</span>
    <span class="n">remote_file_md5</span> <span class="o">=</span> <span class="n">remote_file_md5</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="n">local_file_md5</span> <span class="o">=</span> <span class="n">get_md5sum</span><span class="p">(</span><span class="n">python_script_name</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">local_file_md5</span> <span class="o">!=</span> <span class="n">remote_file_md5</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">UnverifiedScriptError</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s2">&quot;[VERIFIED]&quot;</span>
        <span class="k">return</span> <span class="kc">True</span>


<div class="viewcode-block" id="stream_subprocess_output"><a class="viewcode-back" href="../api.html#esg_functions.stream_subprocess_output">[docs]</a><span class="k">def</span> <span class="nf">stream_subprocess_output</span><span class="p">(</span><span class="n">command_string</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Print out the stdout of the subprocess in real time &#39;&#39;&#39;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Streaming subprocess stdout&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Raw command string: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">command_string</span><span class="p">)</span>
        <span class="n">shlexsplit</span> <span class="o">=</span> <span class="n">shlex</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">command_string</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;shlex.split </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">shlexsplit</span><span class="p">))</span>
        <span class="n">process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">shlexsplit</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">process</span><span class="o">.</span><span class="n">stdout</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">iter</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">readline</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
                <span class="nb">print</span> <span class="n">line</span><span class="p">,</span>
        <span class="c1"># wait for the subprocess to exit</span>
        <span class="n">process</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SubprocessError</span><span class="p">({</span><span class="s2">&quot;stdout&quot;</span><span class="p">:</span> <span class="n">process</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="s2">&quot;stderr&quot;</span><span class="p">:</span> <span class="n">process</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s2">&quot;returncode&quot;</span><span class="p">:</span> <span class="n">process</span><span class="o">.</span><span class="n">returncode</span><span class="p">})</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">),</span> <span class="n">error</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s2">&quot;Could not stream subprocess output&quot;</span>
        <span class="nb">print</span> <span class="s2">&quot;stream_subprocess_output error:&quot;</span><span class="p">,</span> <span class="n">error</span>
        <span class="k">raise</span></div>

<div class="viewcode-block" id="call_subprocess"><a class="viewcode-back" href="../api.html#esg_functions.call_subprocess">[docs]</a><span class="k">def</span> <span class="nf">call_subprocess</span><span class="p">(</span><span class="n">command_string</span><span class="p">,</span> <span class="n">command_stdin</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Mimics subprocess.call; Need this on CentOS 6 because system Python is 2.6, which doesn&#39;t have subprocess.call() &#39;&#39;&#39;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;command_string: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">command_string</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">command_process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">shlex</span><span class="o">.</span><span class="n">split</span><span class="p">(</span>
            <span class="n">command_string</span><span class="p">),</span> <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">command_stdin</span><span class="p">:</span>
            <span class="n">command_process_stdout</span><span class="p">,</span> <span class="n">command_process_stderr</span> <span class="o">=</span> <span class="n">command_process</span><span class="o">.</span><span class="n">communicate</span><span class="p">(</span>
                <span class="nb">input</span><span class="o">=</span><span class="n">command_stdin</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">command_process_stdout</span><span class="p">,</span> <span class="n">command_process_stderr</span> <span class="o">=</span> <span class="n">command_process</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">),</span> <span class="n">error</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">SubprocessError</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;command_process_stdout: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">command_process_stdout</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;command_process_stderr: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">command_process_stderr</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;command_process.returncode: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">command_process</span><span class="o">.</span><span class="n">returncode</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">command_process</span><span class="o">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SubprocessError</span><span class="p">({</span><span class="s2">&quot;stdout&quot;</span><span class="p">:</span> <span class="n">command_process_stdout</span><span class="p">,</span> <span class="s2">&quot;stderr&quot;</span><span class="p">:</span> <span class="n">command_process_stderr</span><span class="p">,</span> <span class="s2">&quot;returncode&quot;</span><span class="p">:</span> <span class="n">command_process</span><span class="o">.</span><span class="n">returncode</span><span class="p">})</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;stdout&quot;</span><span class="p">:</span> <span class="n">command_process_stdout</span><span class="p">,</span> <span class="s2">&quot;stderr&quot;</span><span class="p">:</span> <span class="n">command_process_stderr</span><span class="p">,</span> <span class="s2">&quot;returncode&quot;</span><span class="p">:</span> <span class="n">command_process</span><span class="o">.</span><span class="n">returncode</span><span class="p">}</span></div>

<div class="viewcode-block" id="check_shmmax"><a class="viewcode-back" href="../api.html#esg_functions.check_shmmax">[docs]</a><span class="k">def</span> <span class="nf">check_shmmax</span><span class="p">(</span><span class="n">min_shmmax</span><span class="o">=</span><span class="mi">48</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">       NOTE: This is another **RedHat/CentOS** specialty thing (sort of)</span>
<span class="sd">       arg1 - min value of shmmax in MB (see: /etc/sysctl.conf)</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">kernel_shmmax</span> <span class="o">=</span> <span class="n">esg_property_manager</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s2">&quot;kernel.shmmax&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">ConfigParser</span><span class="o">.</span><span class="n">NoOptionError</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="n">set_value_mb</span> <span class="o">=</span> <span class="n">min_shmmax</span>
    <span class="n">set_value_bytes</span> <span class="o">=</span> <span class="n">set_value_mb</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span>
    <span class="n">kernel_shmmax_setting</span> <span class="o">=</span> <span class="n">call_binary</span><span class="p">(</span><span class="s2">&quot;sysctl&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;-q&quot;</span><span class="p">,</span> <span class="s2">&quot;kernel.shmmax&quot;</span><span class="p">])</span>
    <span class="n">cur_value_bytes</span> <span class="o">=</span> <span class="n">kernel_shmmax_setting</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">cur_value_bytes</span> <span class="o">=</span> <span class="n">cur_value_bytes</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">cur_value_bytes</span> <span class="o">&lt;</span> <span class="n">set_value_bytes</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s2">&quot;Current system shared mem value too low [</span><span class="si">{cur_value_bytes}</span><span class="s2"> bytes] changing to [</span><span class="si">{set_value_bytes}</span><span class="s2"> bytes]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cur_value_bytes</span><span class="o">=</span><span class="n">cur_value_bytes</span><span class="p">,</span> <span class="n">set_value_bytes</span><span class="o">=</span><span class="n">set_value_bytes</span><span class="p">)</span>
        <span class="n">call_binary</span><span class="p">(</span><span class="s2">&quot;sysctl&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;-w&quot;</span><span class="p">,</span> <span class="s2">&quot;kernel.shmmax=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">set_value_bytes</span><span class="p">)])</span>
        <span class="n">replace_string_in_file</span><span class="p">(</span><span class="s2">&quot;/etc/sysctl.conf&quot;</span><span class="p">,</span> <span class="n">kernel_shmmax_setting</span><span class="p">,</span> <span class="s2">&quot;kernel.shmmax=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">set_value_bytes</span><span class="p">))</span>
        <span class="n">esg_property_manager</span><span class="o">.</span><span class="n">set_property</span><span class="p">(</span><span class="s2">&quot;kernal_shmmax&quot;</span><span class="p">,</span> <span class="n">set_value_mb</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_esgf_host"><a class="viewcode-back" href="../api.html#esg_functions.get_esgf_host">[docs]</a><span class="k">def</span> <span class="nf">get_esgf_host</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39; Get the esgf host name from the file; if not in file, return the fully qualified domain name (FQDN) &#39;&#39;&#39;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">esgf_host</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;esgf_host&quot;</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="n">esgf_host</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">getfqdn</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">esgf_host</span></div>


<div class="viewcode-block" id="get_security_admin_password"><a class="viewcode-back" href="../api.html#esg_functions.get_security_admin_password">[docs]</a><span class="k">def</span> <span class="nf">get_security_admin_password</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39; Gets the security_admin_password from the esgf_secret_file &#39;&#39;&#39;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;esgf_secret_file&quot;</span><span class="p">],</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">password_file</span><span class="p">:</span>
            <span class="n">security_admin_password</span> <span class="o">=</span> <span class="n">password_file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">IOError</span><span class="p">,</span> <span class="n">error</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">error</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">ENOENT</span><span class="p">:</span>
            <span class="k">raise</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Could not get password from file&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">security_admin_password</span></div>


<div class="viewcode-block" id="set_security_admin_password"><a class="viewcode-back" href="../api.html#esg_functions.set_security_admin_password">[docs]</a><span class="k">def</span> <span class="nf">set_security_admin_password</span><span class="p">(</span><span class="n">updated_password</span><span class="p">,</span> <span class="n">password_file</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;esgf_secret_file&#39;</span><span class="p">]):</span>
    <span class="c1"># TODO: Rename esgf_secret_file to esgf_admin_password_file</span>
    <span class="sd">&#39;&#39;&#39;Updates the esgf_secret_file&#39;&#39;&#39;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">security_admin_password_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">password_file</span><span class="p">,</span> <span class="s1">&#39;w+&#39;</span><span class="p">)</span>
        <span class="n">security_admin_password_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">updated_password</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Unable to update security_admin_password file: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">password_file</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">security_admin_password_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">get_tomcat_group_id</span><span class="p">():</span>
        <span class="n">add_unix_group</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;tomcat_group&quot;</span><span class="p">])</span>
    <span class="n">tomcat_group_id</span> <span class="o">=</span> <span class="n">get_tomcat_group_id</span><span class="p">()</span>

    <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;esgf_secret_file&#39;</span><span class="p">],</span> <span class="mi">0640</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chown</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;esgf_secret_file&#39;</span><span class="p">],</span> <span class="n">get_user_id</span><span class="p">(</span><span class="s2">&quot;root&quot;</span><span class="p">),</span> <span class="n">tomcat_group_id</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Unable to change ownership of </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">password_file</span><span class="p">)</span>

    <span class="c1"># Use the same password when creating the postgress account and publisher accounts</span>
    <span class="n">set_postgres_password</span><span class="p">(</span><span class="n">updated_password</span><span class="p">)</span>
    <span class="n">set_publisher_password</span><span class="p">(</span><span class="n">updated_password</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_publisher_password"><a class="viewcode-back" href="../api.html#esg_functions.get_publisher_password">[docs]</a><span class="k">def</span> <span class="nf">get_publisher_password</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;Gets the publisher database user&#39;s password&#39;&#39;&#39;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;pub_secret_file&#39;</span><span class="p">],</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">secret_file</span><span class="p">:</span>
            <span class="n">publisher_db_user_passwd</span> <span class="o">=</span> <span class="n">secret_file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">publisher_db_user_passwd</span>
    <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> not found&quot;</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;pub_secret_file&#39;</span><span class="p">])</span>
        <span class="k">raise</span></div>


<div class="viewcode-block" id="set_publisher_password"><a class="viewcode-back" href="../api.html#esg_functions.set_publisher_password">[docs]</a><span class="k">def</span> <span class="nf">set_publisher_password</span><span class="p">(</span><span class="n">password</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Sets the publisher database user&#39;s password; saves it to pub_secret_file</span>
<span class="sd">       If not password is provided as an argument, a prompt for a password is given.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">password</span><span class="p">:</span>
        <span class="n">password_set</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">password_set</span><span class="p">:</span>
            <span class="n">db_user_password</span> <span class="o">=</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getpass</span><span class="p">(</span>
                <span class="s2">&quot;Enter the password for database user </span><span class="si">{db_user}</span><span class="s2">: &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">db_user</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;postgress_user&quot;</span><span class="p">]))</span>
            <span class="n">db_user_password_confirm</span> <span class="o">=</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getpass</span><span class="p">(</span><span class="s2">&quot;Re-enter the password to confirm: &quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">confirm_password</span><span class="p">(</span><span class="n">db_user_password</span><span class="p">,</span> <span class="n">db_user_password_confirm</span><span class="p">):</span>
                <span class="n">password</span> <span class="o">=</span> <span class="n">db_user_password</span>
                <span class="n">password_set</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;pub_secret_file&#39;</span><span class="p">],</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">secret_file</span><span class="p">:</span>
            <span class="n">secret_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
        <span class="nb">print</span> <span class="s2">&quot;Updated password for database </span><span class="si">{db_user}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">db_user</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;postgress_user&quot;</span><span class="p">])</span>
    <span class="k">except</span> <span class="ne">IOError</span><span class="p">,</span> <span class="n">error</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Could not update password for </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;postgress_user&quot;</span><span class="p">])</span>
        <span class="k">raise</span></div>


<div class="viewcode-block" id="set_postgres_password"><a class="viewcode-back" href="../api.html#esg_functions.set_postgres_password">[docs]</a><span class="k">def</span> <span class="nf">set_postgres_password</span><span class="p">(</span><span class="n">password</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Updates the Postgres superuser account password; gets saved to /esg/config/.esg_pg_pass&#39;&#39;&#39;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;pg_secret_file&#39;</span><span class="p">],</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">secret_file</span><span class="p">:</span>
            <span class="n">secret_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Could not open </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;pg_secret_file&#39;</span><span class="p">])</span>

    <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;pg_secret_file&#39;</span><span class="p">],</span> <span class="mi">0640</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">get_tomcat_group_id</span><span class="p">():</span>
        <span class="n">add_unix_group</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;tomcat_group&quot;</span><span class="p">])</span>
    <span class="n">tomcat_group_id</span> <span class="o">=</span> <span class="n">get_tomcat_group_id</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chown</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;pg_secret_file&#39;</span><span class="p">],</span> <span class="n">get_user_id</span><span class="p">(</span><span class="s2">&quot;root&quot;</span><span class="p">),</span> <span class="n">tomcat_group_id</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Unable to change ownership of </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;pg_secret_file&quot;</span><span class="p">])</span></div>


<div class="viewcode-block" id="get_postgres_password"><a class="viewcode-back" href="../api.html#esg_functions.get_postgres_password">[docs]</a><span class="k">def</span> <span class="nf">get_postgres_password</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;Gets the Postgres superuser account password from /esg/config/.esg_pg_pass&#39;&#39;&#39;</span>
    <span class="n">pg_password</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;pg_secret_file&#39;</span><span class="p">],</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">secret_file</span><span class="p">:</span>
            <span class="n">pg_password</span> <span class="o">=</span> <span class="n">secret_file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Could not open </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;pg_secret_file&#39;</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">pg_password</span></div>


<div class="viewcode-block" id="confirm_password"><a class="viewcode-back" href="../api.html#esg_functions.confirm_password">[docs]</a><span class="k">def</span> <span class="nf">confirm_password</span><span class="p">(</span><span class="n">password_input</span><span class="p">,</span> <span class="n">password_confirmation</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Helper function to confirm that passwords match.</span>
<span class="sd">       Returns true if passwords match&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">password_confirmation</span> <span class="o">==</span> <span class="n">password_input</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s2">&quot;Sorry, values did not match&quot;</span>
        <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="is_valid_password"><a class="viewcode-back" href="../api.html#esg_functions.is_valid_password">[docs]</a><span class="k">def</span> <span class="nf">is_valid_password</span><span class="p">(</span><span class="n">password_input</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Check that password_input meets the valid password requirements:</span>
<span class="sd">    an alphanumeric string greater than 6 characters long&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">password_input</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s2">&quot;Password cannot be blank&quot;</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">str</span><span class="o">.</span><span class="n">isalnum</span><span class="p">(</span><span class="n">password_input</span><span class="p">):</span>
        <span class="nb">print</span> <span class="s2">&quot;The password can only contain alphanumeric characters&quot;</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">password_input</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s2">&quot;Sorry password must be at least six characters :-( &quot;</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="set_java_keystore_password"><a class="viewcode-back" href="../api.html#esg_functions.set_java_keystore_password">[docs]</a><span class="k">def</span> <span class="nf">set_java_keystore_password</span><span class="p">(</span><span class="n">keystore_password</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Saves the password for a Java keystore to /esg/config/.esg_keystore_pass&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">keystore_password</span><span class="p">:</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">keystore_password_input</span> <span class="o">=</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getpass</span><span class="p">(</span>
                <span class="s2">&quot;Please enter the password for this keystore: &quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">keystore_password_input</span><span class="p">:</span>
                <span class="nb">print</span> <span class="s2">&quot;Invalid password. The password can not be blank.&quot;</span>
                <span class="k">continue</span>

            <span class="n">keystore_password_input_confirmation</span> <span class="o">=</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getpass</span><span class="p">(</span>
                <span class="s2">&quot;Please re-enter the password for this keystore: &quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">keystore_password_input</span> <span class="o">==</span> <span class="n">keystore_password_input_confirmation</span><span class="p">:</span>
                <span class="n">keystore_password</span> <span class="o">=</span> <span class="n">keystore_password_input</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span> <span class="s2">&quot;Sorry, values did not match. Please try again.&quot;</span>
                <span class="k">continue</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;ks_secret_file&#39;</span><span class="p">],</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">keystore_file</span><span class="p">:</span>
        <span class="n">keystore_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">keystore_password</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;ks_secret_file&#39;</span><span class="p">],</span> <span class="mi">0640</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chown</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;ks_secret_file&#39;</span><span class="p">],</span> <span class="n">get_user_id</span><span class="p">(</span><span class="s2">&quot;root&quot;</span><span class="p">),</span> <span class="n">get_group_id</span><span class="p">(</span><span class="s2">&quot;tomcat&quot;</span><span class="p">))</span>
    <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="get_java_keystore_password"><a class="viewcode-back" href="../api.html#esg_functions.get_java_keystore_password">[docs]</a><span class="k">def</span> <span class="nf">get_java_keystore_password</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39; Gets the keystore_password from the saved ks_secret_file at /esg/config/.esg_keystore_pass &#39;&#39;&#39;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;ks_secret_file&#39;</span><span class="p">],</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">keystore_file</span><span class="p">:</span>
            <span class="n">keystore_password</span> <span class="o">=</span> <span class="n">keystore_file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">keystore_password</span><span class="p">:</span>
            <span class="n">set_java_keystore_password</span><span class="p">()</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;ks_secret_file&#39;</span><span class="p">],</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">keystore_file</span><span class="p">:</span>
            <span class="n">keystore_password</span> <span class="o">=</span> <span class="n">keystore_file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">keystore_password</span>
    <span class="k">except</span> <span class="ne">IOError</span><span class="p">,</span> <span class="n">error</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">error</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">ENOENT</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;The keystore password has not been set yet so the password file </span><span class="si">%s</span><span class="s2"> does not exist yet.&quot;</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;ks_secret_file&#39;</span><span class="p">])</span>
        <span class="n">set_java_keystore_password</span><span class="p">()</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;ks_secret_file&#39;</span><span class="p">],</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">keystore_file</span><span class="p">:</span>
            <span class="n">keystore_password</span> <span class="o">=</span> <span class="n">keystore_file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">keystore_password</span></div>


<span class="k">def</span> <span class="nf">_check_keystore_password</span><span class="p">(</span><span class="n">keystore_password</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Utility function to check that a given password is valid for the global scoped {keystore_file} &#39;&#39;&#39;</span>
    <span class="n">keystore_password</span> <span class="o">=</span> <span class="n">get_java_keystore_password</span><span class="p">()</span>
    <span class="n">keytool_options</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;-list&quot;</span><span class="p">,</span> <span class="s2">&quot;-keystore&quot;</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;ks_secret_file&#39;</span><span class="p">],</span> <span class="s2">&quot;-storepass&quot;</span><span class="p">,</span> <span class="n">keystore_password</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">call_binary</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/bin/keytool&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;java_install_dir&quot;</span><span class="p">]),</span> <span class="n">keytool_options</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">ProcessExecutionError</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
            <span class="s2">&quot;Could not access private keystore </span><span class="si">%s</span><span class="s2"> with provided password. Try again...&quot;</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;ks_secret_file&#39;</span><span class="p">])</span>
        <span class="k">raise</span>
    <span class="k">return</span> <span class="kc">True</span>


<div class="viewcode-block" id="get_group_list"><a class="viewcode-back" href="../api.html#esg_functions.get_group_list">[docs]</a><span class="k">def</span> <span class="nf">get_group_list</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;Returns a list of the Unix groups on the system&#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">group</span><span class="o">.</span><span class="n">gr_name</span> <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">grp</span><span class="o">.</span><span class="n">getgrall</span><span class="p">()]</span></div>


<div class="viewcode-block" id="get_user_list"><a class="viewcode-back" href="../api.html#esg_functions.get_user_list">[docs]</a><span class="k">def</span> <span class="nf">get_user_list</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;Returns a list of the Unix users on the system&#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">user</span><span class="o">.</span><span class="n">pw_name</span> <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">pwd</span><span class="o">.</span><span class="n">getpwall</span><span class="p">()]</span></div>


<div class="viewcode-block" id="get_group_id"><a class="viewcode-back" href="../api.html#esg_functions.get_group_id">[docs]</a><span class="k">def</span> <span class="nf">get_group_id</span><span class="p">(</span><span class="n">group_name</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Returns the id of the Unix group &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">grp</span><span class="o">.</span><span class="n">getgrnam</span><span class="p">(</span><span class="n">group_name</span><span class="p">)</span><span class="o">.</span><span class="n">gr_gid</span></div>


<div class="viewcode-block" id="get_user_id"><a class="viewcode-back" href="../api.html#esg_functions.get_user_id">[docs]</a><span class="k">def</span> <span class="nf">get_user_id</span><span class="p">(</span><span class="n">user_name</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Returns the id of the Unix user &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">pwd</span><span class="o">.</span><span class="n">getpwnam</span><span class="p">(</span><span class="n">user_name</span><span class="p">)</span><span class="o">.</span><span class="n">pw_uid</span></div>


<div class="viewcode-block" id="get_tomcat_user_id"><a class="viewcode-back" href="../api.html#esg_functions.get_tomcat_user_id">[docs]</a><span class="k">def</span> <span class="nf">get_tomcat_user_id</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39; Returns the id of the Tomcat user &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">pwd</span><span class="o">.</span><span class="n">getpwnam</span><span class="p">(</span><span class="s2">&quot;tomcat&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">pw_uid</span></div>


<div class="viewcode-block" id="get_tomcat_group_id"><a class="viewcode-back" href="../api.html#esg_functions.get_tomcat_group_id">[docs]</a><span class="k">def</span> <span class="nf">get_tomcat_group_id</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39; Returns the id of the Tomcat group &#39;&#39;&#39;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">grp</span><span class="o">.</span><span class="n">getgrnam</span><span class="p">(</span><span class="s2">&quot;tomcat&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">gr_gid</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Could not get Tomcat group id&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="add_unix_group"><a class="viewcode-back" href="../api.html#esg_functions.add_unix_group">[docs]</a><span class="k">def</span> <span class="nf">add_unix_group</span><span class="p">(</span><span class="n">group_name</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Add a Unix group&#39;&#39;&#39;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">call_binary</span><span class="p">(</span><span class="s2">&quot;groupadd&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">group_name</span><span class="p">])</span>
    <span class="k">except</span> <span class="n">ProcessExecutionError</span><span class="p">,</span> <span class="n">err</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">err</span><span class="o">.</span><span class="n">retcode</span> <span class="o">==</span> <span class="mi">9</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span></div>

<div class="viewcode-block" id="add_unix_user"><a class="viewcode-back" href="../api.html#esg_functions.add_unix_user">[docs]</a><span class="k">def</span> <span class="nf">add_unix_user</span><span class="p">(</span><span class="n">user_add_options</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Use subprocess to add Unix user&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">user_add_options</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">user_add_options</span> <span class="o">=</span> <span class="p">[</span><span class="n">user_add_options</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">call_binary</span><span class="p">(</span><span class="s2">&quot;useradd&quot;</span><span class="p">,</span> <span class="n">user_add_options</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">ProcessExecutionError</span><span class="p">,</span> <span class="n">err</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">err</span><span class="o">.</span><span class="n">retcode</span> <span class="o">==</span> <span class="mi">9</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span></div>


<div class="viewcode-block" id="get_dir_owner_and_group"><a class="viewcode-back" href="../api.html#esg_functions.get_dir_owner_and_group">[docs]</a><span class="k">def</span> <span class="nf">get_dir_owner_and_group</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Returns a tuple containing the owner and group of the given directory path &#39;&#39;&#39;</span>
    <span class="n">stat_info</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">uid</span> <span class="o">=</span> <span class="n">stat_info</span><span class="o">.</span><span class="n">st_uid</span>
    <span class="n">gid</span> <span class="o">=</span> <span class="n">stat_info</span><span class="o">.</span><span class="n">st_gid</span>

    <span class="n">user</span> <span class="o">=</span> <span class="n">pwd</span><span class="o">.</span><span class="n">getpwuid</span><span class="p">(</span><span class="n">uid</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">group</span> <span class="o">=</span> <span class="n">grp</span><span class="o">.</span><span class="n">getgrgid</span><span class="p">(</span><span class="n">gid</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">user</span><span class="p">,</span> <span class="n">group</span></div>


<div class="viewcode-block" id="track_extraction_progress"><a class="viewcode-back" href="../api.html#esg_functions.track_extraction_progress">[docs]</a><span class="k">def</span> <span class="nf">track_extraction_progress</span><span class="p">(</span><span class="n">members</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Output of the files being extracted from a tarball&#39;&#39;&#39;</span>
    <span class="k">for</span> <span class="n">member</span> <span class="ow">in</span> <span class="n">members</span><span class="p">:</span>
        <span class="c1"># this will be the current file being extracted</span>
        <span class="k">yield</span> <span class="n">member</span></div>


<div class="viewcode-block" id="extract_tarball"><a class="viewcode-back" href="../api.html#esg_functions.extract_tarball">[docs]</a><span class="k">def</span> <span class="nf">extract_tarball</span><span class="p">(</span><span class="n">tarball_name</span><span class="p">,</span> <span class="n">dest_dir</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Extract a tarball to the given dest_dir&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">dest_dir</span> <span class="o">==</span> <span class="s2">&quot;.&quot;</span><span class="p">:</span>
        <span class="n">dest_dir_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dest_dir_name</span> <span class="o">=</span> <span class="n">dest_dir</span>
    <span class="nb">print</span> <span class="s2">&quot;Extracting </span><span class="si">{tarball_name}</span><span class="s2"> -&gt;  </span><span class="si">{dest_dir_name}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tarball_name</span><span class="o">=</span><span class="n">tarball_name</span><span class="p">,</span> <span class="n">dest_dir_name</span><span class="o">=</span><span class="n">dest_dir_name</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">tar</span> <span class="o">=</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">tarball_name</span><span class="p">)</span>
        <span class="n">tar</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">dest_dir</span><span class="p">,</span> <span class="n">members</span><span class="o">=</span><span class="n">track_extraction_progress</span><span class="p">(</span><span class="n">tar</span><span class="p">))</span>
        <span class="n">tar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">TarError</span><span class="p">,</span> <span class="n">error</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Could not extract the tarfile: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">tarball_name</span><span class="p">)</span>
        <span class="k">raise</span></div>

<div class="viewcode-block" id="change_ownership_recursive"><a class="viewcode-back" href="../api.html#esg_functions.change_ownership_recursive">[docs]</a><span class="k">def</span> <span class="nf">change_ownership_recursive</span><span class="p">(</span><span class="n">directory_path</span><span class="p">,</span> <span class="n">uid</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">gid</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Recursively changes ownership on a directory and its subdirectories; Mimics chown -R&#39;&#39;&#39;</span>
    <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">readlinkf</span><span class="p">(</span><span class="n">directory_path</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">directory</span> <span class="ow">in</span> <span class="n">dirs</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chown</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">directory</span><span class="p">),</span> <span class="n">uid</span><span class="p">,</span> <span class="n">gid</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">chown</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">gid</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Could not change permissions on : </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file_path</span><span class="p">)</span></div>


<div class="viewcode-block" id="change_permissions_recursive"><a class="viewcode-back" href="../api.html#esg_functions.change_permissions_recursive">[docs]</a><span class="k">def</span> <span class="nf">change_permissions_recursive</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Recursively changes permissions on a directory and its subdirectories; Mimics chmod -R&#39;&#39;&#39;</span>
    <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">topdown</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">directory</span> <span class="ow">in</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dirs</span><span class="p">]:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">file_name</span> <span class="ow">in</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">]:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span></div>


<div class="viewcode-block" id="replace_string_in_file"><a class="viewcode-back" href="../api.html#esg_functions.replace_string_in_file">[docs]</a><span class="k">def</span> <span class="nf">replace_string_in_file</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">original_string</span><span class="p">,</span> <span class="n">new_string</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Goes into a file and replaces string&#39;&#39;&#39;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file_handle</span><span class="p">:</span>
        <span class="n">filedata</span> <span class="o">=</span> <span class="n">file_handle</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">filedata</span> <span class="o">=</span> <span class="n">filedata</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">original_string</span><span class="p">,</span> <span class="n">new_string</span><span class="p">)</span>

    <span class="c1"># Write the file out again</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file_handle</span><span class="p">:</span>
        <span class="n">file_handle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">filedata</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">get_config_ip</span><span class="p">(</span><span class="n">interface_value</span><span class="p">):</span>
    <span class="c1"># chain = ifconfig[&quot;eth3&quot;] | grep[&quot;inet[^6]&quot;] | awk[&#39;{ gsub (&quot; *inet [^:]*:&quot;,&quot;&quot;); print eth3}&#39;]</span>
    <span class="c1">#     &#39;&#39;&#39;</span>
    <span class="c1">#     #####</span>
    <span class="c1">#     # Get Current IP Address - Needed (at least temporarily) for Mesos Master</span>
    <span class="c1">#     ####</span>
    <span class="c1">#     Takes a single interface value</span>
    <span class="c1">#     &quot;eth0&quot; or &quot;lo&quot;, etc...</span>
    <span class="c1">#     &#39;&#39;&#39;</span>
    <span class="n">netifaces</span><span class="o">.</span><span class="n">ifaddresses</span><span class="p">(</span><span class="n">interface_value</span><span class="p">)</span>
    <span class="n">ip_address</span> <span class="o">=</span> <span class="n">netifaces</span><span class="o">.</span><span class="n">ifaddresses</span><span class="p">(</span><span class="n">interface_value</span><span class="p">)[</span><span class="n">netifaces</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;addr&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">ip_address</span>


<div class="viewcode-block" id="bump_git_tag"><a class="viewcode-back" href="../api.html#esg_functions.bump_git_tag">[docs]</a><span class="k">def</span> <span class="nf">bump_git_tag</span><span class="p">(</span><span class="n">bump_level</span><span class="o">=</span><span class="s2">&quot;patch&quot;</span><span class="p">,</span> <span class="n">commit_message</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Update git tag version&#39;&#39;&#39;</span>
    <span class="kn">import</span> <span class="nn">semver</span>
    <span class="kn">from</span> <span class="nn">git</span> <span class="k">import</span> <span class="n">Repo</span>
    <span class="c1">#Bump the git tag version when a new release cut</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">find_executable</span><span class="p">(</span><span class="s2">&quot;git&quot;</span><span class="p">):</span>
        <span class="nb">print</span> <span class="s2">&quot;Git is not installed&quot;</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="n">repo</span> <span class="o">=</span> <span class="n">Repo</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
    <span class="n">current_tag</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">git</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">bump_level</span> <span class="o">==</span> <span class="s2">&quot;patch&quot;</span><span class="p">:</span>
        <span class="n">semver</span><span class="o">.</span><span class="n">bump_patch</span><span class="p">(</span><span class="n">current_tag</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">bump_level</span> <span class="o">==</span> <span class="s2">&quot;minor&quot;</span><span class="p">:</span>
        <span class="n">semver</span><span class="o">.</span><span class="n">bump_minor</span><span class="p">(</span><span class="n">current_tag</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">bump_level</span> <span class="o">==</span> <span class="s2">&quot;major&quot;</span><span class="p">:</span>
        <span class="n">semver</span><span class="o">.</span><span class="n">bump_major</span><span class="p">(</span><span class="n">current_tag</span><span class="p">)</span>
    <span class="n">new_tag</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">create_tag</span><span class="p">(</span><span class="n">current_tag</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s1">&#39;Automatic tag &quot;</span><span class="si">{0}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">current_tag</span><span class="p">))</span>
    <span class="n">repo</span><span class="o">.</span><span class="n">remotes</span><span class="o">.</span><span class="n">origin</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">new_tag</span><span class="p">)</span></div>

<div class="viewcode-block" id="write_security_lib_install_log"><a class="viewcode-back" href="../api.html#esg_functions.write_security_lib_install_log">[docs]</a><span class="k">def</span> <span class="nf">write_security_lib_install_log</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;Write esgf-security library info to install manifest&#39;&#39;&#39;</span>
    <span class="n">security_library_path</span> <span class="o">=</span> <span class="s2">&quot;/usr/local/tomcat/webapps/esg-orp/WEB-INF/lib/esgf-security-</span><span class="si">{}</span><span class="s2">.jar&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;esgf_security_version&quot;</span><span class="p">])</span>
    <span class="n">write_to_install_manifest</span><span class="p">(</span><span class="s2">&quot;esgf-&gt;library:esg-security&quot;</span><span class="p">,</span> <span class="n">security_library_path</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;esgf_security_version&quot;</span><span class="p">])</span></div>

<div class="viewcode-block" id="write_to_install_manifest"><a class="viewcode-back" href="../api.html#esg_functions.write_to_install_manifest">[docs]</a><span class="k">def</span> <span class="nf">write_to_install_manifest</span><span class="p">(</span><span class="n">component</span><span class="p">,</span> <span class="n">install_path</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">manifest_file</span><span class="o">=</span><span class="s2">&quot;/esg/esgf-install-manifest&quot;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Write component info to install manifest&#39;&#39;&#39;</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">ConfigParser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">()</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">manifest_file</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_section</span><span class="p">(</span><span class="s2">&quot;install_manifest&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">ConfigParser</span><span class="o">.</span><span class="n">DuplicateSectionError</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;section already exists&quot;</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;install_manifest&quot;</span><span class="p">,</span> <span class="n">component</span><span class="p">,</span> <span class="n">install_path</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">version</span> <span class="o">+</span> <span class="s2">&quot; - &quot;</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%B </span><span class="si">%d</span><span class="s2">, %Y&quot;</span><span class="p">))</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">manifest_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">config_file_object</span><span class="p">:</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">config_file_object</span><span class="p">)</span></div>

<div class="viewcode-block" id="get_version_from_install_manifest"><a class="viewcode-back" href="../api.html#esg_functions.get_version_from_install_manifest">[docs]</a><span class="k">def</span> <span class="nf">get_version_from_install_manifest</span><span class="p">(</span><span class="n">component</span><span class="p">,</span> <span class="n">manifest_file</span><span class="o">=</span><span class="s2">&quot;/esg/esgf-install-manifest&quot;</span><span class="p">,</span> <span class="n">section_name</span><span class="o">=</span><span class="s2">&quot;install_manifest&quot;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Get component version info from install manifest&#39;&#39;&#39;</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">ConfigParser</span><span class="o">.</span><span class="n">SafeConfigParser</span><span class="p">()</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">manifest_file</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section_name</span><span class="p">,</span> <span class="n">component</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">ConfigParser</span><span class="o">.</span><span class="n">NoSectionError</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;could not find component </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">component</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">ConfigParser</span><span class="o">.</span><span class="n">NoOptionError</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;could not find component </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">component</span><span class="p">)</span></div>


<div class="viewcode-block" id="update_fileupload_jar"><a class="viewcode-back" href="../api.html#esg_functions.update_fileupload_jar">[docs]</a><span class="k">def</span> <span class="nf">update_fileupload_jar</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;quick-fix for removing insecure commons-fileupload jar file&#39;&#39;&#39;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;/usr/local/solr/server/solr-webapp/webapp/WEB-INF/lib/commons-fileupload-1.2.1.jar&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">OSError</span><span class="p">,</span> <span class="n">error</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s2">&quot;/usr/local/solr/server/solr-webapp/webapp/WEB-INF/lib/commons-fileupload-1.3.2.jar&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{tomcat_install_dir}</span><span class="s2">/webapps/esg-search/WEB-INF/lib/commons-fileupload-1.3.2.jar&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tomcat_install_dir</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;tomcat_install_dir&quot;</span><span class="p">]),</span> <span class="s2">&quot;/usr/local/solr/server/solr-webapp/webapp/WEB-INF/lib/commons-fileupload-1.3.2.jar&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">,</span> <span class="n">error</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">error</span><span class="p">)</span></div>



<div class="viewcode-block" id="setup_whitelist_files"><a class="viewcode-back" href="../api.html#esg_functions.setup_whitelist_files">[docs]</a><span class="k">def</span> <span class="nf">setup_whitelist_files</span><span class="p">(</span><span class="n">whitelist_file_dir</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;esg_config_dir&quot;</span><span class="p">]):</span>
    <span class="sd">&#39;&#39;&#39;Setups up whitelist XML files from the distribution mirror</span>
<span class="sd">       Downloads the XML files and edits the placeholder string with the esgf hostname</span>
<span class="sd">       Formerly called setup_sensible_confs</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">update_fileupload_jar</span><span class="p">()</span>

    <span class="nb">print</span> <span class="s2">&quot;*******************************&quot;</span>
    <span class="nb">print</span> <span class="s2">&quot;Setting up The ESGF whitelist files&quot;</span>
    <span class="nb">print</span> <span class="s2">&quot;*******************************&quot;</span>

    <span class="n">conf_file_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;esgf_ats.xml.tmpl&quot;</span><span class="p">,</span> <span class="s2">&quot;esgf_azs.xml.tmpl&quot;</span><span class="p">,</span> <span class="s2">&quot;esgf_idp.xml.tmpl&quot;</span><span class="p">]</span>

    <span class="n">apache_user_id</span> <span class="o">=</span> <span class="n">get_user_id</span><span class="p">(</span><span class="s2">&quot;apache&quot;</span><span class="p">)</span>
    <span class="n">apache_group_id</span> <span class="o">=</span> <span class="n">get_group_id</span><span class="p">(</span><span class="s2">&quot;apache&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">file_name</span> <span class="ow">in</span> <span class="n">conf_file_list</span><span class="p">:</span>
        <span class="n">local_file_name</span> <span class="o">=</span> <span class="n">file_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.tmpl&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">local_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">whitelist_file_dir</span><span class="p">,</span> <span class="n">local_file_name</span><span class="p">)</span>
        <span class="n">esg_root_url</span> <span class="o">=</span> <span class="n">esg_property_manager</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s2">&quot;esg.root.url&quot;</span><span class="p">)</span>
        <span class="n">remote_file_url</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{esg_root_url}</span><span class="s2">/confs/</span><span class="si">{file_name}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">esg_root_url</span><span class="o">=</span><span class="n">esg_root_url</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="n">file_name</span><span class="p">)</span>

        <span class="n">download_update</span><span class="p">(</span><span class="n">local_file_path</span><span class="p">,</span> <span class="n">remote_file_url</span><span class="p">)</span>

        <span class="c1">#replace placeholder.fqdn</span>
        <span class="n">tree</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">local_file_path</span><span class="p">)</span>
        <span class="c1">#Had to use {http://www.esgf.org/whitelist} in search because the xml has it listed as the namespace</span>
        <span class="n">esgf_host</span> <span class="o">=</span> <span class="n">get_esgf_host</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">file_name</span> <span class="o">==</span> <span class="s2">&quot;esgf_ats.xml.tmpl&quot;</span><span class="p">:</span>
            <span class="n">placeholder_string</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;.//{http://www.esgf.org/whitelist}attribute&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;attributeService&quot;</span><span class="p">)</span>
            <span class="n">updated_string</span> <span class="o">=</span> <span class="n">placeholder_string</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;placeholder.fqdn&quot;</span><span class="p">,</span> <span class="n">esgf_host</span><span class="p">)</span>
            <span class="n">tree</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;.//{http://www.esgf.org/whitelist}attribute&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;attributeService&quot;</span><span class="p">,</span> <span class="n">updated_string</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">updated_string</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;.//{http://www.esgf.org/whitelist}value&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;placeholder.fqdn&quot;</span><span class="p">,</span> <span class="n">esgf_host</span><span class="p">)</span>
            <span class="n">tree</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;.//{http://www.esgf.org/whitelist}value&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">updated_string</span>
        <span class="n">tree</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">local_file_path</span><span class="p">)</span>

        <span class="n">os</span><span class="o">.</span><span class="n">chown</span><span class="p">(</span><span class="n">local_file_path</span><span class="p">,</span> <span class="n">apache_user_id</span><span class="p">,</span> <span class="n">apache_group_id</span><span class="p">)</span>
        <span class="n">current_mode</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">local_file_path</span><span class="p">)</span>
        <span class="c1">#add read permissions to all, i.e. chmod a+r</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">local_file_path</span><span class="p">,</span> <span class="n">current_mode</span><span class="o">.</span><span class="n">st_mode</span> <span class="o">|</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IRUSR</span> <span class="o">|</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IRGRP</span> <span class="o">|</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IROTH</span><span class="p">)</span></div>

<div class="viewcode-block" id="convert_hash_to_hex"><a class="viewcode-back" href="../api.html#esg_functions.convert_hash_to_hex">[docs]</a><span class="k">def</span> <span class="nf">convert_hash_to_hex</span><span class="p">(</span><span class="n">subject_name_hash</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Converts the subject_name_hash from a long to a hex string&#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="nb">format</span><span class="p">(</span><span class="n">subject_name_hash</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="get_node_type"><a class="viewcode-back" href="../api.html#esg_functions.get_node_type">[docs]</a><span class="k">def</span> <span class="nf">get_node_type</span><span class="p">(</span><span class="n">config_file</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;esg_config_type_file&quot;</span><span class="p">]):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Helper method for reading the last state of node type config from config dir file &quot;config_type&quot;</span>
<span class="sd">        Every successful, explicit call to --type|-t gets recorded in the &quot;config_type&quot; file</span>
<span class="sd">        If the configuration type is not explicity set the value is read from this file.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">last_config_type</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>
        <span class="n">node_type_list</span> <span class="o">=</span> <span class="n">last_config_type</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">node_type_list</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">node_type_list</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NoNodeTypeError</span>
    <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">NoNodeTypeError</span>
    <span class="k">except</span> <span class="n">NoNodeTypeError</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;No node type selected nor available! </span><span class="se">\n</span><span class="s1"> Consult usage with --help flag... look for the </span><span class="se">\&quot;</span><span class="s1">--type</span><span class="se">\&quot;</span><span class="s1"> flag</span>
<span class="s1">        </span><span class="se">\n</span><span class="s1">(must come BEFORE </span><span class="se">\&quot;</span><span class="s1">[start|stop|restart|update]</span><span class="se">\&quot;</span><span class="s1"> args)</span><span class="se">\n\n</span><span class="s1">&#39;&#39;&#39;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span></div>

<div class="viewcode-block" id="esgf_node_info"><a class="viewcode-back" href="../api.html#esg_functions.esgf_node_info">[docs]</a><span class="k">def</span> <span class="nf">esgf_node_info</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;Print basic info about ESGF installation&#39;&#39;&#39;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s1">&#39;docs&#39;</span><span class="p">,</span> <span class="s1">&#39;esgf_node_info.txt&#39;</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">info_file</span><span class="p">:</span>
        <span class="nb">print</span> <span class="n">info_file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span></div>


<div class="viewcode-block" id="call_binary"><a class="viewcode-back" href="../api.html#esg_functions.call_binary">[docs]</a><span class="k">def</span> <span class="nf">call_binary</span><span class="p">(</span><span class="n">binary_name</span><span class="p">,</span> <span class="n">arguments</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">conda_env</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Uses plumbum to make a call to a CLI binary.  The arguments should be passed as a list of strings&#39;&#39;&#39;</span>
    <span class="n">RETURN_CODE</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">STDOUT</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">STDERR</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;binary_name: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">binary_name</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;arguments: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">arguments</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">conda_env</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">arguments</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">arguments</span> <span class="o">=</span> <span class="p">[</span><span class="n">conda_env</span><span class="p">,</span> <span class="n">binary_name</span><span class="p">]</span> <span class="o">+</span> <span class="n">arguments</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">arguments</span> <span class="o">=</span> <span class="p">[</span><span class="n">conda_env</span><span class="p">,</span> <span class="n">binary_name</span><span class="p">]</span>
        <span class="n">binary_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s2">&quot;run_in_env.sh&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">command</span> <span class="o">=</span> <span class="n">local</span><span class="p">[</span><span class="n">binary_name</span><span class="p">]</span>
    <span class="k">except</span> <span class="n">ProcessExecutionError</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Could not find </span><span class="si">%s</span><span class="s2"> executable&quot;</span><span class="p">,</span> <span class="n">binary_name</span><span class="p">)</span>
        <span class="k">raise</span>

    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
        <span class="n">local</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">var</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">silent</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">arguments</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cmd_future</span> <span class="o">=</span> <span class="n">command</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">arguments</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BG</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cmd_future</span> <span class="o">=</span> <span class="n">command</span><span class="o">.</span><span class="n">run_bg</span><span class="p">()</span>
        <span class="n">cmd_future</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="n">output</span> <span class="o">=</span> <span class="p">[</span><span class="n">cmd_future</span><span class="o">.</span><span class="n">returncode</span><span class="p">,</span> <span class="n">cmd_future</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">cmd_future</span><span class="o">.</span><span class="n">stderr</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">arguments</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">command</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">arguments</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TEE</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">command</span><span class="o">.</span><span class="n">run_tee</span><span class="p">()</span>

    <span class="c1">#special case where checking java version is displayed via stderr</span>
    <span class="k">if</span> <span class="n">command</span><span class="o">.</span><span class="fm">__str__</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;/usr/local/java/bin/java&#39;</span> <span class="ow">and</span> <span class="n">output</span><span class="p">[</span><span class="n">RETURN_CODE</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">output</span><span class="p">[</span><span class="n">STDERR</span><span class="p">]</span>

    <span class="c1">#Check for non-zero return code</span>
    <span class="k">if</span> <span class="n">output</span><span class="p">[</span><span class="n">RETURN_CODE</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error occurred when executing </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">binary_name</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">arguments</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;STDERR: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">output</span><span class="p">[</span><span class="n">STDERR</span><span class="p">])</span>
        <span class="k">raise</span> <span class="n">ProcessExecutionError</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">output</span><span class="p">[</span><span class="n">STDOUT</span><span class="p">]</span></div>

<div class="viewcode-block" id="pip_install"><a class="viewcode-back" href="../api.html#esg_functions.pip_install">[docs]</a><span class="k">def</span> <span class="nf">pip_install</span><span class="p">(</span><span class="n">pkg</span><span class="p">,</span> <span class="n">req_file</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; pip installs a package to the current python environment &#39;&#39;&#39;</span>
    <span class="c1"># TODO: Fine tune options such as --log, --retries and --timeout</span>
    <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;install&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">req_file</span><span class="p">:</span>
        <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;-r&quot;</span><span class="p">)</span>
    <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pkg</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">call_binary</span><span class="p">(</span><span class="s2">&quot;pip&quot;</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span></div>

<div class="viewcode-block" id="pip_install_git"><a class="viewcode-back" href="../api.html#esg_functions.pip_install_git">[docs]</a><span class="k">def</span> <span class="nf">pip_install_git</span><span class="p">(</span><span class="n">repo</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">subdir</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Builds a properly formatted string to pip install from a git repo &#39;&#39;&#39;</span>
    <span class="n">git_pkg</span> <span class="o">=</span> <span class="s2">&quot;git+</span><span class="si">{repo}{tag}</span><span class="s2">#egg=</span><span class="si">{name}{subdir}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">repo</span><span class="o">=</span><span class="n">repo</span> <span class="k">if</span> <span class="n">repo</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.git&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">repo</span><span class="o">+</span><span class="s2">&quot;.git&quot;</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
        <span class="n">tag</span><span class="o">=</span><span class="s2">&quot;@&quot;</span><span class="o">+</span><span class="n">tag</span> <span class="k">if</span> <span class="n">tag</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">subdir</span><span class="o">=</span><span class="s2">&quot;&amp;subdirectory=&quot;</span><span class="o">+</span><span class="n">subdir</span> <span class="k">if</span> <span class="n">subdir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">pip_install</span><span class="p">(</span><span class="n">git_pkg</span><span class="p">)</span></div>

<div class="viewcode-block" id="pip_version"><a class="viewcode-back" href="../api.html#esg_functions.pip_version">[docs]</a><span class="k">def</span> <span class="nf">pip_version</span><span class="p">(</span><span class="n">pkg_name</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Get the version of a package installed with pip, return None if not installed &#39;&#39;&#39;</span>
    <span class="n">info</span> <span class="o">=</span> <span class="n">call_binary</span><span class="p">(</span><span class="s2">&quot;pip&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;list&quot;</span><span class="p">,</span> <span class="s2">&quot;--format=json&quot;</span><span class="p">])</span>
    <span class="n">info</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
    <span class="c1"># Get the dictionary with &quot;name&quot; matching pkg_name, if not present get None</span>
    <span class="n">pkg</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">pkg</span> <span class="k">for</span> <span class="n">pkg</span> <span class="ow">in</span> <span class="n">info</span> <span class="k">if</span> <span class="n">pkg</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">pkg_name</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pkg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> not found in pip list&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pkg_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s2">&quot;Found version </span><span class="si">{}</span><span class="s2"> of </span><span class="si">{}</span><span class="s2"> in pip list&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">pkg</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]),</span> <span class="n">pkg_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">pkg</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">])</span></div>

<div class="viewcode-block" id="insert_file_at_pattern"><a class="viewcode-back" href="../api.html#esg_functions.insert_file_at_pattern">[docs]</a><span class="k">def</span> <span class="nf">insert_file_at_pattern</span><span class="p">(</span><span class="n">target_file</span><span class="p">,</span> <span class="n">input_file</span><span class="p">,</span> <span class="n">pattern</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Replace a pattern inside the target file with the contents of the input file&#39;&#39;&#39;</span>
    <span class="n">target_file_object</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">target_file</span><span class="p">)</span>
    <span class="n">target_file_string</span> <span class="o">=</span> <span class="n">target_file_object</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">target_file_object</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">input_file_object</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">input_file</span><span class="p">)</span>
    <span class="n">input_file_string</span> <span class="o">=</span> <span class="n">input_file_object</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">input_file_object</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">target_file_string</span> <span class="o">=</span> <span class="n">target_file_string</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">input_file_string</span><span class="p">)</span>

    <span class="n">target_file_object</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">target_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="n">target_file_object</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">target_file_string</span><span class="p">)</span>
    <span class="n">target_file_object</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="main"><a class="viewcode-back" href="../api.html#esg_functions.main">[docs]</a><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;Main function&#39;&#39;&#39;</span>
    <span class="kn">import</span> <span class="nn">esg_logging_manager</span>

    <span class="n">esg_logging_manager</span><span class="o">.</span><span class="n">main</span><span class="p">()</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;esgf_logger&quot;</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="vm">__name__</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">,</span> <span class="s1">&#39;esg_config.yaml&#39;</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">config_file</span><span class="p">:</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">config_file</span><span class="p">)</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, William Hill

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
    

  

  <script type="text/javascript" src="../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>