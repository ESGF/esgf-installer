

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>esg_search &mdash; esgf-installer alpha documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="esgf-installer alpha documentation" href="../index.html"/>
        <link rel="up" title="Module code" href="index.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> esgf-installer
          

          
          </a>

          
            
            
              <div class="version">
                3.0.0-alpha
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Installation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html#autoinstaller">Autoinstaller</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cert_howto.html">ESGF Certificate Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../usage.html">ESGF Command Line Interface</a></li>
</ul>
<p class="caption"><span class="caption-text">API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api.html">Base Components</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api.html#data-node-components">Data Node Components</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api.html#index-node-components">Index Node Components</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api.html#idp-node-components">IDP Node Components</a></li>
</ul>
<p class="caption"><span class="caption-text">Issues</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../issues.html">ESGF Installer Issue Tracking Guidelines</a></li>
</ul>
<p class="caption"><span class="caption-text">Contributing</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../contribute_docs.html">Contributing to Documentation</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">esgf-installer</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Module code</a> &raquo;</li>
        
      <li>esg_search</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for esg_search</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">zipfile</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">filecmp</span>
<span class="kn">import</span> <span class="nn">errno</span>
<span class="kn">import</span> <span class="nn">ConfigParser</span>
<span class="kn">import</span> <span class="nn">tarfile</span>
<span class="kn">import</span> <span class="nn">yaml</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">clint.textui</span> <span class="k">import</span> <span class="n">progress</span>
<span class="kn">from</span> <span class="nn">git</span> <span class="k">import</span> <span class="n">Repo</span>
<span class="kn">from</span> <span class="nn">esgf_utilities</span> <span class="k">import</span> <span class="n">esg_functions</span>
<span class="kn">from</span> <span class="nn">esgf_utilities</span> <span class="k">import</span> <span class="n">esg_bash2py</span>
<span class="kn">from</span> <span class="nn">esgf_utilities</span> <span class="k">import</span> <span class="n">esg_property_manager</span>
<span class="kn">from</span> <span class="nn">esgf_utilities</span> <span class="k">import</span> <span class="n">esg_version_manager</span>
<span class="kn">from</span> <span class="nn">base</span> <span class="k">import</span> <span class="n">esg_tomcat_manager</span>
<span class="kn">import</span> <span class="nn">solr</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;esgf_logger&quot;</span> <span class="o">+</span><span class="s2">&quot;.&quot;</span><span class="o">+</span> <span class="n">__name__</span><span class="p">)</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">,</span> <span class="s1">&#39;esg_config.yaml&#39;</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">config_file</span><span class="p">:</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">config_file</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">write_search_service_install_log</span><span class="p">(</span><span class="n">search_web_service_dir</span><span class="p">,</span> <span class="n">esg_search_version</span><span class="p">):</span>
    <span class="n">esg_functions</span><span class="o">.</span><span class="n">write_to_install_manifest</span><span class="p">(</span><span class="s2">&quot;webapp:esg-search&quot;</span><span class="p">,</span> <span class="n">search_web_service_dir</span><span class="p">,</span> <span class="n">esg_search_version</span><span class="p">)</span>

    <span class="n">esg_property_manager</span><span class="o">.</span><span class="n">set_property</span><span class="p">(</span><span class="s2">&quot;index_service_endpoint&quot;</span><span class="p">,</span> <span class="s2">&quot;http://</span><span class="si">{}</span><span class="s2">/esg-search/search&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">esg_functions</span><span class="o">.</span><span class="n">get_esgf_host</span><span class="p">()))</span>
    <span class="n">esg_property_manager</span><span class="o">.</span><span class="n">set_property</span><span class="p">(</span><span class="s2">&quot;index_service_app_home&quot;</span><span class="p">,</span> <span class="n">search_web_service_dir</span><span class="p">)</span>
    <span class="n">esg_property_manager</span><span class="o">.</span><span class="n">set_property</span><span class="p">(</span><span class="s2">&quot;index_master_port&quot;</span><span class="p">,</span> <span class="s2">&quot;8984&quot;</span><span class="p">)</span>
    <span class="n">esg_property_manager</span><span class="o">.</span><span class="n">set_property</span><span class="p">(</span><span class="s2">&quot;index_slave_port&quot;</span><span class="p">,</span> <span class="s2">&quot;8983&quot;</span><span class="p">)</span>
    <span class="n">esg_property_manager</span><span class="o">.</span><span class="n">set_property</span><span class="p">(</span><span class="s2">&quot;index_timeout_connection&quot;</span><span class="p">,</span> <span class="s2">&quot;2000&quot;</span><span class="p">)</span>
    <span class="n">esg_property_manager</span><span class="o">.</span><span class="n">set_property</span><span class="p">(</span><span class="s2">&quot;index_timeout_read_datasets&quot;</span><span class="p">,</span> <span class="s2">&quot;10000&quot;</span><span class="p">)</span>
    <span class="n">esg_property_manager</span><span class="o">.</span><span class="n">set_property</span><span class="p">(</span><span class="s2">&quot;index_timeout_read_files&quot;</span><span class="p">,</span> <span class="s2">&quot;60000&quot;</span><span class="p">)</span>

    <span class="n">esg_property_manager</span><span class="o">.</span><span class="n">set_property</span><span class="p">(</span><span class="s2">&quot;publishing_service_endpoint&quot;</span><span class="p">,</span> <span class="s2">&quot;https://</span><span class="si">{}</span><span class="s2">/esg-search/remote/secure/client-cert/hessian/publishingService&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">esg_functions</span><span class="o">.</span><span class="n">get_esgf_host</span><span class="p">()))</span>
    <span class="n">esg_property_manager</span><span class="o">.</span><span class="n">set_property</span><span class="p">(</span><span class="s2">&quot;publishing_service_app_home&quot;</span><span class="p">,</span> <span class="n">search_web_service_dir</span><span class="p">)</span>

    <span class="n">esg_property_manager</span><span class="o">.</span><span class="n">set_property</span><span class="p">(</span><span class="s2">&quot;esgf_publisher_resources_home&quot;</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;esg_config_dir&quot;</span><span class="p">])</span>
    <span class="n">esg_property_manager</span><span class="o">.</span><span class="n">set_property</span><span class="p">(</span><span class="s2">&quot;esgf_publisher_resources_home&quot;</span><span class="p">,</span> <span class="s2">&quot;https://github.com/ESGF/esgf-publisher-resources.git&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">setup_publisher_resources</span><span class="p">():</span>
     <span class="n">esgf_publisher_resources_repo</span> <span class="o">=</span> <span class="s2">&quot;https://github.com/ESGF/esgf-publisher-resources.git&quot;</span>
     <span class="n">Repo</span><span class="o">.</span><span class="n">clone_from</span><span class="p">(</span><span class="n">esgf_publisher_resources_repo</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;esg_config_dir&quot;</span><span class="p">],</span><span class="s2">&quot;esgf-publisher-resources&quot;</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">search_startup_hook</span><span class="p">():</span>
    <span class="nb">print</span> <span class="s2">&quot;esg-search startup hook&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">esg_property_manager</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s2">&quot;index_auto_fetch_pub_resources&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">ConfigParser</span><span class="o">.</span><span class="n">NoOptionError</span><span class="p">:</span>
        <span class="n">esg_property_manager</span><span class="o">.</span><span class="n">set_property</span><span class="p">(</span><span class="s2">&quot;index_auto_fetch_pub_resources&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">)</span>
        <span class="n">setup_publisher_resources</span><span class="p">()</span>


<span class="c1">#--------------------</span>
<span class="c1"># Lifecycle functions</span>
<span class="c1">#--------------------</span>
<span class="k">def</span> <span class="nf">start_search_services</span><span class="p">():</span>
    <span class="nb">print</span> <span class="s2">&quot;Starting search services...&quot;</span>
    <span class="n">config_facets_props_path</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/facets.properties&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;esg_config_dir&quot;</span><span class="p">])</span>
    <span class="n">esg_search_facets_props_path</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/webapps/esg-search/WEB-INF/classes/esg/search/config/facets.properties&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;tomcat_install_dir&quot;</span><span class="p">])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">config_facets_props_path</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">esg_search_facets_props_path</span><span class="p">):</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">esg_search_facets_props_path</span><span class="p">,</span> <span class="n">config_facets_props_path</span><span class="p">)</span>

    <span class="n">solr</span><span class="o">.</span><span class="n">start_solr</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">stop_search_services</span><span class="p">():</span>
    <span class="nb">print</span> <span class="s2">&quot;Stopping search services...&quot;</span>
    <span class="n">solr</span><span class="o">.</span><span class="n">stop_solr</span><span class="p">()</span>

<span class="c1">#---------------------------------------------------------</span>
<span class="c1"># Solr Search Service Setup and Configuration</span>
<span class="c1">#---------------------------------------------------------</span>

<span class="k">def</span> <span class="nf">check_for_existing_solr_install</span><span class="p">():</span>
    <span class="n">esg_search_version</span> <span class="o">=</span> <span class="s2">&quot;4.9.2&quot;</span>
    <span class="nb">print</span> <span class="s2">&quot;Checking for search service </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">esg_search_version</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">installed_esg_search_version</span> <span class="o">=</span> <span class="n">esg_version_manager</span><span class="o">.</span><span class="n">get_current_webapp_version</span><span class="p">(</span><span class="s2">&quot;esg-search&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">IOError</span><span class="p">,</span><span class="n">error</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">error</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">ENOENT</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No existing version of esg-search found.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="s2">&quot;/usr/local/tomcat/webapps/esg-search&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">esg_property_manager</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s2">&quot;update.esg.search&quot;</span><span class="p">):</span>
            <span class="n">esg_search_install</span> <span class="o">=</span> <span class="n">esg_property_manager</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s2">&quot;update.esg.search&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">esg_search_install</span> <span class="o">=</span> <span class="n">raw_input</span><span class="p">(</span><span class="s2">&quot;Existing esg-search installation found.  Do you want to continue with the esg-search installation [y/N]: &quot;</span> <span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;no&quot;</span>
        <span class="k">if</span> <span class="n">esg_search_install</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;no&quot;</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">]:</span>
            <span class="nb">print</span> <span class="s2">&quot;Using existing esg-search installation. Skipping setup.&quot;</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">esg_property_manager</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s2">&quot;backup.esg.search&quot;</span><span class="p">):</span>
                <span class="n">backup_esg_search</span> <span class="o">=</span> <span class="n">esg_property_manager</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s2">&quot;backup.esg.search&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">backup_esg_search</span> <span class="o">=</span> <span class="n">raw_input</span><span class="p">(</span><span class="s2">&quot;Do you want to make a back up of the existing distribution?? [Y/n] &quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;y&quot;</span>
            <span class="k">if</span> <span class="n">backup_esg_search</span><span class="o">.</span><span class="n">lower</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;yes&quot;</span><span class="p">]:</span>
                <span class="n">esg_functions</span><span class="o">.</span><span class="n">backup</span><span class="p">(</span><span class="s2">&quot;/usr/local/tomcat/webapps/esg-search&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">download_esg_search</span><span class="p">(</span><span class="n">esg_search_version</span><span class="p">):</span>
    <span class="n">esg_bash2py</span><span class="o">.</span><span class="n">mkdir_p</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;workdir&quot;</span><span class="p">])</span>
    <span class="k">with</span> <span class="n">esg_bash2py</span><span class="o">.</span><span class="n">pushd</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;workdir&quot;</span><span class="p">]):</span>
        <span class="n">search_service_dist_url</span> <span class="o">=</span> <span class="s2">&quot;https://aims1.llnl.gov/esgf/dist/devel/esg-search/esg-search-</span><span class="si">{}</span><span class="s2">.tar.gz&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">esg_search_version</span><span class="p">)</span>
        <span class="n">search_service_dist_file</span> <span class="o">=</span> <span class="s2">&quot;esg-search-</span><span class="si">{}</span><span class="s2">.tar.gz&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">esg_search_version</span><span class="p">)</span>
        <span class="n">esg_functions</span><span class="o">.</span><span class="n">download_update</span><span class="p">(</span><span class="n">search_service_dist_file</span><span class="p">,</span> <span class="n">search_service_dist_url</span><span class="p">)</span>

        <span class="c1">#Extract in workdir to get esg-search.war file</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">esg_functions</span><span class="o">.</span><span class="n">extract_tarball</span><span class="p">(</span><span class="n">search_service_dist_file</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">error</span><span class="p">:</span>
            <span class="n">esg_functions</span><span class="o">.</span><span class="n">exit_with_error</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">copy_esg_search_war_to_tomcat</span><span class="p">(</span><span class="n">esg_search_version</span><span class="p">,</span> <span class="n">search_web_service_dir</span><span class="p">,</span> <span class="n">search_service_war_file</span><span class="p">):</span>
    <span class="n">search_service_dist_dir</span> <span class="o">=</span> <span class="s2">&quot;esg-search-</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">esg_search_version</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">esg_bash2py</span><span class="o">.</span><span class="n">pushd</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;workdir&quot;</span><span class="p">],</span><span class="n">search_service_dist_dir</span><span class="p">)):</span>
        <span class="n">esg_tomcat_manager</span><span class="o">.</span><span class="n">stop_tomcat</span><span class="p">()</span>

        <span class="n">esg_bash2py</span><span class="o">.</span><span class="n">mkdir_p</span><span class="p">(</span><span class="n">search_web_service_dir</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">search_service_war_file</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">search_web_service_dir</span><span class="p">,</span> <span class="n">search_service_war_file</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">extract_esg_search_war</span><span class="p">(</span><span class="n">search_web_service_dir</span><span class="p">,</span> <span class="n">search_service_war_file</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">esg_bash2py</span><span class="o">.</span><span class="n">pushd</span><span class="p">(</span><span class="n">search_web_service_dir</span><span class="p">):</span>
        <span class="nb">print</span> <span class="s2">&quot;Expanding war </span><span class="si">{search_service_war_file}</span><span class="s2"> in </span><span class="si">{pwd}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">search_service_war_file</span><span class="o">=</span><span class="n">search_service_war_file</span><span class="p">,</span> <span class="n">pwd</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span>
        <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="s2">&quot;/usr/local/tomcat/webapps/esg-search/esg-search.war&quot;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">zf</span><span class="p">:</span>
            <span class="n">zf</span><span class="o">.</span><span class="n">extractall</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;esg-search.war&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">update_solr_cores_schema</span><span class="p">(</span><span class="n">search_web_service_dir</span><span class="p">):</span>
    <span class="nb">print</span> <span class="s2">&quot;Checking for Solr schema update&quot;</span>
    <span class="n">new_solr_xml</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/WEB-INF/solr-home/mycore/conf/schema.xml&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">search_web_service_dir</span><span class="p">)</span>

    <span class="c1">#The values are the solr cores</span>
    <span class="n">solr_shards</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;master-8984&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;datasets&quot;</span><span class="p">,</span> <span class="s2">&quot;files&quot;</span><span class="p">,</span> <span class="s2">&quot;aggregations&quot;</span><span class="p">]</span> <span class="p">,</span> <span class="s2">&quot;localhost-8982&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;datasets&quot;</span><span class="p">,</span> <span class="s2">&quot;files&quot;</span><span class="p">,</span> <span class="s2">&quot;aggregations&quot;</span><span class="p">]}</span>

    <span class="k">for</span> <span class="n">shard</span><span class="p">,</span> <span class="n">cores</span> <span class="ow">in</span> <span class="n">solr_shards</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">core</span> <span class="ow">in</span> <span class="n">cores</span><span class="p">:</span>
            <span class="n">old_solr_xml</span> <span class="o">=</span> <span class="s2">&quot;/usr/local/solr-home/</span><span class="si">{shard}</span><span class="s2">/</span><span class="si">{core}</span><span class="s2">/conf/schema.xml&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">shard</span><span class="o">=</span><span class="n">shard</span><span class="p">,</span> <span class="n">core</span><span class="o">=</span><span class="n">core</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">old_solr_xml</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">filecmp</span><span class="o">.</span><span class="n">cmp</span><span class="p">(</span><span class="n">old_solr_xml</span><span class="p">,</span> <span class="n">new_solr_xml</span><span class="p">):</span>
                    <span class="nb">print</span> <span class="s2">&quot;Files: </span><span class="si">{old_solr_xml}</span><span class="s2">, </span><span class="si">{new_solr_xml}</span><span class="s2"> are identical, not upgrading&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">old_solr_xml</span><span class="o">=</span><span class="n">old_solr_xml</span><span class="p">,</span> <span class="n">new_solr_xml</span><span class="o">=</span><span class="n">new_solr_xml</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span> <span class="s2">&quot;Copying </span><span class="si">{new_solr_xml}</span><span class="s2"> -&gt; </span><span class="si">{old_solr_xml}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">old_solr_xml</span><span class="o">=</span><span class="n">old_solr_xml</span><span class="p">,</span> <span class="n">new_solr_xml</span><span class="o">=</span><span class="n">new_solr_xml</span><span class="p">)</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">new_solr_xml</span><span class="p">,</span> <span class="n">old_solr_xml</span><span class="p">)</span>

<div class="viewcode-block" id="setup_search_service"><a class="viewcode-back" href="../api.html#esg_search.setup_search_service">[docs]</a><span class="k">def</span> <span class="nf">setup_search_service</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Install The Search Service...</span>
<span class="sd">    - Takes boolean arg: 0 = setup / install mode (default)</span>
<span class="sd">                         1 = updated mode</span>

<span class="sd">    In setup mode it is an idempotent install (default)</span>
<span class="sd">    In update mode it will always pull down latest after archiving old&#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="n">check_for_existing_solr_install</span><span class="p">():</span>
        <span class="k">return</span>

    <span class="nb">print</span> <span class="s2">&quot;*******************************&quot;</span>
    <span class="nb">print</span> <span class="s2">&quot;Setting up The ESGF Search Service...&quot;</span>
    <span class="nb">print</span> <span class="s2">&quot;*******************************&quot;</span>
    <span class="n">esg_search_version</span> <span class="o">=</span> <span class="s2">&quot;4.9.2&quot;</span>
    <span class="n">search_web_service_dir</span> <span class="o">=</span> <span class="s2">&quot;/usr/local/tomcat/webapps/esg-search&quot;</span>
    <span class="n">search_service_war_file</span> <span class="o">=</span> <span class="s2">&quot;esg-search.war&quot;</span>
    <span class="n">download_esg_search</span><span class="p">(</span><span class="n">esg_search_version</span><span class="p">)</span>

    <span class="n">copy_esg_search_war_to_tomcat</span><span class="p">(</span><span class="n">esg_search_version</span><span class="p">,</span> <span class="n">search_web_service_dir</span><span class="p">,</span> <span class="n">search_service_war_file</span><span class="p">)</span>
    <span class="n">extract_esg_search_war</span><span class="p">(</span><span class="n">search_web_service_dir</span><span class="p">,</span> <span class="n">search_service_war_file</span><span class="p">)</span>
    <span class="n">update_solr_cores_schema</span><span class="p">(</span><span class="n">search_web_service_dir</span><span class="p">)</span>

    <span class="n">TOMCAT_USER_ID</span> <span class="o">=</span> <span class="n">esg_functions</span><span class="o">.</span><span class="n">get_user_id</span><span class="p">(</span><span class="s2">&quot;tomcat&quot;</span><span class="p">)</span>
    <span class="n">TOMCAT_GROUP_ID</span> <span class="o">=</span> <span class="n">esg_functions</span><span class="o">.</span><span class="n">get_group_id</span><span class="p">(</span><span class="s2">&quot;tomcat&quot;</span><span class="p">)</span>

    <span class="n">esg_functions</span><span class="o">.</span><span class="n">change_ownership_recursive</span><span class="p">(</span><span class="n">search_web_service_dir</span><span class="p">,</span> <span class="n">TOMCAT_USER_ID</span><span class="p">,</span> <span class="n">TOMCAT_GROUP_ID</span><span class="p">)</span>

    <span class="n">write_search_service_install_log</span><span class="p">(</span><span class="n">search_web_service_dir</span><span class="p">,</span> <span class="n">esg_search_version</span><span class="p">)</span>
    <span class="n">write_search_rss_properties</span><span class="p">()</span>
    <span class="n">setup_publisher_resources</span><span class="p">()</span>

    <span class="c1">#Get utility script for crawling thredds sites</span>
    <span class="n">fetch_crawl_launcher</span><span class="p">()</span>
    <span class="n">fetch_index_optimization_launcher</span><span class="p">()</span>

    <span class="c1">#restart tomcat to put modifications in effect.</span>
    <span class="n">esg_tomcat_manager</span><span class="o">.</span><span class="n">start_tomcat</span><span class="p">()</span></div>

<span class="k">def</span> <span class="nf">write_search_rss_properties</span><span class="p">():</span>
    <span class="n">node_short_name</span> <span class="o">=</span> <span class="n">esg_property_manager</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s2">&quot;node.short.name&quot;</span><span class="p">)</span>
    <span class="n">esgf_feed_datasets_title</span> <span class="o">=</span> <span class="n">node_short_name</span> <span class="o">+</span> <span class="s2">&quot; RSS&quot;</span>
    <span class="n">esgf_feed_datasets_desc</span> <span class="o">=</span> <span class="s2">&quot;Datasets Accessible from node: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">node_short_name</span><span class="p">)</span>
    <span class="n">esgf_feed_datasets_link</span> <span class="o">=</span> <span class="s2">&quot;http://</span><span class="si">{}</span><span class="s2">/thredds/catalog.html&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">esg_functions</span><span class="o">.</span><span class="n">get_esgf_host</span><span class="p">())</span>

    <span class="n">esg_property_manager</span><span class="o">.</span><span class="n">set_property</span><span class="p">(</span><span class="s2">&quot;esgf_feed_datasets_title&quot;</span><span class="p">,</span> <span class="n">esgf_feed_datasets_title</span><span class="p">)</span>
    <span class="n">esg_property_manager</span><span class="o">.</span><span class="n">set_property</span><span class="p">(</span><span class="s2">&quot;esgf_feed_datasets_desc&quot;</span><span class="p">,</span> <span class="n">esgf_feed_datasets_desc</span><span class="p">)</span>
    <span class="n">esg_property_manager</span><span class="o">.</span><span class="n">set_property</span><span class="p">(</span><span class="s2">&quot;esgf_feed_datasets_link&quot;</span><span class="p">,</span> <span class="n">esgf_feed_datasets_link</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">fetch_crawl_launcher</span><span class="p">():</span>
    <span class="n">esgf_crawl_launcher</span> <span class="o">=</span> <span class="s2">&quot;esgf-crawl&quot;</span>
    <span class="k">with</span> <span class="n">esg_bash2py</span><span class="o">.</span><span class="n">pushd</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;scripts_dir&quot;</span><span class="p">]):</span>
        <span class="n">esgf_crawl_launcher_url</span> <span class="o">=</span> <span class="s2">&quot;https://aims1.llnl.gov/esgf/dist/devel/esg-search/esgf-crawl&quot;</span>
        <span class="n">esg_functions</span><span class="o">.</span><span class="n">download_update</span><span class="p">(</span><span class="n">esgf_crawl_launcher</span><span class="p">,</span> <span class="n">esgf_crawl_launcher_url</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">esgf_crawl_launcher</span><span class="p">,</span> <span class="mi">0755</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">fetch_index_optimization_launcher</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">esg_bash2py</span><span class="o">.</span><span class="n">pushd</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;scripts_dir&quot;</span><span class="p">]):</span>
        <span class="n">esgf_index_optimization_launcher</span> <span class="o">=</span> <span class="s2">&quot;esgf-optimize-index&quot;</span>
        <span class="n">esgf_index_optimization_launcher_url</span> <span class="o">=</span> <span class="s2">&quot;https://aims1.llnl.gov/esgf/dist/devel/esg-search/esgf-optimize-index&quot;</span>
        <span class="n">esg_functions</span><span class="o">.</span><span class="n">download_update</span><span class="p">(</span><span class="n">esgf_index_optimization_launcher</span><span class="p">,</span> <span class="n">esgf_index_optimization_launcher_url</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">esgf_index_optimization_launcher</span><span class="p">,</span> <span class="mi">0755</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">fetch_static_shards_file</span><span class="p">():</span>
    <span class="n">static_shards_file</span> <span class="o">=</span> <span class="s2">&quot;esgf_shards_static.xml&quot;</span>
    <span class="n">static_shards_url</span> <span class="o">=</span> <span class="s2">&quot;https://aims1.llnl.gov/esgf/dist/devel/lists/esgf_shards_static.xml&quot;</span>
    <span class="n">esg_functions</span><span class="o">.</span><span class="n">download_update</span><span class="p">(</span><span class="n">static_shards_file</span><span class="p">,</span> <span class="n">static_shards_url</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">download_esg_search_war</span><span class="p">(</span><span class="n">esg_search_war_url</span><span class="p">):</span>
    <span class="nb">print</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">*******************************&quot;</span>
    <span class="nb">print</span> <span class="s2">&quot;Downloading ESG Search war file&quot;</span>
    <span class="nb">print</span> <span class="s2">&quot;******************************* </span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">esg_search_war_url</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;/usr/local/tomcat/webapps/esg-search/esg-search.war&#39;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">total_length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content-length&#39;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">progress</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">iter_content</span><span class="p">(</span><span class="n">chunk_size</span><span class="o">=</span><span class="mi">1024</span><span class="p">),</span> <span class="n">expected_size</span><span class="o">=</span><span class="p">(</span><span class="n">total_length</span><span class="o">/</span><span class="mi">1024</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">chunk</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

<div class="viewcode-block" id="setup_esg_search"><a class="viewcode-back" href="../api.html#esg_search.setup_esg_search">[docs]</a><span class="k">def</span> <span class="nf">setup_esg_search</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;Setting up the ESG Search application&#39;&#39;&#39;</span>

    <span class="nb">print</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">*******************************&quot;</span>
    <span class="nb">print</span> <span class="s2">&quot;Setting up ESG Search&quot;</span>
    <span class="nb">print</span> <span class="s2">&quot;******************************* </span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="n">ESGF_REPO</span> <span class="o">=</span> <span class="s2">&quot;http://aims1.llnl.gov/esgf&quot;</span>
    <span class="n">esg_bash2py</span><span class="o">.</span><span class="n">mkdir_p</span><span class="p">(</span><span class="s2">&quot;/usr/local/tomcat/webapps/esg-search&quot;</span><span class="p">)</span>
    <span class="n">esg_search_war_url</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{ESGF_REPO}</span><span class="s2">/dist/esg-search/esg-search.war&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ESGF_REPO</span><span class="o">=</span><span class="n">ESGF_REPO</span><span class="p">)</span>
    <span class="n">download_esg_search_war</span><span class="p">(</span><span class="n">esg_search_war_url</span><span class="p">)</span>
    <span class="c1">#Extract esg-search war</span>
    <span class="k">with</span> <span class="n">esg_bash2py</span><span class="o">.</span><span class="n">pushd</span><span class="p">(</span><span class="s2">&quot;/usr/local/tomcat/webapps/esg-search&quot;</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="s2">&quot;/usr/local/tomcat/webapps/esg-search/esg-search.war&quot;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">zf</span><span class="p">:</span>
            <span class="n">zf</span><span class="o">.</span><span class="n">extractall</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;esg-search.war&quot;</span><span class="p">)</span>

    <span class="n">TOMCAT_USER_ID</span> <span class="o">=</span> <span class="n">esg_functions</span><span class="o">.</span><span class="n">get_tomcat_user_id</span><span class="p">()</span>
    <span class="n">TOMCAT_GROUP_ID</span> <span class="o">=</span> <span class="n">esg_functions</span><span class="o">.</span><span class="n">get_tomcat_group_id</span><span class="p">()</span>
    <span class="n">esg_functions</span><span class="o">.</span><span class="n">change_ownership_recursive</span><span class="p">(</span><span class="s2">&quot;/usr/local/tomcat/webapps/esg-search&quot;</span><span class="p">,</span> <span class="n">TOMCAT_USER_ID</span><span class="p">,</span> <span class="n">TOMCAT_GROUP_ID</span><span class="p">)</span></div>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># setup_esg_search()</span>
    <span class="nb">print</span> <span class="s2">&quot;*******************************&quot;</span>
    <span class="nb">print</span> <span class="s2">&quot;Setting up The ESGF Search Sub-Project...&quot;</span>
    <span class="nb">print</span> <span class="s2">&quot;*******************************&quot;</span>

    <span class="n">setup_search_service</span><span class="p">()</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, William Hill.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'alpha',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: ''
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>