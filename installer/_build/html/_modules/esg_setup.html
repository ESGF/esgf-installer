<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>esg_setup &#8212; esgf-installer 2.5 documentation</title>
    
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '2.5',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for esg_setup</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">from</span> <span class="nn">OpenSSL</span> <span class="k">import</span> <span class="n">crypto</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">platform</span>
<span class="kn">import</span> <span class="nn">netifaces</span>
<span class="kn">import</span> <span class="nn">tld</span>
<span class="kn">import</span> <span class="nn">grp</span>
<span class="kn">import</span> <span class="nn">shlex</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">urlparse</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">getpass</span>
<span class="kn">import</span> <span class="nn">tarfile</span>
<span class="kn">import</span> <span class="nn">getpass</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="k">import</span> <span class="n">sleep</span>
<span class="kn">from</span> <span class="nn">esg_exceptions</span> <span class="k">import</span> <span class="n">UnprivilegedUserError</span><span class="p">,</span> <span class="n">WrongOSError</span><span class="p">,</span> <span class="n">UnverifiedScriptError</span>
<span class="kn">from</span> <span class="nn">distutils.spawn</span> <span class="k">import</span> <span class="n">find_executable</span>
<span class="kn">from</span> <span class="nn">clint.textui</span> <span class="k">import</span> <span class="n">progress</span>
<span class="kn">import</span> <span class="nn">esg_bash2py</span>
<span class="kn">import</span> <span class="nn">esg_functions</span>
<span class="kn">import</span> <span class="nn">esg_bootstrap</span>
<span class="kn">import</span> <span class="nn">esg_property_manager</span>
<span class="kn">import</span> <span class="nn">esg_version_manager</span>
<span class="kn">import</span> <span class="nn">esg_logging_manager</span>
<span class="kn">import</span> <span class="nn">esg_init</span>
<span class="kn">import</span> <span class="nn">yaml</span>
<span class="kn">import</span> <span class="nn">semver</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">esg_logging_manager</span><span class="o">.</span><span class="n">create_rotating_log</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;esg_config.yaml&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">config_file</span><span class="p">:</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">config_file</span><span class="p">)</span>

<span class="n">force_install</span> <span class="o">=</span> <span class="kc">False</span>

<div class="viewcode-block" id="check_if_root"><a class="viewcode-back" href="../index.html#esg_setup.check_if_root">[docs]</a><span class="k">def</span> <span class="nf">check_if_root</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;Check to see if the user is root&#39;&#39;&#39;</span>
    <span class="nb">print</span> <span class="s2">&quot;Checking that you have root privileges on </span><span class="si">%s</span><span class="s2">... &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">())</span>
    <span class="n">root_check</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">geteuid</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">root_check</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">UnprivilegedUserError</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Root user found.&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">UnprivilegedUserError</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Must run this program with root&#39;s effective UID</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">esg_functions</span><span class="o">.</span><span class="n">exit_with_error</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span></div>

<div class="viewcode-block" id="check_os"><a class="viewcode-back" href="../index.html#esg_setup.check_os">[docs]</a><span class="k">def</span> <span class="nf">check_os</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;Check if the operating system on server is Redhat or CentOS;</span>
<span class="sd">    returns False Otherwise&#39;&#39;&#39;</span>
    <span class="nb">print</span> <span class="s2">&quot;Checking operating system.....&quot;</span>
    <span class="n">release_version</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
        <span class="s2">&quot;(centos|redhat)-(\S*)-&quot;</span><span class="p">,</span> <span class="n">platform</span><span class="o">.</span><span class="n">platform</span><span class="p">())</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Release Version: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">release_version</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;6&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">release_version</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="n">WrongOSError</span>
    <span class="k">except</span> <span class="n">WrongOSError</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;ESGF can only be installed on versions 6 of Red Hat, CentOS or Scientific Linux x86_64 systems&quot;</span><span class="p">)</span>
        <span class="n">esg_functions</span><span class="o">.</span><span class="n">exit_with_error</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s2">&quot;Operating System = </span><span class="si">{OS}</span><span class="s2"> </span><span class="si">{version}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">OS</span><span class="o">=</span><span class="n">release_version</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">version</span><span class="o">=</span><span class="n">release_version</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span></div>


<div class="viewcode-block" id="check_prerequisites"><a class="viewcode-back" href="../index.html#esg_setup.check_prerequisites">[docs]</a><span class="k">def</span> <span class="nf">check_prerequisites</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Checking for what we expect to be on the system a-priori that we are not going to install or be responsible for</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">check_if_root</span><span class="p">()</span>

    <span class="c1">#----------------------------------------</span>
    <span class="nb">print</span> <span class="s2">&quot;Checking requisites... &quot;</span>

    <span class="c1"># checking for OS, architecture, distribution and version</span>
    <span class="n">check_os</span><span class="p">()</span></div>

<div class="viewcode-block" id="create_esg_directories"><a class="viewcode-back" href="../index.html#esg_setup.create_esg_directories">[docs]</a><span class="k">def</span> <span class="nf">create_esg_directories</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;Create directories to hold ESGF scripts, config files, and logs&#39;&#39;&#39;</span>
    <span class="n">directories_to_check</span> <span class="o">=</span> <span class="p">[</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;scripts_dir&quot;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;esg_backup_dir&quot;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;esg_tools_dir&quot;</span><span class="p">],</span>
                            <span class="n">config</span><span class="p">[</span>
                                <span class="s2">&quot;esg_log_dir&quot;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;esg_config_dir&quot;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;esg_etc_dir&quot;</span><span class="p">],</span>
                            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;tomcat_conf_dir&quot;</span><span class="p">]]</span>
    <span class="k">for</span> <span class="n">directory</span> <span class="ow">in</span> <span class="n">directories_to_check</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
            <span class="n">esg_bash2py</span><span class="o">.</span><span class="n">mkdir_p</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;esg_etc_dir&quot;</span><span class="p">],</span> <span class="mi">0777</span><span class="p">)</span></div>

<span class="k">def</span> <span class="nf">init_structure</span><span class="p">():</span>

    <span class="n">create_esg_directories</span><span class="p">()</span>

    <span class="c1">#Create esgf.properties file</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;config_file&quot;</span><span class="p">]):</span>
        <span class="n">esg_bash2py</span><span class="o">.</span><span class="n">touch</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;config_file&quot;</span><span class="p">])</span>

    <span class="c1">#--------------</span>
    <span class="c1"># Setup variables....</span>
    <span class="c1">#--------------</span>

    <span class="n">check_for_my_ip</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">_select_ip_address</span><span class="p">():</span>
    <span class="n">choice</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">raw_input</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">choice</span>


<span class="k">def</span> <span class="nf">_render_ip_address_menu</span><span class="p">(</span><span class="n">ip_addresses</span><span class="p">):</span>
    <span class="nb">print</span> <span class="s2">&quot;Detected multiple IP addresses bound to this host...</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="nb">print</span> <span class="s2">&quot;Please select the IP address to use for this installation</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="nb">print</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">-------------------------------------------</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">ip</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ip_addresses</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(),</span> <span class="mi">1</span><span class="p">):</span>
        <span class="nb">print</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2"> </span><span class="si">%i</span><span class="s2">) </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">ip</span><span class="p">)</span>
    <span class="nb">print</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">-------------------------------------------</span><span class="se">\n</span><span class="s2">&quot;</span>


<span class="k">def</span> <span class="nf">check_for_my_ip</span><span class="p">(</span><span class="n">force_install</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Checking for IP address(es)...&quot;</span><span class="p">)</span>
    <span class="n">matched</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">my_ip_address</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">eth0</span> <span class="o">=</span> <span class="n">netifaces</span><span class="o">.</span><span class="n">ifaddresses</span><span class="p">(</span><span class="n">netifaces</span><span class="o">.</span><span class="n">interfaces</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">ip_addresses</span> <span class="o">=</span> <span class="p">[</span><span class="n">ip</span><span class="p">[</span><span class="s2">&quot;addr&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">ip</span> <span class="ow">in</span> <span class="n">eth0</span><span class="p">[</span><span class="n">netifaces</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">]]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">esgf_host_ip</span>
    <span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
        <span class="n">esgf_host_ip</span> <span class="o">=</span> <span class="n">esg_property_manager</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s2">&quot;esgf_host_ip&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">esgf_host_ip</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force_install</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Using IP: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">esgf_host_ip</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span>

    <span class="c1"># We want to make sure that the IP address we have in our config</span>
    <span class="c1"># matches one of the IPs that are associated with this host</span>
    <span class="k">for</span> <span class="n">ip</span> <span class="ow">in</span> <span class="n">ip_addresses</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ip</span> <span class="o">==</span> <span class="n">esgf_host_ip</span><span class="p">:</span>
            <span class="n">matched</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">matched</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Configured host IP address does not match available IPs...&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">esgf_host_ip</span> <span class="ow">or</span> <span class="n">force_install</span> <span class="ow">or</span> <span class="n">matched</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ip_addresses</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># ask the user to choose...</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">_render_ip_address_menu</span><span class="p">(</span><span class="n">ip_addresses</span><span class="p">)</span>
                <span class="n">default</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">choice</span> <span class="o">=</span> <span class="n">_select_ip_address</span><span class="p">()</span> <span class="ow">or</span> <span class="n">default</span>
                <span class="n">my_ip_address</span> <span class="o">=</span> <span class="n">ip_addresses</span><span class="p">[</span><span class="n">choice</span><span class="p">]</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;selected address -&gt; </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">my_ip_address</span><span class="p">)</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">my_ip_address</span> <span class="o">=</span> <span class="n">ip_addresses</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">esg_property_manager</span><span class="o">.</span><span class="n">write_as_property</span><span class="p">(</span><span class="s2">&quot;esgf_host_ip&quot;</span><span class="p">,</span> <span class="n">my_ip_address</span><span class="p">)</span>
    <span class="n">esgf_host_ip</span> <span class="o">=</span> <span class="n">esg_property_manager</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s2">&quot;esgf_host_ip&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">esgf_host_ip</span>


<span class="k">def</span> <span class="nf">_choose_fqdn</span><span class="p">(</span><span class="n">esgf_host</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">esgf_host</span> <span class="ow">or</span> <span class="n">force_install</span><span class="p">:</span>
        <span class="n">default_host_name</span> <span class="o">=</span> <span class="n">esgf_host</span> <span class="ow">or</span> <span class="n">socket</span><span class="o">.</span><span class="n">getfqdn</span><span class="p">()</span>
        <span class="n">defaultdomain_regex</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;^\w+-*\w*\W*(.+)&quot;</span>
        <span class="n">defaultdomain</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
            <span class="n">defaultdomain_regex</span><span class="p">,</span> <span class="n">default_host_name</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">default_host_name</span><span class="p">:</span>
            <span class="n">default_host_name</span> <span class="o">=</span> <span class="s2">&quot;localhost.localdomain&quot;</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">defaultdomain</span><span class="p">:</span>
            <span class="n">default_host_name</span> <span class="o">=</span> <span class="n">default_host_name</span> <span class="o">+</span> <span class="s2">&quot;.localdomain&quot;</span>

        <span class="n">default_host_name</span> <span class="o">=</span> <span class="n">raw_input</span><span class="p">(</span><span class="s2">&quot;What is the fully qualified domain name of this node? [</span><span class="si">{default_host_name}</span><span class="s2">]: &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">default_host_name</span><span class="o">=</span><span class="n">default_host_name</span><span class="p">))</span> <span class="ow">or</span> <span class="n">default_host_name</span>
        <span class="n">esgf_host</span> <span class="o">=</span> <span class="n">default_host_name</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;esgf_host = [</span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="n">esgf_host</span><span class="p">)</span>
        <span class="n">esg_property_manager</span><span class="o">.</span><span class="n">write_as_property</span><span class="p">(</span><span class="s2">&quot;esgf_host&quot;</span><span class="p">,</span> <span class="n">esgf_host</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;esgf_host = [</span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="n">esgf_host</span><span class="p">)</span>
        <span class="n">esg_property_manager</span><span class="o">.</span><span class="n">write_as_property</span><span class="p">(</span><span class="s2">&quot;esgf_host&quot;</span><span class="p">,</span> <span class="n">esgf_host</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_is_valid_password</span><span class="p">(</span><span class="n">password_input</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">password_input</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">str</span><span class="o">.</span><span class="n">isalnum</span><span class="p">(</span><span class="n">password_input</span><span class="p">):</span>
        <span class="nb">print</span> <span class="s2">&quot;Invalid password... &quot;</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">password_input</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">password_input</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s2">&quot;Sorry password must be at least six characters :-( &quot;</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>


<span class="k">def</span> <span class="nf">_confirm_password</span><span class="p">(</span><span class="n">password_input</span><span class="p">,</span> <span class="n">password_confirmation</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">password_confirmation</span> <span class="o">==</span> <span class="n">password_input</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s2">&quot;Sorry, values did not match&quot;</span>
        <span class="k">return</span> <span class="kc">False</span>


<span class="k">def</span> <span class="nf">_update_admin_password_file</span><span class="p">(</span><span class="n">updated_password</span><span class="p">):</span>
    <span class="c1">#TODO: Rename esgf_secret_file to esgf_admin_password_file</span>
    <span class="c1">#TODO: Move this to esg_functions as set_security_admin_password()</span>
    <span class="sd">&#39;&#39;&#39;Updates the esgf_secret_file&#39;&#39;&#39;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">security_admin_password_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;esgf_secret_file&quot;</span><span class="p">],</span> <span class="s1">&#39;w+&#39;</span><span class="p">)</span>
        <span class="n">security_admin_password_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">updated_password</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Unable to update security_admin_password file: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;esgf_secret_file&quot;</span><span class="p">])</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">security_admin_password_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">esg_functions</span><span class="o">.</span><span class="n">get_tomcat_group_id</span><span class="p">():</span>
        <span class="n">esg_functions</span><span class="o">.</span><span class="n">add_unix_group</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;tomcat_group&quot;</span><span class="p">])</span>
    <span class="n">tomcat_group_id</span> <span class="o">=</span> <span class="n">esg_functions</span><span class="o">.</span><span class="n">get_tomcat_group_id</span><span class="p">()</span>

    <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;esgf_secret_file&#39;</span><span class="p">],</span> <span class="mi">0640</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chown</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;esgf_secret_file&#39;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span>
                 <span class="s2">&quot;installer_uid&quot;</span><span class="p">],</span> <span class="n">tomcat_group_id</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Unable to change ownership of </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;esgf_secret_file&quot;</span><span class="p">])</span>

    <span class="c1"># Use the same password when creating the postgress account</span>
    <span class="n">config</span><span class="p">[</span><span class="s2">&quot;pg_sys_acct_passwd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">updated_password</span>
    <span class="n">_update_postgres_password</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">_update_postgres_password</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;Updates the Postgres system account password; gets saved to /esg/config/.esg_pg_pass&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">esg_functions</span><span class="o">.</span><span class="n">get_tomcat_group_id</span><span class="p">():</span>
        <span class="n">esg_functions</span><span class="o">.</span><span class="n">add_unix_group</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;tomcat_group&quot;</span><span class="p">])</span>
    <span class="n">tomcat_group_id</span> <span class="o">=</span> <span class="n">esg_functions</span><span class="o">.</span><span class="n">get_tomcat_group_id</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;pg_secret_file&#39;</span><span class="p">],</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">secret_file</span><span class="p">:</span>
            <span class="n">secret_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;pg_sys_acct_passwd&quot;</span><span class="p">])</span>
    <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Could not open </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;pg_secret_file&#39;</span><span class="p">])</span>

    <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;pg_secret_file&#39;</span><span class="p">],</span> <span class="mi">0640</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chown</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;pg_secret_file&#39;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span>
                 <span class="s2">&quot;installer_uid&quot;</span><span class="p">],</span> <span class="n">tomcat_group_id</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Unable to change ownership of </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;pg_secret_file&quot;</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">_choose_admin_password</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;Sets the ESGF password that is stored in /esg/config/.esgf_pass&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">esg_functions</span><span class="o">.</span><span class="n">get_security_admin_password</span><span class="p">():</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Previously set password found.&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">password_input</span> <span class="o">=</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getpass</span><span class="p">(</span>
            <span class="s2">&quot;What is the admin password to use for this installation? (alpha-numeric only): &quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">_is_valid_password</span><span class="p">(</span><span class="n">password_input</span><span class="p">):</span>
            <span class="k">continue</span>

        <span class="n">password_input_confirmation</span> <span class="o">=</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getpass</span><span class="p">(</span>
            <span class="s2">&quot;Please re-enter password to confirm: &quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">_confirm_password</span><span class="p">(</span><span class="n">password_input</span><span class="p">,</span> <span class="n">password_input_confirmation</span><span class="p">):</span>
            <span class="n">_update_admin_password_file</span><span class="p">(</span><span class="n">password_input</span><span class="p">)</span>
            <span class="k">break</span>


<span class="k">def</span> <span class="nf">_choose_organization_name</span><span class="p">():</span>
    <span class="n">esg_root_id</span> <span class="o">=</span> <span class="n">esg_property_manager</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s2">&quot;esg_root_id&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">esg_root_id</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;esg_root_id = [</span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="n">esg_root_id</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">elif</span> <span class="n">force_install</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">default_org_name</span> <span class="o">=</span> <span class="n">tld</span><span class="o">.</span><span class="n">get_tld</span><span class="p">(</span>
                <span class="s2">&quot;http://&quot;</span> <span class="o">+</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">(),</span> <span class="n">as_object</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">domain</span>
        <span class="k">except</span> <span class="n">tld</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">TldDomainNotFound</span><span class="p">,</span> <span class="n">error</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Could not find top level domain for </span><span class="si">%s</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">())</span>
            <span class="n">default_org_name</span> <span class="o">=</span> <span class="s2">&quot;llnl&quot;</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">org_name_input</span> <span class="o">=</span> <span class="n">raw_input</span><span class="p">(</span><span class="s2">&quot;What is the name of your organization? [</span><span class="si">{default_org_name}</span><span class="s2">]: &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">default_org_name</span><span class="o">=</span><span class="n">default_org_name</span><span class="p">))</span> <span class="ow">or</span> <span class="n">default_org_name</span>
            <span class="n">org_name_input</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
            <span class="n">esg_property_manager</span><span class="o">.</span><span class="n">write_as_property</span><span class="p">(</span><span class="s2">&quot;esg_root_id&quot;</span><span class="p">,</span> <span class="n">org_name_input</span><span class="p">)</span>
            <span class="k">break</span>

<span class="k">def</span> <span class="nf">_choose_node_short_name</span><span class="p">():</span>
    <span class="n">node_short_name</span> <span class="o">=</span> <span class="n">esg_property_manager</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s2">&quot;node_short_name&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">node_short_name</span> <span class="ow">or</span> <span class="n">force_install</span><span class="p">:</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">node_short_name_input</span> <span class="o">=</span> <span class="n">raw_input</span><span class="p">(</span><span class="s2">&quot;Please give this node a </span><span class="se">\&quot;</span><span class="s2">short</span><span class="se">\&quot;</span><span class="s2"> name [</span><span class="si">{node_short_name}</span><span class="s2">]: &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">node_short_name</span><span class="o">=</span><span class="n">node_short_name</span><span class="p">))</span> <span class="ow">or</span> <span class="n">node_short_name</span>
            <span class="n">node_short_name_input</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
            <span class="n">esg_property_manager</span><span class="o">.</span><span class="n">write_as_property</span><span class="p">(</span>
                <span class="s2">&quot;node_short_name&quot;</span><span class="p">,</span> <span class="n">node_short_name_input</span><span class="p">)</span>
            <span class="k">break</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;node_short_name = [</span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="n">node_short_name</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_choose_node_long_name</span><span class="p">():</span>
    <span class="n">node_long_name</span> <span class="o">=</span> <span class="n">esg_property_manager</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s2">&quot;node_long_name&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">node_long_name</span> <span class="ow">or</span> <span class="n">force_install</span><span class="p">:</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">node_long_name_input</span> <span class="o">=</span> <span class="n">raw_input</span><span class="p">(</span><span class="s2">&quot;Please give this node a more descriptive </span><span class="se">\&quot;</span><span class="s2">long</span><span class="se">\&quot;</span><span class="s2"> name [</span><span class="si">{node_long_name}</span><span class="s2">]: &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">node_long_name</span><span class="o">=</span><span class="n">node_long_name</span><span class="p">))</span> <span class="ow">or</span> <span class="n">node_long_name</span>
            <span class="n">esg_property_manager</span><span class="o">.</span><span class="n">write_as_property</span><span class="p">(</span>
                <span class="s2">&quot;node_long_name&quot;</span><span class="p">,</span> <span class="n">node_long_name_input</span><span class="p">)</span>
            <span class="k">break</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;node_long_name = [</span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="n">node_long_name</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_choose_node_namespace</span><span class="p">():</span>
    <span class="n">node_namespace</span> <span class="o">=</span> <span class="n">esg_property_manager</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s2">&quot;node_namespace&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">node_namespace</span> <span class="ow">or</span> <span class="n">force_install</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">top_level_domain</span> <span class="o">=</span> <span class="n">tld</span><span class="o">.</span><span class="n">get_tld</span><span class="p">(</span>
                <span class="s2">&quot;http://&quot;</span> <span class="o">+</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">(),</span> <span class="n">as_object</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">domain</span> <span class="o">=</span> <span class="n">top_level_domain</span><span class="o">.</span><span class="n">domain</span>
            <span class="n">suffix</span> <span class="o">=</span> <span class="n">top_level_domain</span><span class="o">.</span><span class="n">suffix</span>
            <span class="n">default_node_namespace</span> <span class="o">=</span> <span class="n">suffix</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">domain</span>
        <span class="k">except</span> <span class="n">tld</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">TldDomainNotFound</span><span class="p">,</span> <span class="n">error</span><span class="p">:</span>
            <span class="n">top_level_domain</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">default_node_namespace</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">node_namespace_input</span> <span class="o">=</span> <span class="n">raw_input</span><span class="p">(</span><span class="s2">&quot;What is the namespace to use for this node? (set to your reverse fqdn - Ex: </span><span class="se">\&quot;</span><span class="s2">gov.llnl</span><span class="se">\&quot;</span><span class="s2">) [</span><span class="si">{default_node_namespace}</span><span class="s2">]: &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">default_node_namespace</span><span class="o">=</span><span class="n">default_node_namespace</span><span class="p">))</span> <span class="ow">or</span> <span class="n">default_node_namespace</span>
            <span class="n">namespace_pattern_requirement</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;(\w+.</span><span class="si">{1}</span><span class="s2">\w+)$&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">namespace_pattern_requirement</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">node_namespace_input</span><span class="p">):</span>
                <span class="nb">print</span> <span class="s2">&quot;Namespace entered is not in a valid format.  Valid format is [suffix].[domain].  Example: gov.llnl&quot;</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">esg_property_manager</span><span class="o">.</span><span class="n">write_as_property</span><span class="p">(</span>
                    <span class="s2">&quot;node_namespace&quot;</span><span class="p">,</span> <span class="n">node_namespace_input</span><span class="p">)</span>
                <span class="k">break</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;node_namespace = [</span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="n">node_namespace</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_choose_node_peer_group</span><span class="p">():</span>
    <span class="n">node_peer_group</span> <span class="o">=</span> <span class="n">esg_property_manager</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s2">&quot;node_peer_group&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">node_peer_group</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;node_peer_group = [</span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="n">node_peer_group</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">node_peer_group</span> <span class="ow">or</span> <span class="n">force_install</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">node_peer_group</span>
        <span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
            <span class="n">node_peer_group</span> <span class="o">=</span> <span class="s2">&quot;esgf-dev&quot;</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;Only choose esgf-test for test federation install or esgf-prod for production installation.  Otherwise choose esgf-dev.&quot;</span>
            <span class="n">node_peer_group_input</span> <span class="o">=</span> <span class="n">raw_input</span><span class="p">(</span>
                <span class="s2">&quot;What peer group(s) will this node participate in? (esgf-test|esgf-prod|esgf-dev) [</span><span class="si">{node_peer_group}</span><span class="s2">]: &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">node_peer_group</span><span class="o">=</span><span class="n">node_peer_group</span><span class="p">))</span> <span class="ow">or</span> <span class="n">node_peer_group</span>
            <span class="k">if</span> <span class="n">node_peer_group_input</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;esgf-test&quot;</span><span class="p">,</span> <span class="s2">&quot;esgf-prod&quot;</span><span class="p">,</span> <span class="s2">&quot;esgf-dev&quot;</span><span class="p">]:</span>
                <span class="nb">print</span> <span class="s2">&quot;Invalid Selection: </span><span class="si">{node_peer_group_input}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">node_peer_group_input</span><span class="o">=</span><span class="n">node_peer_group_input</span><span class="p">)</span>
                <span class="nb">print</span> <span class="s2">&quot;Please choose either esgf-test, esgf-dev, or esgf-prod&quot;</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">esg_property_manager</span><span class="o">.</span><span class="n">write_as_property</span><span class="p">(</span>
                    <span class="s2">&quot;node_peer_group&quot;</span><span class="p">,</span> <span class="n">node_peer_group_input</span><span class="p">)</span>
                <span class="k">break</span>

<span class="k">def</span> <span class="nf">_choose_esgf_index_peer</span><span class="p">():</span>
    <span class="n">esgf_index_peer</span> <span class="o">=</span> <span class="n">esg_property_manager</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s2">&quot;esgf_index_peer&quot;</span><span class="p">)</span>
    <span class="n">esgf_default_peer</span> <span class="o">=</span> <span class="n">esg_property_manager</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s2">&quot;esgf_default_peer&quot;</span><span class="p">)</span>
    <span class="n">esgf_host</span> <span class="o">=</span> <span class="n">esg_property_manager</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s2">&quot;esgf_host&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">esgf_index_peer</span> <span class="ow">or</span> <span class="n">force_install</span><span class="p">:</span>
        <span class="n">default_esgf_index_peer</span> <span class="o">=</span> <span class="n">esgf_default_peer</span> <span class="ow">or</span> <span class="n">esgf_host</span> <span class="ow">or</span> <span class="n">socket</span><span class="o">.</span><span class="n">getfqdn</span><span class="p">()</span>
        <span class="n">esgf_index_peer_input</span> <span class="o">=</span> <span class="n">raw_input</span><span class="p">(</span><span class="s2">&quot;What is the hostname of the node do you plan to publish to? [</span><span class="si">{default_esgf_index_peer}</span><span class="s2">]: &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">default_esgf_index_peer</span><span class="o">=</span><span class="n">default_esgf_index_peer</span><span class="p">))</span> <span class="ow">or</span> <span class="n">default_esgf_index_peer</span>
        <span class="n">esg_property_manager</span><span class="o">.</span><span class="n">write_as_property</span><span class="p">(</span>
            <span class="s2">&quot;esgf_index_peer&quot;</span><span class="p">,</span> <span class="n">esgf_index_peer_input</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;esgf_index_peer = [</span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="n">esgf_index_peer</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_choose_mail_admin_address</span><span class="p">():</span>
    <span class="n">mail_admin_address</span> <span class="o">=</span> <span class="n">esg_property_manager</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s2">&quot;mail_admin_address&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">mail_admin_address</span> <span class="ow">or</span> <span class="n">force_install</span><span class="p">:</span>
        <span class="n">mail_admin_address_input</span> <span class="o">=</span> <span class="n">raw_input</span><span class="p">(</span>
            <span class="s2">&quot;What email address should notifications be sent as? [</span><span class="si">{mail_admin_address}</span><span class="s2">]: &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mail_admin_address</span><span class="o">=</span><span class="n">mail_admin_address</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">mail_admin_address_input</span><span class="p">:</span>
            <span class="n">esg_property_manager</span><span class="o">.</span><span class="n">write_as_property</span><span class="p">(</span>
                <span class="s2">&quot;mail_admin_address&quot;</span><span class="p">,</span> <span class="n">mail_admin_address_input</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot; (The notification system will not be enabled without an email address)&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;mail_admin_address = [</span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="n">mail_admin_address</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_choose_publisher_db_user</span><span class="p">():</span>
    <span class="n">default_publisher_db_user</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">publisher_db_user</span> <span class="o">=</span> <span class="n">esg_property_manager</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s2">&quot;publisher_db_user&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">publisher_db_user</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s2">&quot;Found existing value for property publisher_db_user: </span><span class="si">{publisher_db_user}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">publisher_db_user</span><span class="o">=</span><span class="n">publisher_db_user</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;publisher_db_user: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">publisher_db_user</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">publisher_db_user</span> <span class="ow">or</span> <span class="n">force_install</span><span class="p">:</span>
        <span class="n">default_publisher_db_user</span> <span class="o">=</span> <span class="n">publisher_db_user</span> <span class="ow">or</span> <span class="s2">&quot;esgcet&quot;</span>
        <span class="n">publisher_db_user_input</span> <span class="o">=</span> <span class="n">raw_input</span><span class="p">(</span>
            <span class="s2">&quot;What is the (low privilege) db account for publisher? [</span><span class="si">{default_publisher_db_user}</span><span class="s2">]: &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">default_publisher_db_user</span><span class="o">=</span><span class="n">default_publisher_db_user</span><span class="p">))</span> <span class="ow">or</span> <span class="n">default_publisher_db_user</span>
        <span class="n">esg_property_manager</span><span class="o">.</span><span class="n">write_as_property</span><span class="p">(</span>
            <span class="s2">&quot;publisher_db_user&quot;</span><span class="p">,</span> <span class="n">publisher_db_user_input</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_choose_publisher_db_user_passwd</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;publisher_db_user_passwd&quot;</span><span class="p">]:</span>
        <span class="nb">print</span> <span class="s2">&quot;Using previously configured publisher DB password&quot;</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;pub_secret_file&#39;</span><span class="p">]):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;pub_secret_file&#39;</span><span class="p">],</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">secret_file</span><span class="p">:</span>
            <span class="n">publisher_db_user_passwd</span> <span class="o">=</span> <span class="n">secret_file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="nb">print</span> <span class="s2">&quot;Found existing value for property publisher_db_user_passwd&quot;</span>
        <span class="k">return</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;publisher_db_user_passwd&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">force_install</span><span class="p">:</span>
        <span class="n">publisher_db_user</span> <span class="o">=</span> <span class="n">esg_property_manager</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s2">&quot;publisher_db_user&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;esgcet&quot;</span>
        <span class="n">publisher_db_user_passwd_input</span> <span class="o">=</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getpass</span><span class="p">(</span>
            <span class="s2">&quot;What is the db password for publisher user (</span><span class="si">{publisher_db_user}</span><span class="s2">)?: &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">publisher_db_user</span><span class="o">=</span><span class="n">publisher_db_user</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">publisher_db_user_passwd_input</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;pub_secret_file&#39;</span><span class="p">],</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">secret_file</span><span class="p">:</span>
                <span class="n">secret_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">publisher_db_user_passwd_input</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_db_properties</span><span class="p">():</span>
    <span class="n">db_properties_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;db_user&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;db_host&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                          <span class="s2">&quot;db_port&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;db_database&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;db_managed&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">db_properties_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">db_properties_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">esg_property_manager</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">db_properties_dict</span>

<span class="k">def</span> <span class="nf">initial_setup_questionnaire</span><span class="p">():</span>
    <span class="nb">print</span> <span class="s2">&quot;-------------------------------------------------------&quot;</span>
    <span class="nb">print</span> <span class="s1">&#39;Welcome to the ESGF Node installation program! :-)&#39;</span>
    <span class="nb">print</span> <span class="s2">&quot;-------------------------------------------------------&quot;</span>

    <span class="n">esg_bash2py</span><span class="o">.</span><span class="n">mkdir_p</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;esg_config_dir&#39;</span><span class="p">])</span>

    <span class="n">starting_directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>

    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;esg_config_dir&#39;</span><span class="p">])</span>

    <span class="n">esgf_host</span> <span class="o">=</span> <span class="n">esg_property_manager</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s2">&quot;esgf_host&quot;</span><span class="p">)</span>
    <span class="n">_choose_fqdn</span><span class="p">(</span><span class="n">esgf_host</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">esg_functions</span><span class="o">.</span><span class="n">get_security_admin_password</span><span class="p">()</span> <span class="ow">or</span> <span class="n">force_install</span><span class="p">:</span>
        <span class="n">_choose_admin_password</span><span class="p">()</span>

    <span class="n">_choose_organization_name</span><span class="p">()</span>
    <span class="n">_choose_node_short_name</span><span class="p">()</span>
    <span class="n">_choose_node_long_name</span><span class="p">()</span>
    <span class="n">_choose_node_namespace</span><span class="p">()</span>
    <span class="n">_choose_node_peer_group</span><span class="p">()</span>
    <span class="n">_choose_esgf_index_peer</span><span class="p">()</span>
    <span class="n">_choose_mail_admin_address</span><span class="p">()</span>

    <span class="c1">#TODO:Extract constructring DB string into separate function</span>
    <span class="n">db_properties</span> <span class="o">=</span> <span class="n">get_db_properties</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">db_properties</span><span class="p">)</span> <span class="ow">or</span> <span class="n">force_install</span><span class="p">:</span>
        <span class="n">_is_managed_db</span><span class="p">(</span><span class="n">db_properties</span><span class="p">)</span>
        <span class="n">_get_db_conn_str_questionnaire</span><span class="p">(</span><span class="n">db_properties</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">db_properties</span><span class="p">[</span><span class="s2">&quot;db_host&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">esgf_host</span> <span class="ow">or</span> <span class="n">db_properties</span><span class="p">[</span><span class="s2">&quot;db_host&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;localhost&quot;</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;db_connection_string = </span><span class="si">{db_user}</span><span class="s2">@localhost&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">db_user</span><span class="o">=</span><span class="n">db_properties</span><span class="p">[</span><span class="s2">&quot;db_user&quot;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">connstring_</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{db_user}</span><span class="s2">@</span><span class="si">{db_host}</span><span class="s2">:</span><span class="si">{db_port}</span><span class="s2">/</span><span class="si">{db_database}</span><span class="s2"> [external = $</span><span class="si">{db_managed}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">db_user</span><span class="o">=</span><span class="n">db_properties</span><span class="p">[</span><span class="s2">&quot;db_user&quot;</span><span class="p">],</span>
                                                                                                          <span class="n">db_host</span><span class="o">=</span><span class="n">db_properties</span><span class="p">[</span>
                                                                                                              <span class="s2">&quot;db_host&quot;</span><span class="p">],</span>
                                                                                                          <span class="n">db_port</span><span class="o">=</span><span class="n">db_properties</span><span class="p">[</span>
                                                                                                              <span class="s2">&quot;db_port&quot;</span><span class="p">],</span>
                                                                                                          <span class="n">db_database</span><span class="o">=</span><span class="n">db_properties</span><span class="p">[</span>
                                                                                                              <span class="s2">&quot;db_database&quot;</span><span class="p">],</span>
                                                                                                          <span class="n">db_managed</span><span class="o">=</span><span class="n">db_properties</span><span class="p">[</span><span class="s2">&quot;db_managed&quot;</span><span class="p">])</span>

    <span class="n">_choose_publisher_db_user</span><span class="p">()</span>
    <span class="n">_choose_publisher_db_user_passwd</span><span class="p">()</span>

    <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;pub_secret_file&#39;</span><span class="p">],</span> <span class="mi">0640</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;tomcat&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">esg_functions</span><span class="o">.</span><span class="n">get_group_list</span><span class="p">():</span>
        <span class="n">esg_functions</span><span class="o">.</span><span class="n">add_unix_group</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;tomcat_group&quot;</span><span class="p">])</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chown</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;esgf_secret_file&#39;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span>
             <span class="s2">&quot;installer_uid&quot;</span><span class="p">],</span> <span class="n">esg_functions</span><span class="o">.</span><span class="n">get_tomcat_group_id</span><span class="p">())</span>

    <span class="k">if</span> <span class="n">db_properties</span><span class="p">[</span><span class="s2">&quot;db_host&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">esgf_host</span> <span class="ow">or</span> <span class="n">db_properties</span><span class="p">[</span><span class="s2">&quot;db_host&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;localhost&quot;</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;db publisher connection string </span><span class="si">%s</span><span class="s2">@localhost&quot;</span><span class="p">,</span>
                    <span class="n">db_properties</span><span class="p">[</span><span class="s2">&quot;db_user&quot;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;db publisher connection string </span><span class="si">%s</span><span class="s2">@</span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">db_properties</span><span class="p">[</span><span class="s2">&quot;db_user&quot;</span><span class="p">],</span> <span class="n">db_properties</span><span class="p">[</span><span class="s2">&quot;db_host&quot;</span><span class="p">],</span> <span class="n">db_properties</span><span class="p">[</span><span class="s2">&quot;db_port&quot;</span><span class="p">],</span> <span class="n">db_properties</span><span class="p">[</span><span class="s2">&quot;db_database&quot;</span><span class="p">])</span>

    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">starting_directory</span><span class="p">)</span>

    <span class="k">return</span> <span class="kc">True</span>


<span class="k">def</span> <span class="nf">_get_db_conn_str_questionnaire</span><span class="p">(</span><span class="n">db_properties</span><span class="p">):</span>
    <span class="c1"># postgresql://esgcet@localhost:5432/esgcet</span>
    <span class="n">user_</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">host_</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">port_</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">dbname_</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">connstring_</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">valid_connection_string</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Note the values referenced here should have been set by prior get_property *** calls</span>
    <span class="c1"># that sets these values in the script scope. (see the call in</span>
    <span class="c1"># questionnaire function - above)</span>
    <span class="n">esgf_host</span> <span class="o">=</span> <span class="n">esg_property_manager</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s2">&quot;esgf_host&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">db_properties</span><span class="p">[</span><span class="s2">&quot;db_user&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">db_properties</span><span class="p">[</span><span class="s2">&quot;db_host&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">db_properties</span><span class="p">[</span><span class="s2">&quot;db_port&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">db_properties</span><span class="p">[</span><span class="s2">&quot;db_database&quot;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">db_properties</span><span class="p">[</span><span class="s2">&quot;db_host&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">db_properties</span><span class="p">[</span><span class="s2">&quot;db_host&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">esgf_host</span> <span class="ow">or</span> <span class="n">db_properties</span><span class="p">[</span><span class="s2">&quot;db_host&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;localhost&quot;</span><span class="p">:</span>
                <span class="n">connstring_</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{db_user}</span><span class="s2">@localhost&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">connstring_</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{db_user}</span><span class="s2">@</span><span class="si">{db_host}</span><span class="s2">:</span><span class="si">{db_port}</span><span class="s2">/</span><span class="si">{db_database}</span><span class="s2">&quot;</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s2">&quot;Please enter the database connection string...&quot;</span>
        <span class="nb">print</span> <span class="s2">&quot; (form: postgresql://[username]@[host]:[port]/esgcet)&quot;</span>
        <span class="n">db_managed</span> <span class="o">=</span> <span class="n">esg_property_manager</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s2">&quot;db_managed&quot;</span><span class="p">)</span>
        <span class="c1">#(if it is a not a force install and we are using a LOCAL (NOT MANAGED) database then db_managed == &quot;no&quot;)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">connstring_</span> <span class="ow">and</span> <span class="n">db_managed</span> <span class="o">!=</span> <span class="s2">&quot;yes&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force_install</span><span class="p">:</span>
            <span class="n">connstring_</span> <span class="o">=</span> <span class="s2">&quot;dbsuper@localhost:5432/esgcet&quot;</span>
        <span class="n">db_connection_input</span> <span class="o">=</span> <span class="n">raw_input</span><span class="p">(</span>
            <span class="s2">&quot;What is the database connection string? [postgresql://$</span><span class="si">{connstring_}</span><span class="s2">]: postgresql://&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">connstring_</span><span class="o">=</span><span class="n">connstring_</span><span class="p">))</span> <span class="ow">or</span> <span class="n">connstring_</span>
        <span class="n">parsed_db_conn_string</span> <span class="o">=</span> <span class="n">urlparse</span><span class="o">.</span><span class="n">urlparse</span><span class="p">(</span><span class="n">db_connection_input</span><span class="p">)</span>
        <span class="c1"># result.path[1:] is database name</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">parsed_db_conn_string</span><span class="o">.</span><span class="n">username</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">parsed_db_conn_string</span><span class="o">.</span><span class="n">hostname</span> <span class="ow">or</span> <span class="n">parsed_db_conn_string</span><span class="o">.</span><span class="n">port</span> <span class="ow">or</span> <span class="n">parsed_db_conn_string</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;ERROR: Incorrect connection string syntax or values&quot;</span><span class="p">)</span>
            <span class="n">valid_connection_string</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">valid_connection_string</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">break</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;user = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">user_</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;host = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">host_</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;port = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">port_</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;database = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">dbname_</span><span class="p">)</span>

    <span class="c1"># write vars to property file</span>
    <span class="n">esg_property_manager</span><span class="o">.</span><span class="n">write_as_property</span><span class="p">(</span><span class="s2">&quot;db_user&quot;</span><span class="p">,</span> <span class="n">user_</span><span class="p">)</span>
    <span class="n">esg_property_manager</span><span class="o">.</span><span class="n">write_as_property</span><span class="p">(</span><span class="s2">&quot;db_host&quot;</span><span class="p">,</span> <span class="n">host_</span><span class="p">)</span>
    <span class="n">esg_property_manager</span><span class="o">.</span><span class="n">write_as_property</span><span class="p">(</span><span class="s2">&quot;db_port&quot;</span><span class="p">,</span> <span class="n">port_</span><span class="p">)</span>
    <span class="n">esg_property_manager</span><span class="o">.</span><span class="n">write_as_property</span><span class="p">(</span><span class="s2">&quot;db_database&quot;</span><span class="p">,</span> <span class="n">dbname_</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;valid_connection_string: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>  <span class="n">valid_connection_string</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">valid_connection_string</span>


<span class="k">def</span> <span class="nf">_is_managed_db</span><span class="p">(</span><span class="n">db_properties</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        responds true (returns 0) if this IS intended to be a managed database</span>
<span class="sd">        is expecting the vars:</span>
<span class="sd">        ---- &quot;db_host&quot;</span>
<span class="sd">        ---- &quot;esgf_host&quot;</span>
<span class="sd">        to be set</span>
<span class="sd">        Define: managed - (true|0) this means NOT manipulated by this script but done by external means</span>
<span class="sd">        (hint prepend &quot;externally&quot; before managed to get the meaning - yes I find it confusing but Stephen likes this term :-))</span>
<span class="sd">        db_managed=no means that it is a LOCAL database. (I have to change this damn verbiage... what I get for following pasco-speak ;-).</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">db_managed_default</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">default_selection_output</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">db_managed</span> <span class="o">=</span> <span class="n">esg_property_manager</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s2">&quot;db_managed&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">force_install</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">db_managed</span> <span class="o">==</span> <span class="s2">&quot;yes&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">db_managed</span><span class="p">:</span>
        <span class="n">esgf_host</span> <span class="o">=</span> <span class="n">esg_property_manager</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s2">&quot;esgf_host&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;esgf_host = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">esgf_host</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;db_host = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">db_properties</span><span class="p">[</span><span class="s2">&quot;db_host&quot;</span><span class="p">])</span>

        <span class="c1"># Try to come up with some &quot;sensible&quot; default value for the user...</span>
        <span class="k">if</span> <span class="n">db_properties</span><span class="p">[</span><span class="s2">&quot;db_host&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">esgf_host</span> <span class="ow">or</span> <span class="n">db_properties</span><span class="p">[</span><span class="s2">&quot;db_host&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;localhost&quot;</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">db_properties</span><span class="p">[</span><span class="s2">&quot;db_host&quot;</span><span class="p">]:</span>
            <span class="n">db_managed_default</span> <span class="o">=</span> <span class="s2">&quot;no&quot;</span>
            <span class="n">default_selection_output</span> <span class="o">=</span> <span class="s2">&quot;[y/N]:&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">db_managed_default</span> <span class="o">=</span> <span class="s2">&quot;yes&quot;</span>
            <span class="n">default_selection_output</span> <span class="o">=</span> <span class="s2">&quot;[Y/n]:&quot;</span>

        <span class="n">external_db_input</span> <span class="o">=</span> <span class="n">raw_input</span><span class="p">(</span>
            <span class="s2">&quot;Is the database external to this node? &quot;</span> <span class="o">+</span> <span class="n">default_selection_output</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">external_db_input</span><span class="p">:</span>
            <span class="n">db_managed</span> <span class="o">=</span> <span class="n">db_managed_default</span>
            <span class="n">esg_property_manager</span><span class="o">.</span><span class="n">write_as_property</span><span class="p">(</span><span class="s2">&quot;db_managed&quot;</span><span class="p">,</span> <span class="n">db_managed</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">external_db_input</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;y&quot;</span> <span class="ow">or</span> <span class="n">external_db_input</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;yes&quot;</span><span class="p">:</span>
                <span class="n">db_managed</span> <span class="o">==</span> <span class="s2">&quot;yes&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">db_managed</span> <span class="o">==</span> <span class="s2">&quot;no&quot;</span>
            <span class="n">esg_property_manager</span><span class="o">.</span><span class="n">write_as_property</span><span class="p">(</span><span class="s2">&quot;db_managed&quot;</span><span class="p">,</span> <span class="n">db_managed</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;db_managed = [</span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="n">db_managed</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">db_managed</span> <span class="o">==</span> <span class="s2">&quot;yes&quot;</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s2">&quot;Set to use externally </span><span class="se">\&quot;</span><span class="s2">managed</span><span class="se">\&quot;</span><span class="s2"> database on host: </span><span class="si">{db_host}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">db_host</span><span class="o">=</span><span class="n">db_properties</span><span class="p">[</span><span class="s2">&quot;db_host&quot;</span><span class="p">])</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;(hmm... setting db_host to localhost)&quot;</span><span class="p">)</span>
        <span class="c1"># Note: if not managed and on the local machine... always use</span>
        <span class="c1"># &quot;localhost&quot;</span>
        <span class="n">db_properties</span><span class="p">[</span><span class="s2">&quot;db_host&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;localhost&quot;</span>
        <span class="k">return</span> <span class="kc">False</span>


<div class="viewcode-block" id="install_prerequisites"><a class="viewcode-back" href="../index.html#esg_setup.install_prerequisites">[docs]</a><span class="k">def</span> <span class="nf">install_prerequisites</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Install prerequisite modules via yum</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="nb">print</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">    *******************************</span>
<span class="s1">    Installing prerequisites from yum</span>
<span class="s1">    *******************************</span>
<span class="s1">    &#39;&#39;&#39;</span>
    <span class="n">yum_remove_rpm_forge</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span>
        <span class="p">[</span><span class="s2">&quot;yum&quot;</span><span class="p">,</span> <span class="s2">&quot;-y&quot;</span><span class="p">,</span> <span class="s2">&quot;remove&quot;</span><span class="p">,</span> <span class="s2">&quot;rpmforge-release&quot;</span><span class="p">],</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
    <span class="n">esg_functions</span><span class="o">.</span><span class="n">stream_subprocess_output</span><span class="p">(</span><span class="n">yum_remove_rpm_forge</span><span class="p">)</span>

    <span class="n">yum_install_epel</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span>
        <span class="p">[</span><span class="s2">&quot;yum&quot;</span><span class="p">,</span> <span class="s2">&quot;-y&quot;</span><span class="p">,</span> <span class="s2">&quot;install&quot;</span><span class="p">,</span> <span class="s2">&quot;epel-release&quot;</span><span class="p">],</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
    <span class="n">esg_functions</span><span class="o">.</span><span class="n">stream_subprocess_output</span><span class="p">(</span><span class="n">yum_install_epel</span><span class="p">)</span>

    <span class="n">yum_install_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;yum&quot;</span><span class="p">,</span> <span class="s2">&quot;-y&quot;</span><span class="p">,</span> <span class="s2">&quot;install&quot;</span><span class="p">,</span> <span class="s2">&quot;yum-plugin-priorities&quot;</span><span class="p">,</span> <span class="s2">&quot;sqlite-devel&quot;</span><span class="p">,</span> <span class="s2">&quot;freetype-devel&quot;</span><span class="p">,</span> <span class="s2">&quot;git&quot;</span><span class="p">,</span> <span class="s2">&quot;curl-devel&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;autoconf&quot;</span><span class="p">,</span> <span class="s2">&quot;automake&quot;</span><span class="p">,</span> <span class="s2">&quot;bison&quot;</span><span class="p">,</span> <span class="s2">&quot;file&quot;</span><span class="p">,</span> <span class="s2">&quot;flex&quot;</span><span class="p">,</span> <span class="s2">&quot;gcc&quot;</span><span class="p">,</span> <span class="s2">&quot;gcc-c++&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;gettext-devel&quot;</span><span class="p">,</span> <span class="s2">&quot;libtool&quot;</span><span class="p">,</span> <span class="s2">&quot;uuid-devel&quot;</span><span class="p">,</span> <span class="s2">&quot;libuuid-devel&quot;</span><span class="p">,</span> <span class="s2">&quot;libxml2&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;libxml2-devel&quot;</span><span class="p">,</span> <span class="s2">&quot;libxslt&quot;</span><span class="p">,</span> <span class="s2">&quot;libxslt-devel&quot;</span><span class="p">,</span> <span class="s2">&quot;lsof&quot;</span><span class="p">,</span> <span class="s2">&quot;make&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;openssl-devel&quot;</span><span class="p">,</span> <span class="s2">&quot;pam-devel&quot;</span><span class="p">,</span> <span class="s2">&quot;pax&quot;</span><span class="p">,</span> <span class="s2">&quot;readline-devel&quot;</span><span class="p">,</span> <span class="s2">&quot;tk-devel&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;wget&quot;</span><span class="p">,</span> <span class="s2">&quot;zlib-devel&quot;</span><span class="p">,</span> <span class="s2">&quot;perl-Archive-Tar&quot;</span><span class="p">,</span> <span class="s2">&quot;perl-XML-Parser&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;libX11-devel&quot;</span><span class="p">,</span> <span class="s2">&quot;libtool-ltdl-devel&quot;</span><span class="p">,</span> <span class="s2">&quot;e2fsprogs-devel&quot;</span><span class="p">,</span> <span class="s2">&quot;gcc-gfortran&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;libicu-devel&quot;</span><span class="p">,</span> <span class="s2">&quot;libgtextutils-devel&quot;</span><span class="p">,</span> <span class="s2">&quot;httpd,&quot;&quot; httpd-devel&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;mod_ssl&quot;</span><span class="p">,</span> <span class="s2">&quot;libjpeg-turbo-devel&quot;</span><span class="p">,</span> <span class="s2">&quot;myproxy&quot;</span><span class="p">,</span> <span class="s1">&#39;*ExtUtils*&#39;</span><span class="p">]</span>

    <span class="n">esg_functions</span><span class="o">.</span><span class="n">stream_subprocess_output</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">yum_install_list</span><span class="p">))</span></div>

<span class="k">def</span> <span class="nf">set_default_java</span><span class="p">():</span>
    <span class="c1"># default_java_version_info = esg_functions.call_subprocess(&quot;java -version&quot;)[&quot;stderr&quot;]</span>
    <span class="c1"># default_java_version_number = re.search(&quot;1.8.0_\w+&quot;, default_java_version_info).group()</span>
    <span class="c1"># if semver.compare(default_java_version_number, config[&quot;java_version&quot;]) != 0:</span>
    <span class="n">esg_functions</span><span class="o">.</span><span class="n">stream_subprocess_output</span><span class="p">(</span><span class="s2">&quot;alternatives --install /usr/bin/java java /usr/local/java/bin/java 3&quot;</span><span class="p">)</span>
    <span class="n">esg_functions</span><span class="o">.</span><span class="n">stream_subprocess_output</span><span class="p">(</span><span class="s2">&quot;alternatives --set java /usr/local/java/bin/java&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="check_for_existing_java"><a class="viewcode-back" href="../index.html#esg_setup.check_for_existing_java">[docs]</a><span class="k">def</span> <span class="nf">check_for_existing_java</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;Check if a valid java installation is currently on the system&#39;&#39;&#39;</span>
    <span class="n">java_path</span> <span class="o">=</span> <span class="n">find_executable</span><span class="p">(</span><span class="s2">&quot;java&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;java_install_dir&quot;</span><span class="p">],</span><span class="s2">&quot;bin&quot;</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">java_path</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s2">&quot;Detected an existing java installation at </span><span class="si">{java_path}</span><span class="s2">...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">java_path</span><span class="o">=</span><span class="n">java_path</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">check_java_version</span><span class="p">(</span><span class="n">java_path</span><span class="p">)</span></div>

<span class="k">def</span> <span class="nf">check_java_version</span><span class="p">(</span><span class="n">java_path</span><span class="p">):</span>
    <span class="nb">print</span> <span class="s2">&quot;Checking Java version&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">java_version_output</span> <span class="o">=</span> <span class="n">esg_functions</span><span class="o">.</span><span class="n">call_subprocess</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{java_path}</span><span class="s2"> -version&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">java_path</span><span class="o">=</span><span class="n">java_path</span><span class="p">))[</span><span class="s2">&quot;stderr&quot;</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Could not check the Java version&quot;</span><span class="p">)</span>
        <span class="n">esg_functions</span><span class="o">.</span><span class="n">exit_with_error</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">installed_java_version</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;1.8.0_\w+&quot;</span><span class="p">,</span> <span class="n">java_version_output</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">esg_version_manager</span><span class="o">.</span><span class="n">compare_versions</span><span class="p">(</span><span class="n">installed_java_version</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;java_version&quot;</span><span class="p">]):</span>
        <span class="nb">print</span> <span class="s2">&quot;Installed java version meets the minimum requirement &quot;</span>
    <span class="k">return</span> <span class="n">java_version_output</span>

<span class="k">def</span> <span class="nf">download_java</span><span class="p">(</span><span class="n">java_tarfile</span><span class="p">):</span>
    <span class="nb">print</span> <span class="s2">&quot;Downloading Java from &quot;</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;java_dist_url&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">esg_functions</span><span class="o">.</span><span class="n">download_update</span><span class="p">(</span><span class="n">java_tarfile</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;java_dist_url&quot;</span><span class="p">],</span> <span class="n">force_install</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;ERROR: Could not download Java&quot;</span><span class="p">)</span>
        <span class="n">esg_functions</span><span class="o">.</span><span class="n">exit_with_error</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<div class="viewcode-block" id="setup_java"><a class="viewcode-back" href="../index.html#esg_setup.setup_java">[docs]</a><span class="k">def</span> <span class="nf">setup_java</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Installs Oracle Java from rpm using yum localinstall.  Does nothing if an acceptible Java install is found.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="nb">print</span> <span class="s2">&quot;*******************************&quot;</span>
    <span class="nb">print</span> <span class="s2">&quot;Setting up Java </span><span class="si">{java_version}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">java_version</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;java_version&quot;</span><span class="p">])</span>
    <span class="nb">print</span> <span class="s2">&quot;******************************* </span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="k">if</span> <span class="n">force_install</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">if</span> <span class="n">check_for_existing_java</span><span class="p">():</span>
            <span class="n">setup_java_answer</span> <span class="o">=</span> <span class="n">raw_input</span><span class="p">(</span><span class="s2">&quot;Do you want to continue with Java installation and setup? [y/N]: &quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;N&quot;</span>
            <span class="k">if</span> <span class="n">setup_java_answer</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;yes&quot;</span><span class="p">]:</span>
                <span class="nb">print</span> <span class="s2">&quot;Skipping Java installation&quot;</span>
                <span class="k">return</span>
            <span class="n">last_java_truststore_file</span> <span class="o">=</span> <span class="n">esg_functions</span><span class="o">.</span><span class="n">readlinkf</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;truststore_file&quot;</span><span class="p">])</span>

    <span class="n">esg_bash2py</span><span class="o">.</span><span class="n">mkdir_p</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;workdir&quot;</span><span class="p">])</span>
    <span class="k">with</span> <span class="n">esg_bash2py</span><span class="o">.</span><span class="n">pushd</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;workdir&quot;</span><span class="p">]):</span>

        <span class="n">java_tarfile</span> <span class="o">=</span> <span class="n">esg_bash2py</span><span class="o">.</span><span class="n">trim_string_from_head</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;java_dist_url&quot;</span><span class="p">])</span>
        <span class="n">jdk_directory</span> <span class="o">=</span> <span class="n">java_tarfile</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">java_install_dir_parent</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;java_install_dir&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1">#Check for Java tar file</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">java_tarfile</span><span class="p">):</span>
            <span class="nb">print</span> <span class="s2">&quot;Don&#39;t see java distribution file </span><span class="si">{java_dist_file_path}</span><span class="s2"> either&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">java_dist_file_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span><span class="n">java_tarfile</span><span class="p">))</span>
            <span class="n">download_java</span><span class="p">(</span><span class="n">java_tarfile</span><span class="p">)</span>

        <span class="nb">print</span> <span class="s2">&quot;Extracting Java tarfile&quot;</span><span class="p">,</span> <span class="n">java_tarfile</span>
        <span class="n">esg_functions</span><span class="o">.</span><span class="n">extract_tarball</span><span class="p">(</span><span class="n">java_tarfile</span><span class="p">,</span> <span class="n">java_install_dir_parent</span><span class="p">)</span>

        <span class="c1">#Create symlink to Java install directory (/usr/local/java)</span>
        <span class="n">esg_bash2py</span><span class="o">.</span><span class="n">symlink_force</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">java_install_dir_parent</span><span class="p">,</span> <span class="n">jdk_directory</span><span class="p">),</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;java_install_dir&quot;</span><span class="p">])</span>

        <span class="n">os</span><span class="o">.</span><span class="n">chown</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;java_install_dir&quot;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;installer_uid&quot;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;installer_gid&quot;</span><span class="p">])</span>
        <span class="c1">#recursively change permissions</span>
        <span class="n">esg_functions</span><span class="o">.</span><span class="n">change_permissions_recursive</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;java_install_dir&quot;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;installer_uid&quot;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;installer_gid&quot;</span><span class="p">])</span>

    <span class="n">set_default_java</span><span class="p">()</span>
    <span class="nb">print</span> <span class="n">check_java_version</span><span class="p">(</span><span class="s2">&quot;java&quot;</span><span class="p">)</span></div>
    <span class="c1"># print check_java_version(&quot;{java_install_dir}/bin/java&quot;.format(java_install_dir=config[&quot;java_install_dir&quot;]))</span>

<div class="viewcode-block" id="setup_ant"><a class="viewcode-back" href="../index.html#esg_setup.setup_ant">[docs]</a><span class="k">def</span> <span class="nf">setup_ant</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Install ant via yum.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="nb">print</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">*******************************&quot;</span>
    <span class="nb">print</span> <span class="s2">&quot;Setting up Ant&quot;</span>
    <span class="nb">print</span> <span class="s2">&quot;******************************* </span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;/usr&quot;</span><span class="p">,</span> <span class="s2">&quot;bin&quot;</span><span class="p">,</span> <span class="s2">&quot;ant&quot;</span><span class="p">)):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Found existing Ant installation.  Skipping set up.&quot;</span><span class="p">)</span>
        <span class="n">esg_functions</span><span class="o">.</span><span class="n">stream_subprocess_output</span><span class="p">(</span><span class="s2">&quot;ant -version&quot;</span><span class="p">)</span>
        <span class="n">force_ant_install</span> <span class="o">=</span> <span class="n">raw_input</span><span class="p">(</span><span class="s2">&quot;Do you want to continue with the Ant installation [y/N]: &quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;no&quot;</span>
        <span class="k">if</span> <span class="n">force_ant_install</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">,</span> <span class="s2">&quot;no&quot;</span><span class="p">]:</span>
            <span class="k">return</span>

    <span class="n">esg_functions</span><span class="o">.</span><span class="n">stream_subprocess_output</span><span class="p">(</span><span class="s2">&quot;yum -y install ant&quot;</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">download_conda</span><span class="p">(</span><span class="n">CDAT_HOME</span><span class="o">=</span><span class="s2">&quot;/usr/local/conda&quot;</span><span class="p">):</span>
    <span class="nb">print</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">*******************************&quot;</span>
    <span class="nb">print</span> <span class="s2">&quot;Downloading Miniconda&quot;</span>
    <span class="nb">print</span> <span class="s2">&quot;******************************* </span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="k">with</span> <span class="n">esg_bash2py</span><span class="o">.</span><span class="n">pushd</span><span class="p">(</span><span class="s2">&quot;/tmp&quot;</span><span class="p">):</span>
        <span class="n">conda_url</span> <span class="o">=</span> <span class="s2">&quot;https://repo.continuum.io/miniconda/Miniconda2-latest-Linux-x86_64.sh&quot;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">conda_url</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;/tmp/Miniconda2-latest-Linux-x86_64.sh&#39;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">total_length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content-length&#39;</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">progress</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">iter_content</span><span class="p">(</span><span class="n">chunk_size</span><span class="o">=</span><span class="mi">1024</span><span class="p">),</span> <span class="n">expected_size</span><span class="o">=</span><span class="p">(</span><span class="n">total_length</span><span class="o">/</span><span class="mi">1024</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">chunk</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">install_conda</span><span class="p">(</span><span class="n">CDAT_HOME</span><span class="p">)</span>
        <span class="n">create_conda_env</span><span class="p">(</span><span class="n">CDAT_HOME</span><span class="o">=</span><span class="n">CDAT_HOME</span><span class="p">)</span>



<span class="k">def</span> <span class="nf">install_conda</span><span class="p">(</span><span class="n">CDAT_HOME</span><span class="o">=</span><span class="s2">&quot;/usr/local/conda&quot;</span><span class="p">):</span>
    <span class="n">esg_functions</span><span class="o">.</span><span class="n">stream_subprocess_output</span><span class="p">(</span><span class="s2">&quot;bash Miniconda2-latest-Linux-x86_64.sh -b -p </span><span class="si">{CDAT_HOME}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">CDAT_HOME</span><span class="o">=</span><span class="n">CDAT_HOME</span><span class="p">))</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">CDAT_HOME</span><span class="p">,</span> <span class="s2">&quot;bin&quot;</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">create_conda_env</span><span class="p">(</span><span class="n">CDAT_HOME</span><span class="o">=</span><span class="s2">&quot;/usr/local/conda&quot;</span><span class="p">):</span>
    <span class="n">esg_functions</span><span class="o">.</span><span class="n">stream_subprocess_output</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{CDAT_HOME}</span><span class="s2">/bin/conda create -y -n esgf-pub -c conda-forge -c uvcdat cdutil&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">CDAT_HOME</span><span class="o">=</span><span class="n">CDAT_HOME</span><span class="p">))</span>
    <span class="c1">#Test by trying to import cdms2</span>
    <span class="c1">#Absolutely needs to be in a conda env</span>
    <span class="c1">#Have bash script to activate conda then kick off installation</span>
    <span class="c1">#Ask Sasha what all he needs from uvcdat for Publisher</span>

<span class="k">def</span> <span class="nf">setup_cdat</span><span class="p">():</span>
    <span class="nb">print</span> <span class="s2">&quot;Checking for *UV* CDAT (Python+CDMS) </span><span class="si">{cdat_version}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cdat_version</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;cdat_version&quot;</span><span class="p">])</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;cdat_home&quot;</span><span class="p">],</span> <span class="s2">&quot;bin&quot;</span><span class="p">,</span> <span class="s2">&quot;python&quot;</span><span class="p">))</span>
        <span class="kn">import</span> <span class="nn">cdat_info</span>
        <span class="kn">import</span> <span class="nn">cdms2</span>
        <span class="c1">#if semver.match(cdat_info.Version, &quot;&gt;=&quot;+config[&quot;cdat_version&quot;])</span>
        <span class="k">if</span> <span class="n">esg_version_manager</span><span class="o">.</span><span class="n">check_version_atleast</span><span class="p">(</span><span class="n">cdat_info</span><span class="o">.</span><span class="n">Version</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;cdat_version&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force_install</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;CDAT already installed [OK]&quot;</span>
            <span class="k">return</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Unable to import cdms2&quot;</span><span class="p">)</span>

    <span class="nb">print</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">*******************************&quot;</span>
    <span class="nb">print</span> <span class="s2">&quot;Setting up CDAT - (Python + CDMS)... </span><span class="si">{cdat_version}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cdat_version</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;cdat_version&quot;</span><span class="p">])</span>
    <span class="nb">print</span> <span class="s2">&quot;******************************* </span><span class="se">\n</span><span class="s2">&quot;</span>


    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;cdat_home&quot;</span><span class="p">],</span> <span class="s2">&quot;bin&quot;</span><span class="p">,</span> <span class="s2">&quot;uvcdat&quot;</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">X_OK</span><span class="p">):</span>
        <span class="nb">print</span> <span class="s2">&quot;Detected an existing CDAT installation...&quot;</span>
        <span class="n">cdat_setup_choice</span> <span class="o">=</span> <span class="n">raw_input</span><span class="p">(</span>
            <span class="s2">&quot;Do you want to continue with CDAT installation and setup? [y/N] &quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cdat_setup_choice</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;yes&quot;</span><span class="p">]:</span>
            <span class="nb">print</span> <span class="s2">&quot;Skipping CDAT installation and setup - will assume CDAT is setup properly&quot;</span>
            <span class="k">return</span> <span class="kc">True</span>

    <span class="k">return</span> <span class="kc">True</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, William Hill.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.5.6</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
    </div>

    

    
  </body>
</html>